<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£Ÿè­œç®¡å®¶ | Cloud Sync</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>

    <style>
        /* --- Design Tokens --- */
        :root {
            --bg-morandi: #F2EAE4; --text-primary: #5E5451; --text-secondary: #8C8380;
            --accent-pink: #D48A96; --danger: #C47070; --success: #789c79;
            --neu-light: #FFFFFF; --neu-dark: #D3C6BC;
            --shadow-flat: 10px 10px 20px var(--neu-dark), -10px -10px 20px var(--neu-light);
            --shadow-pressed: inset 6px 6px 12px var(--neu-dark), inset -6px -6px 12px var(--neu-light);
            --radius-xl: 28px; --radius-pill: 50px;
            --font-main: 'Nunito', "PingFang TC", "Microsoft JhengHei", sans-serif;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        body { margin: 0; font-family: var(--font-main); background-color: var(--bg-morandi); color: var(--text-primary); padding-bottom: 130px; line-height: 1.7; }
        .container { max-width: 700px; margin: 0 auto; padding: 30px 24px; }
        header { background: var(--bg-morandi); padding: 16px 24px; position: sticky; top: 0; z-index: 100; display: flex; justify-content: center; align-items: center; border-radius: 0 0 var(--radius-xl) var(--radius-xl); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        h1 { margin: 0; font-size: 1.4rem; color: var(--accent-pink); font-weight: 800; }
        
        /* Basic UI Elements */
        .card { background: var(--bg-morandi); border-radius: var(--radius-xl); padding: 24px; margin-bottom: 28px; box-shadow: var(--shadow-flat); display: flex; align-items: center; gap: 20px; transition: 0.3s; }
        .card:active { box-shadow: var(--shadow-pressed); transform: scale(0.98); }
        .card-img { width: 72px; height: 72px; border-radius: 50%; object-fit: cover; box-shadow: var(--shadow-pressed); padding: 4px; background: var(--bg-morandi); }
        .card-content { flex: 1; overflow: hidden; }
        .card-title { font-weight: 700; font-size: 1.25rem; margin-bottom: 8px; }
        .card-subtitle { font-size: 0.9rem; color: var(--text-secondary); }
        
        input, select, textarea { width: 100%; padding: 16px 24px; margin-bottom: 28px; border: none; border-radius: var(--radius-pill); background: var(--bg-morandi); color: var(--text-primary); box-shadow: var(--shadow-pressed); font-size: 1rem; }
        textarea { border-radius: var(--radius-xl); }
        label { display: block; margin-bottom: 10px; font-size: 0.9rem; color: var(--accent-pink); font-weight: 700; margin-left: 16px; }
        
        .btn { padding: 14px 28px; border: none; border-radius: var(--radius-pill); background: var(--bg-morandi); color: var(--text-primary); box-shadow: var(--shadow-flat); font-weight: 700; transition: 0.3s; cursor: pointer; display: inline-flex; justify-content: center; align-items: center; }
        .btn:active { box-shadow: var(--shadow-pressed); transform: scale(0.96); }
        .btn-primary { color: var(--accent-pink); } .btn-danger { color: var(--danger); }
        .btn-block { width: 100%; display: flex; margin-bottom: 16px; }
        .fab { position: fixed; bottom: 100px; right: 28px; width: 60px; height: 60px; border-radius: 50%; background: var(--bg-morandi); color: var(--accent-pink); font-size: 1.8rem; box-shadow: var(--shadow-flat); border: none; display: flex; align-items: center; justify-content: center; z-index: 90; transition: 0.3s; }
        .fab:active { box-shadow: var(--shadow-pressed); transform: scale(0.9); }
        
        nav { position: fixed; bottom: 20px; left: 20px; right: 20px; width: auto; background: var(--bg-morandi); border-radius: var(--radius-pill); box-shadow: 6px 6px 12px var(--neu-dark), -6px -6px 12px var(--neu-light); display: flex; justify-content: space-around; padding: 8px 20px; z-index: 100; }
        nav button { background: none; border: none; color: var(--text-secondary); display: flex; flex-direction: column; align-items: center; padding: 6px 20px; font-size: 0.8rem; font-weight: 600; }
        nav button.active { color: var(--accent-pink); text-shadow: 0 0 1px currentColor; }
        nav button svg { width: 24px; height: 24px; margin-bottom: 4px; fill: currentColor; }

        /* Helpers */
        .hidden { display: none !important; }
        .view { display: none; animation: fadeIn 0.4s; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .cat-chip { padding: 8px 20px; border-radius: var(--radius-pill); background: var(--bg-morandi); color: var(--text-secondary); box-shadow: 5px 5px 10px var(--neu-dark), -5px -5px 10px var(--neu-light); margin-right: 12px; display: inline-block; font-weight: 700; font-size: 0.9rem; }
        .cat-chip.active { color: var(--accent-pink); box-shadow: inset 3px 3px 6px var(--neu-dark), inset -3px -3px 6px var(--neu-light); }
        .category-scroll { overflow-x: auto; white-space: nowrap; padding: 10px 4px 20px 4px; scrollbar-width: none; }

        #toast { visibility: hidden; min-width: 260px; background-color: var(--bg-morandi); color: var(--accent-pink); text-align: center; border-radius: var(--radius-pill); padding: 18px 28px; position: fixed; z-index: 200; left: 50%; bottom: 100px; transform: translateX(-50%); font-weight: 700; box-shadow: var(--shadow-flat); }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 80px; opacity: 0;} to {bottom: 100px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 100px; opacity: 1;} to {bottom: 80px; opacity: 0;} }

        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 3000; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; font-weight: bold; backdrop-filter: blur(4px); }
        
        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(242, 234, 228, 0.9); z-index: 2000; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: 0.3s; }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-content { width: 90%; max-width: 500px; max-height: 85vh; background: var(--bg-morandi); border-radius: var(--radius-xl); box-shadow: 20px 20px 60px var(--neu-dark); display: flex; flex-direction: column; overflow: hidden; }
        .modal-body { padding: 24px; overflow-y: auto; }
    </style>
</head>
<body>

<header>
    <h1 id="header-title">é£Ÿè­œç®¡å®¶</h1>
</header>

<div class="container">
    <div id="view-list" class="view active">
        <div class="category-scroll" id="category-filter-list"></div>
        <div style="position:relative; margin-bottom: 24px;">
            <input type="text" id="search-input" placeholder="æœå°‹æ‚¨çš„é£Ÿè­œ..." oninput="app.handleSearch()">
        </div>
        <div class="btn-block" style="border: 2px dashed #ccc; border-radius: 20px; padding: 10px; justify-content: center; cursor: pointer;" onclick="document.getElementById('scan-file-input').click()">
            <span style="color: var(--text-secondary); font-weight: 700;">ğŸ“· æ™ºæ…§åŒ¯å…¥ (OCR/Word)</span>
            <input type="file" id="scan-file-input" accept=".jpg,.jpeg,.png,.docx" style="display: none;" onchange="app.handleFileScan(this)">
        </div>
        <div id="recipe-list-container"></div>
        <button class="fab" onclick="app.navTo('edit')">ï¼‹</button>
    </div>

    <div id="view-detail" class="view">
        <div style="text-align:center; padding: 20px;">
            <img id="detail-image" src="" style="width:180px; height:180px; border-radius:50%; object-fit:cover; border: 8px solid var(--bg-morandi); box-shadow: var(--shadow-pressed);">
        </div>
        <div style="text-align:center; margin-bottom:20px;">
            <h2 id="detail-title" style="margin:0;">é£Ÿè­œåç¨±</h2>
            <div id="detail-category-badge" style="color:var(--accent-pink); font-weight:700; margin-top:5px;">åˆ†é¡</div>
        </div>
        
        <div style="display:flex; justify-content:center; gap:10px; margin-bottom:30px;">
            <button class="btn btn-sm" onclick="app.editCurrentRecipe()">ç·¨è¼¯</button>
            <button class="btn btn-sm btn-danger" onclick="app.deleteCurrentRecipe()">åˆªé™¤</button>
        </div>

        <div style="background:var(--bg-morandi); padding:24px; border-radius:var(--radius-xl); box-shadow:var(--shadow-pressed); margin-bottom:30px;">
            <label style="text-align:center;">ç›®æ¨™ä»½æ•¸ (åŸºæº–: <span id="detail-base-servings"></span>äºº)</label>
            <div style="display:flex; justify-content:center; gap:10px;">
                <input type="number" id="target-servings" value="1" min="1" style="width:100px; text-align:center; margin-bottom:0;">
                <button class="btn btn-primary" onclick="app.renderDetailCalculation()">è¨ˆç®—</button>
            </div>
            <div style="margin-top:20px; display:flex; justify-content:space-between; border-top:1px solid #ddd; padding-top:15px;">
                <span style="font-weight:700; color:var(--text-secondary);">é ä¼°ç¸½æˆæœ¬</span>
                <span id="detail-total-cost" style="color:var(--accent-pink); font-weight:800; font-size:1.5rem;">0.00</span>
            </div>
        </div>

        <h3>é£Ÿææ˜ç´°</h3>
        <div id="detail-ingredients-list" style="margin-bottom:30px;"></div>

        <h3>è£½ä½œæ­¥é©Ÿ</h3>
        <div id="detail-steps-list" style="margin-bottom:40px;"></div>

        <button class="btn btn-block" onclick="app.navTo('list')">è¿”å›åˆ—è¡¨</button>
    </div>

    <div id="view-edit" class="view">
        <h2>é£Ÿè­œç·¨è¼¯</h2>
        <label>åç¨±</label><input type="text" id="edit-name">
        <label>åˆ†é¡</label><select id="edit-category"></select>
        <label>åŸºæº–ä»½æ•¸</label><input type="number" id="edit-base-servings">
        
        <label>é£Ÿæ</label>
        <div id="edit-ingredients-list"></div>
        <button class="btn btn-sm" onclick="app.addIngredientRow()" style="margin-bottom:20px;">+ åŠ å…¥é£Ÿæ</button>

        <label>æ­¥é©Ÿ</label>
        <div id="edit-steps-list"></div>
        <button class="btn btn-sm" onclick="app.addStepRow()" style="margin-bottom:30px;">+ åŠ å…¥æ­¥é©Ÿ</button>

        <div style="display:flex; gap:10px;">
            <button class="btn" style="flex:1" onclick="app.navTo('list')">å–æ¶ˆ</button>
            <button class="btn btn-primary" style="flex:1" onclick="app.saveRecipe()">å„²å­˜</button>
        </div>
    </div>

    <div id="view-settings" class="view">
        <h3>è³‡æ–™åº«ç®¡ç†</h3>
        
        <div style="margin-bottom:30px;">
            <label>æ–°å¢åˆ†é¡</label>
            <div style="display:flex; gap:10px;">
                <input type="text" id="setting-cat-name" placeholder="åˆ†é¡åç¨±" style="margin-bottom:0;">
                <button class="btn btn-primary" onclick="app.addCategory()">æ–°å¢</button>
            </div>
            <div id="settings-cat-list" style="margin-top:15px; display:flex; flex-wrap:wrap; gap:10px;"></div>
        </div>

        <div style="margin-bottom:30px;">
            <label>æ–°å¢/ç·¨è¼¯é£Ÿæ</label>
            <div style="background:var(--bg-morandi); padding:20px; border-radius:var(--radius-xl); box-shadow:var(--shadow-pressed);">
                <input type="text" id="setting-ing-name" placeholder="é£Ÿæåç¨±">
                <div style="display:flex; gap:10px;">
                    <input type="number" id="setting-ing-price" placeholder="å–®åƒ¹">
                    <input type="text" id="setting-ing-unit" placeholder="å–®ä½ (å¦‚: g, ä¸ª)">
                </div>
                <button class="btn btn-primary btn-block" onclick="app.saveIngredient()">å„²å­˜é£Ÿæ</button>
            </div>
            <div id="settings-ing-list" style="margin-top:20px;"></div>
        </div>
    </div>
</div>

<nav>
    <button onclick="app.navTo('list')" id="nav-list" class="active">
        <svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>é£Ÿè­œ
    </button>
    <button onclick="app.navTo('settings')" id="nav-settings">
        <svg viewBox="0 0 24 24"><path d="M17.21 9l-4.38-6.56a1 1 0 0 0-1.66 0L6.79 9H2v13a1 1 0 0 0 1 1h18a1 1 0 0 0 1-1V9h-4.79zM12 4.22L15.19 9H8.81L12 4.22zM20 21H4V11h16v10z"/></svg>è³‡æ–™åº«
    </button>
</nav>

<div id="loading-overlay" class="loading-overlay hidden">
    <div style="font-size:3rem;">â˜ï¸</div>
    <div id="loading-text" style="margin-top:10px;">è³‡æ–™åŒæ­¥ä¸­...</div>
</div>

<div id="modal-scan" class="modal-overlay">
    <div class="modal-content">
        <div style="padding:20px; border-bottom:1px solid #eee;"><h3>æ™ºæ…§åŒ¯å…¥é è¦½</h3></div>
        <div class="modal-body">
            <label>é£Ÿè­œåç¨±</label><input type="text" id="scan-name">
            <label>é£Ÿæ (æ¯è¡Œä¸€é …)</label><textarea id="scan-ingredients-text" style="height:100px;"></textarea>
            <label>æ­¥é©Ÿ (æ¯è¡Œä¸€é …)</label><textarea id="scan-steps-text" style="height:120px;"></textarea>
        </div>
        <div style="padding:20px; display:flex; gap:10px;">
            <button class="btn" style="flex:1" onclick="document.getElementById('modal-scan').classList.remove('active')">å–æ¶ˆ</button>
            <button class="btn btn-primary" style="flex:1" onclick="app.confirmScanImport()">åŒ¯å…¥</button>
        </div>
    </div>
</div>

<div id="toast">Message</div>

<script type="module">
    // 1. Firebase Config & Init
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, getDocs, setDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // TODO: Replace with YOUR OWN Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyBAwloed-9fPTOJmc4dlZptIN_lV9Kd7k8",
        authDomain: "cookbook-93de8.firebaseapp.com",
        projectId: "cookbook-93de8",
        storageBucket: "cookbook-93de8.firebasestorage.app",
        messagingSenderId: "443155806046",
        appId: "1:443155806046:web:16368ec4a8598a7aafc1cf",
        measurementId: "G-TJWN4KRCHT"
    };

    const firebaseApp = initializeApp(firebaseConfig);
    const db = getFirestore(firebaseApp);

    // 2. Constants & State
    const CONSTANTS = { 
        IMG_PLACEHOLDER: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2QzYzZiYyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iI2QzYzZiYyIvPjwvc3ZnPg==' 
    };
    
    // In-memory state (mirrors Firestore)
    let appState = {
        categories: [],
        ingredients: [],
        recipes: []
    };

    let editingRecipeId = null;
    let currentDetailRecipeId = null;
    let currentCatFilter = 'all';

    const getEl = (id) => document.getElementById(id);
    const uuid = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
    const showLoading = (msg) => { getEl('loading-text').innerText = msg; getEl('loading-overlay').classList.remove('hidden'); };
    const hideLoading = () => getEl('loading-overlay').classList.add('hidden');
    const toast = (msg) => { 
        const t = getEl('toast'); t.innerText = msg; t.className = 'show'; 
        setTimeout(() => t.className = '', 3000); 
    };

    // 3. Database Functions (Adapter Layer)
    const dbApi = {
        async loadAll() {
            showLoading('é›²ç«¯è³‡æ–™åŒæ­¥ä¸­...');
            try {
                const catsSnap = await getDocs(collection(db, "categories"));
                appState.categories = catsSnap.docs.map(d => d.data());
                
                const ingsSnap = await getDocs(collection(db, "ingredients"));
                appState.ingredients = ingsSnap.docs.map(d => d.data());
                
                const recipesSnap = await getDocs(collection(db, "recipes"));
                appState.recipes = recipesSnap.docs.map(d => d.data());
            } catch (e) {
                console.error(e);
                toast('è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯');
            } finally {
                hideLoading();
            }
        },
        async saveItem(collectionName, item) {
            try {
                await setDoc(doc(db, collectionName, item.id), item);
            } catch(e) { console.error(e); toast('å„²å­˜å¤±æ•—'); }
        },
        async deleteItem(collectionName, id) {
            try {
                await deleteDoc(doc(db, collectionName, id));
            } catch(e) { console.error(e); toast('åˆªé™¤å¤±æ•—'); }
        }
    };

    // 4. App Logic
    window.app = { // Expose to window for HTML onclick
        init: async () => {
            await dbApi.loadAll();
            app.navTo('list');
        },

        navTo: (viewName) => {
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(el => el.classList.remove('active'));
            
            getEl(`view-${viewName}`).classList.add('active');
            
            if(viewName === 'list') { 
                getEl('nav-list').classList.add('active'); 
                app.renderRecipeList(); 
            }
            if(viewName === 'settings') { 
                getEl('nav-settings').classList.add('active'); 
                app.renderSettings(); 
            }
            if(viewName === 'edit' && editingRecipeId === null) app.initEditForm();
        },

        // --- Recipe List ---
        filterCategory: (id, btn) => {
            currentCatFilter = id;
            document.querySelectorAll('.cat-chip').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            app.renderRecipeList();
        },
        handleSearch: () => app.renderRecipeList(),
        
        renderRecipeList: () => {
            const keyword = getEl('search-input').value.toLowerCase();
            const listEl = getEl('recipe-list-container');
            const catListEl = getEl('category-filter-list');
            
            // Render Categories Chips
            let catHtml = `<div class="cat-chip ${currentCatFilter === 'all' ? 'active' : ''}" onclick="app.filterCategory('all', this)">å…¨éƒ¨</div>`;
            appState.categories.forEach(c => {
                catHtml += `<div class="cat-chip ${currentCatFilter === c.id ? 'active' : ''}" onclick="app.filterCategory('${c.id}', this)">${c.name}</div>`;
            });
            catListEl.innerHTML = catHtml;

            // Filter Logic
            let filtered = appState.recipes.filter(r => r.name.toLowerCase().includes(keyword));
            if(currentCatFilter !== 'all') {
                filtered = filtered.filter(r => r.categoryId === currentCatFilter);
            }

            listEl.innerHTML = '';
            filtered.forEach(r => {
                const div = document.createElement('div');
                div.className = 'card';
                div.onclick = () => app.openDetail(r.id);
                // Find Category Name
                const cat = appState.categories.find(c => c.id === r.categoryId);
                const catName = cat ? cat.name : 'æœªåˆ†é¡';
                
                div.innerHTML = `
                    <img src="${r.image || CONSTANTS.IMG_PLACEHOLDER}" class="card-img">
                    <div class="card-content">
                        <div class="card-title">${r.name}</div>
                        <div class="card-subtitle"><span style="color:var(--accent-pink)">${catName}</span> â€¢ ${r.baseServings}äººä»½</div>
                    </div>
                    <div style="font-size:1.5rem; color:var(--accent-pink);">â€º</div>
                `;
                listEl.appendChild(div);
            });
        },

        // --- Recipe Detail ---
        openDetail: (id) => {
            currentDetailRecipeId = id;
            const r = appState.recipes.find(x => x.id === id);
            if(!r) return;

            getEl('detail-title').innerText = r.name;
            const cat = appState.categories.find(c => c.id === r.categoryId);
            getEl('detail-category-badge').innerText = cat ? cat.name : 'æœªåˆ†é¡';
            getEl('detail-base-servings').innerText = r.baseServings;
            getEl('target-servings').value = r.baseServings;
            getEl('detail-image').src = r.image || CONSTANTS.IMG_PLACEHOLDER;

            // Render Steps
            const stepsDiv = getEl('detail-steps-list');
            stepsDiv.innerHTML = '';
            if(r.steps && r.steps.length > 0) {
                r.steps.forEach((step, i) => {
                    const d = document.createElement('div');
                    d.style.cssText = "background:var(--bg-morandi); padding:15px; margin-bottom:15px; border-radius:15px; box-shadow:var(--shadow-flat); display:flex; gap:10px;";
                    d.innerHTML = `<div style="background:var(--accent-pink); color:white; width:25px; height:25px; border-radius:50%; display:flex; justify-content:center; align-items:center; flex-shrink:0;">${i+1}</div><div>${step}</div>`;
                    stepsDiv.appendChild(d);
                });
            } else {
                stepsDiv.innerHTML = '<div style="text-align:center; color:#999;">æš«ç„¡æ­¥é©Ÿ</div>';
            }

            app.renderDetailCalculation();
            app.navTo('detail');
        },

        renderDetailCalculation: () => {
            const r = appState.recipes.find(x => x.id === currentDetailRecipeId);
            const target = parseFloat(getEl('target-servings').value) || 0;
            const ratio = target / r.baseServings;
            
            const listDiv = getEl('detail-ingredients-list');
            listDiv.innerHTML = '';
            let total = 0;

            r.ingredients.forEach(ri => {
                const ingDb = appState.ingredients.find(i => i.id === ri.ingredientId);
                if(!ingDb) return;
                const amt = ri.amount * ratio;
                const cost = amt * ingDb.price;
                total += cost;

                const d = document.createElement('div');
                d.style.cssText = "display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #eee;";
                d.innerHTML = `
                    <span>${ingDb.name} <small style="color:#888;">(${amt.toFixed(1)} ${ingDb.unit})</small></span>
                    <span style="font-weight:700;">$${cost.toFixed(1)}</span>
                `;
                listDiv.appendChild(d);
            });
            getEl('detail-total-cost').innerText = total.toFixed(1);
        },

        deleteCurrentRecipe: async () => {
            if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) {
                await dbApi.deleteItem("recipes", currentDetailRecipeId);
                appState.recipes = appState.recipes.filter(r => r.id !== currentDetailRecipeId);
                app.navTo('list');
                toast('å·²åˆªé™¤');
            }
        },

        // --- Edit / Create ---
        editCurrentRecipe: () => {
            editingRecipeId = currentDetailRecipeId;
            app.initEditForm();
            app.navTo('edit');
        },
        initEditForm: () => {
            const r = editingRecipeId ? appState.recipes.find(x => x.id === editingRecipeId) : null;
            
            // Reset Fields
            getEl('edit-name').value = r ? r.name : '';
            getEl('edit-base-servings').value = r ? r.baseServings : 4;
            
            // Cat Select
            const catSel = getEl('edit-category');
            catSel.innerHTML = '<option value="">æœªåˆ†é¡</option>';
            appState.categories.forEach(c => {
                catSel.innerHTML += `<option value="${c.id}" ${r && r.categoryId === c.id ? 'selected' : ''}>${c.name}</option>`;
            });

            // Ingredients
            const ingDiv = getEl('edit-ingredients-list');
            ingDiv.innerHTML = '';
            if(r && r.ingredients) {
                r.ingredients.forEach(i => app.addIngredientRow(i.ingredientId, i.amount));
            }

            // Steps
            const stepDiv = getEl('edit-steps-list');
            stepDiv.innerHTML = '';
            if(r && r.steps) {
                r.steps.forEach(s => app.addStepRow(s));
            } else {
                app.addStepRow(); // Default one empty row
            }
        },
        addIngredientRow: (selId = '', val = '') => {
            const div = document.createElement('div');
            div.className = 'ingredient-row';
            let opts = '<option value="">é¸æ“‡é£Ÿæ</option>';
            appState.ingredients.forEach(i => {
                opts += `<option value="${i.id}" ${i.id===selId?'selected':''}>${i.name}</option>`;
            });
            div.innerHTML = `
                <select class="ing-sel">${opts}</select>
                <input type="number" class="ing-amt" value="${val}" placeholder="é‡">
                <button class="btn btn-danger" onclick="this.parentElement.remove()">X</button>
            `;
            getEl('edit-ingredients-list').appendChild(div);
        },
        addStepRow: (val = '') => {
            const div = document.createElement('div');
            div.style.cssText = "display:flex; gap:10px; margin-bottom:10px;";
            div.innerHTML = `
                <textarea class="step-txt" rows="2" placeholder="è¼¸å…¥æ­¥é©Ÿèªªæ˜...">${val}</textarea>
                <button class="btn btn-danger" style="height:auto;" onclick="this.parentElement.remove()">X</button>
            `;
            getEl('edit-steps-list').appendChild(div);
        },
        saveRecipe: async () => {
            const name = getEl('edit-name').value;
            if(!name) return alert('è«‹è¼¸å…¥åç¨±');

            const ingRows = document.querySelectorAll('.ingredient-row');
            const ingredients = [];
            ingRows.forEach(row => {
                const id = row.querySelector('.ing-sel').value;
                const amt = parseFloat(row.querySelector('.ing-amt').value);
                if(id && amt) ingredients.push({ ingredientId: id, amount: amt });
            });

            const stepRows = document.querySelectorAll('.step-txt');
            const steps = [];
            stepRows.forEach(row => { if(row.value.trim()) steps.push(row.value.trim()); });

            const newR = {
                id: editingRecipeId || uuid(),
                name,
                baseServings: parseFloat(getEl('edit-base-servings').value) || 1,
                categoryId: getEl('edit-category').value,
                ingredients,
                steps,
                image: null // ç°¡åŒ–ï¼šæš«ä¸è™•ç†åœ–ç‰‡ä¸Šå‚³ï¼Œä¿ç•™åŸé‚è¼¯å³å¯
            };

            await dbApi.saveItem("recipes", newR);
            
            // Local Update
            if(editingRecipeId) {
                const idx = appState.recipes.findIndex(x => x.id === editingRecipeId);
                appState.recipes[idx] = newR;
            } else {
                appState.recipes.push(newR);
            }
            
            editingRecipeId = null;
            toast('å„²å­˜æˆåŠŸ');
            app.navTo('list');
        },

        // --- Settings ---
        renderSettings: () => {
            // Categories
            const catDiv = getEl('settings-cat-list');
            catDiv.innerHTML = '';
            appState.categories.forEach(c => {
                const b = document.createElement('div');
                b.className = 'cat-chip active';
                b.innerText = c.name;
                catDiv.appendChild(b);
            });

            // Ingredients
            const ingDiv = getEl('settings-ing-list');
            ingDiv.innerHTML = '';
            appState.ingredients.forEach(i => {
                const d = document.createElement('div');
                d.className = 'card';
                d.style.padding = '15px';
                d.innerHTML = `<div><b>${i.name}</b> $${i.price}/${i.unit}</div>`;
                ingDiv.appendChild(d);
            });
        },
        addCategory: async () => {
            const name = getEl('setting-cat-name').value;
            if(!name) return;
            const newC = { id: uuid(), name };
            await dbApi.saveItem("categories", newC);
            appState.categories.push(newC);
            getEl('setting-cat-name').value = '';
            app.renderSettings();
        },
        saveIngredient: async () => {
            const name = getEl('setting-ing-name').value;
            const price = parseFloat(getEl('setting-ing-price').value);
            const unit = getEl('setting-ing-unit').value;
            if(!name || !unit) return;

            const newI = { id: uuid(), name, price, unit };
            await dbApi.saveItem("ingredients", newI);
            appState.ingredients.push(newI);
            
            getEl('setting-ing-name').value = '';
            getEl('setting-ing-price').value = '';
            getEl('setting-ing-unit').value = '';
            app.renderSettings();
        },

        // --- OCR Scan (ä¿ç•™åŸé‚è¼¯) ---
        handleFileScan: async (input) => {
            const file = input.files[0];
            if(!file) return;
            showLoading('æ™ºæ…§åˆ†æä¸­...');
            
            try {
                let text = "";
                if(file.name.endsWith('.docx')) {
                    const buf = await file.arrayBuffer();
                    const res = await mammoth.extractRawText({ arrayBuffer: buf });
                    text = res.value;
                } else {
                    const res = await Tesseract.recognize(file, 'chi_tra+eng');
                    text = res.data.text;
                }
                
                // Parse Logic
                const lines = text.split(/\r?\n/).filter(l => l.trim());
                getEl('scan-name').value = lines[0] || 'æœªå‘½å';
                
                // Simple heuristic: Lines with numbers -> Ingredients, Long lines -> Steps
                const ings = [], steps = [];
                for(let i=1; i<lines.length; i++) {
                    if(/\d/.test(lines[i]) && lines[i].length < 15) ings.push(lines[i]);
                    else steps.push(lines[i]);
                }
                getEl('scan-ingredients-text').value = ings.join('\n');
                getEl('scan-steps-text').value = steps.join('\n');
                
                getEl('modal-scan').classList.add('active');
            } catch(e) {
                alert('è§£æå¤±æ•—');
            } finally {
                hideLoading();
                input.value = '';
            }
        },
        confirmScanImport: async () => {
            const name = getEl('scan-name').value;
            const ingText = getEl('scan-ingredients-text').value;
            const stepText = getEl('scan-steps-text').value;
            
            // Auto-create ingredients
            const ingredients = [];
            const lines = ingText.split('\n');
            for(let line of lines) {
                // Try to extract name (simplified)
                const ingName = line.replace(/[0-9.]/g, '').trim();
                let ingId = uuid();
                // Check exist
                const exist = appState.ingredients.find(i => i.name === ingName);
                if(exist) ingId = exist.id;
                else {
                    const newI = { id: ingId, name: ingName, price: 0, unit: 'g' };
                    await dbApi.saveItem("ingredients", newI);
                    appState.ingredients.push(newI);
                }
                ingredients.push({ ingredientId: ingId, amount: parseFloat(line.match(/\d+/)) || 0 });
            }

            const newR = {
                id: uuid(),
                name,
                baseServings: 1,
                categoryId: '',
                ingredients,
                steps: stepText.split('\n').filter(s=>s.trim())
            };
            
            await dbApi.saveItem("recipes", newR);
            appState.recipes.push(newR);
            getEl('modal-scan').classList.remove('active');
            toast('åŒ¯å…¥æˆåŠŸ');
            editingRecipeId = newR.id;
            app.navTo('edit');
        }
    };

    // Start App
    app.init();
</script>
</body>
</html>
