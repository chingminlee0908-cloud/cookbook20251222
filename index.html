<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£Ÿè­œç®¡å®¶ | Morandi Neumorphism Pro + Steps</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>

    <style>
        /* --- 1. Design Tokens --- */
        :root {
            --bg-morandi: #F2EAE4;
            --text-primary: #5E5451;
            --text-secondary: #8C8380;
            --accent-pink: #D48A96;
            --danger: #C47070;
            --success: #789c79;

            --neu-light: #FFFFFF;
            --neu-dark: #D3C6BC;

            --shadow-flat: 10px 10px 20px var(--neu-dark), -10px -10px 20px var(--neu-light);
            --shadow-hover: 14px 14px 28px var(--neu-dark), -14px -14px 28px var(--neu-light);
            --shadow-pressed: inset 6px 6px 12px var(--neu-dark), inset -6px -6px 12px var(--neu-light);
            --shadow-shallow: 5px 5px 12px var(--neu-dark), -5px -5px 12px var(--neu-light);

            --radius-xl: 28px;
            --radius-pill: 50px;
            --font-main: 'Nunito', "PingFang TC", "Microsoft JhengHei", sans-serif;
        }

        /* --- 2. Global Reset --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        body { 
            margin: 0; font-family: var(--font-main);
            background-color: var(--bg-morandi); color: var(--text-primary);
            padding-bottom: 130px; line-height: 1.7;
        }

        h1, h2, h3 { font-weight: 700; color: var(--text-primary); letter-spacing: 0.02em; }
        label, th, .card-subtitle, .badge, nav button { font-weight: 600; letter-spacing: 0.05em; }

        /* --- 3. Layout Components --- */
        .container { max-width: 700px; margin: 0 auto; padding: 30px 24px; }

        header { 
            background: var(--bg-morandi); box-shadow: var(--shadow-shallow);
            padding: 16px 24px; position: sticky; top: 0; z-index: 100; 
            display: flex; justify-content: center; align-items: center; 
            border-bottom-left-radius: var(--radius-xl); border-bottom-right-radius: var(--radius-xl);
        }
        h1 { margin: 0; font-size: 1.4rem; color: var(--accent-pink); font-weight: 800; }

        /* --- 4. Cards & UI Elements --- */
        .card { 
            background: var(--bg-morandi); border-radius: var(--radius-xl); 
            padding: 24px; margin-bottom: 28px; box-shadow: var(--shadow-flat);
            border: none; display: flex; align-items: center; gap: 20px; 
            cursor: pointer; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative; overflow: hidden;
        }
        .card:hover { transform: translateY(-4px); box-shadow: var(--shadow-hover); }
        .card:active { box-shadow: var(--shadow-pressed); transform: scale(0.98); }
        .card-img { width: 72px; height: 72px; border-radius: 50%; object-fit: cover; box-shadow: var(--shadow-pressed); padding: 4px; background: var(--bg-morandi); }
        .card-content { flex: 1; overflow: hidden; }
        .card-title { font-weight: 700; font-size: 1.25rem; margin-bottom: 8px; }
        .card-subtitle { font-size: 0.9rem; color: var(--text-secondary); }

        /* Inputs */
        input, select, textarea { 
            width: 100%; padding: 16px 24px; margin-bottom: 28px; 
            border: none; border-radius: var(--radius-pill);
            font-family: var(--font-main); font-size: 1rem; 
            background: var(--bg-morandi); color: var(--text-primary);
            box-shadow: var(--shadow-pressed); transition: all 0.2s;
        }
        textarea { border-radius: var(--radius-xl); resize: vertical; }
        input:focus, select:focus, textarea:focus { color: var(--accent-pink); }
        label { display: block; margin-bottom: 10px; font-size: 0.9rem; color: var(--accent-pink); font-weight: 700; margin-left: 16px; }

        /* Buttons */
        .btn { 
            padding: 14px 28px; border: none; border-radius: var(--radius-pill); 
            cursor: pointer; font-family: var(--font-main); font-size: 1rem; font-weight: 700;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px; 
            background: var(--bg-morandi); color: var(--text-primary);
            box-shadow: var(--shadow-flat); transition: all 0.3s;
            position: relative; overflow: hidden;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-hover); }
        .btn:active { box-shadow: var(--shadow-pressed); transform: scale(0.96); }
        .btn-primary { color: var(--accent-pink); font-weight: 800; }
        .btn-danger { color: var(--danger); }
        .btn-outline { box-shadow: var(--shadow-shallow); color: var(--text-secondary); }
        .btn-outline:active { box-shadow: var(--shadow-pressed); }
        .btn-edit-mode { color: var(--bg-morandi); background: var(--text-secondary); }
        .btn-block { width: 100%; display: flex; margin-bottom: 16px; }
        .btn-sm { padding: 10px 20px; font-size: 0.9rem; }
        
        /* FAB */
        .fab { 
            position: fixed; bottom: 100px; right: 28px; 
            width: 60px; height: 60px; border-radius: 50%; 
            background: var(--bg-morandi); color: var(--accent-pink); 
            display: flex; align-items: center; justify-content: center; 
            font-size: 1.8rem; font-weight: 300; 
            box-shadow: var(--shadow-flat); border: none; 
            cursor: pointer; z-index: 90; transition: all 0.3s; overflow: hidden;
        }
        .fab:hover { transform: translateY(-4px) rotate(90deg); box-shadow: var(--shadow-hover); }
        .fab:active { box-shadow: var(--shadow-pressed); transform: scale(0.9); }

        /* Ripple */
        .ripple { position: absolute; border-radius: 50%; background: rgba(255, 255, 255, 0.6); transform: scale(0); animation: ripple-animation 0.6s linear; pointer-events: none; }
        .btn-primary .ripple, .fab .ripple { background: rgba(212, 138, 150, 0.3); }
        @keyframes ripple-animation { to { transform: scale(4); opacity: 0; } }

        /* Chips */
        .category-scroll { display: flex; gap: 12px; overflow-x: auto; padding: 4px 4px 20px 4px; margin-bottom: 10px; scrollbar-width: none; }
        .cat-chip { flex: 0 0 auto; padding: 8px 20px; border-radius: var(--radius-pill); background: var(--bg-morandi); color: var(--text-secondary); font-weight: 700; font-size: 0.9rem; cursor: pointer; box-shadow: var(--shadow-shallow); transition: all 0.3s; border: 2px solid transparent; }
        .cat-chip.active { color: var(--accent-pink); box-shadow: var(--shadow-pressed); border-color: rgba(212, 138, 150, 0.1); }

        /* Recipe Steps Styling (New) */
        .step-item {
            background: var(--bg-morandi);
            /* Step card look */
            box-shadow: var(--shadow-shallow);
            border-radius: var(--radius-xl);
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            gap: 16px;
            align-items: flex-start;
        }
        .step-number {
            flex-shrink: 0;
            width: 32px; height: 32px;
            background: var(--accent-pink);
            color: var(--bg-morandi);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 800; font-size: 1rem;
            box-shadow: var(--shadow-pressed); /* Inset for the number circle */
        }
        .step-text {
            flex: 1;
            font-size: 1rem;
            color: var(--text-primary);
            white-space: pre-wrap; /* Preserve line breaks */
        }

        /* Detail & Tables */
        .table-container { background: var(--bg-morandi); border-radius: var(--radius-xl); box-shadow: var(--shadow-flat); padding: 12px; margin-bottom: 28px; overflow: hidden; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th { background: var(--bg-morandi); font-weight: 700; font-size: 0.9rem; color: var(--text-secondary); padding: 18px; text-align: left; border-bottom: 2px solid rgba(212, 138, 150, 0.15); }
        td { padding: 18px; font-size: 1rem; border-bottom: 1px solid rgba(212, 138, 150, 0.08); }
        tr:last-child td { border-bottom: none; }
        .price { color: var(--accent-pink); font-weight: 800; font-size: 1.1rem; }
        
        .detail-header { padding: 20px; text-align: center; }
        .detail-img { width: 180px; height: 180px; object-fit: cover; border-radius: 50%; border: 8px solid var(--bg-morandi); box-shadow: var(--shadow-pressed); }
        .detail-info { padding: 28px; background: var(--bg-morandi); border-radius: var(--radius-xl); box-shadow: var(--shadow-flat); margin: 0 20px 24px 20px; text-align: center; }
        .calc-box { background: var(--bg-morandi); padding: 28px; border-radius: var(--radius-xl); margin: 24px 20px; box-shadow: var(--shadow-pressed); }
        
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-secondary); box-shadow: var(--shadow-pressed); border-radius: var(--radius-xl); }
        .view { display: none; animation: fadeIn 0.4s ease-out; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .hidden { display: none !important; }
        .text-right { text-align: right; }
        
        /* Settings & Misc */
        .settings-item { background: var(--bg-morandi); box-shadow: var(--shadow-shallow); border-radius: var(--radius-xl); padding: 16px 24px; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .settings-item.editable:active { box-shadow: var(--shadow-pressed); transform: scale(0.98); }
        .ingredient-row { display: grid; grid-template-columns: 2fr 1fr 44px; gap: 16px; align-items: center; margin-bottom: 16px; }
        .ingredient-row .btn-danger { padding: 0; height: 44px; width: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; box-shadow: var(--shadow-shallow); }
        .ingredient-row .btn-danger:active { box-shadow: var(--shadow-pressed); }
        
        /* Step row in edit mode */
        .step-row { display: flex; gap: 12px; align-items: flex-start; margin-bottom: 16px; }
        .step-row textarea { margin-bottom: 0; }
        .step-row .btn-danger { height: 50px; width: 44px; border-radius: 12px; margin-top: 0; }

        .settings-section-title { margin-top: 40px; margin-bottom: 20px; padding-left: 10px; border-left: 4px solid var(--accent-pink); font-size: 1.2rem; }
        .entry-block { margin-top: 10px; padding: 24px; border: 2px dashed rgba(140, 131, 128, 0.2); border-radius: var(--radius-xl); text-align: center; }
        .editing-mode-box { border: 2px solid var(--accent-pink); position: relative; }
        .editing-mode-box::after { content: 'ç·¨è¼¯ä¸­'; position: absolute; top: -12px; left: 24px; background: var(--accent-pink); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; font-weight: bold; }

        #search-container input { padding-left: 52px; }
        #search-container::before { content: 'ğŸ”'; position: absolute; left: 22px; top: 50%; transform: translateY(-55%); color: var(--accent-pink); z-index: 2; font-size: 1.2rem; }

        /* Navigation */
        nav { position: fixed; bottom: 20px; left: 20px; right: 20px; width: auto; background: var(--bg-morandi); border-radius: var(--radius-pill); box-shadow: 6px 6px 12px var(--neu-dark), -6px -6px 12px var(--neu-light); display: flex; justify-content: space-around; padding: 8px 20px; z-index: 100; }
        nav button { background: none; border: none; font-size: 0.8rem; color: var(--text-secondary); display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: all 0.3s; padding: 6px 20px; border-radius: var(--radius-pill); position: relative; overflow: hidden; }
        nav button.active { color: var(--accent-pink); box-shadow: var(--shadow-pressed); }
        nav button svg { width: 20px; height: 20px; margin-bottom: 4px; fill: currentColor; }

        /* Modal & Loading */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(242, 234, 228, 0.85); backdrop-filter: blur(8px); z-index: 2000; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-content { width: 90%; max-width: 600px; max-height: 90vh; background: var(--bg-morandi); border-radius: var(--radius-xl); box-shadow: 20px 20px 60px var(--neu-dark), -20px -20px 60px var(--neu-light); display: flex; flex-direction: column; overflow: hidden; animation: slideUp 0.4s ease-out; }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { padding: 20px 24px; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .modal-body { padding: 24px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }
        .modal-footer { padding: 20px 24px; border-top: 1px solid rgba(0,0,0,0.05); display: flex; gap: 16px; }
        .scan-preview-split { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 600px) { .scan-preview-split { grid-template-columns: 1fr 1fr; } }
        .raw-text-box { font-family: monospace; font-size: 0.85rem; padding: 16px; background: #fffafa; border-radius: 12px; height: 200px; overflow-y: auto; border: 1px solid rgba(0,0,0,0.1); color: #555; white-space: pre-wrap; }
        
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 3000; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; font-weight: bold; }
        .spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: var(--accent-pink); animation: spin 1s ease-in-out infinite; margin-bottom: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        #toast { visibility: hidden; min-width: 260px; background-color: var(--bg-morandi); color: var(--accent-pink); text-align: center; border-radius: var(--radius-pill); padding: 18px 28px; position: fixed; z-index: 200; left: 50%; bottom: 100px; transform: translateX(-50%); font-weight: 700; box-shadow: var(--shadow-flat); }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        .badge { background: var(--bg-morandi); color: var(--accent-pink); padding: 8px 16px; border-radius: var(--radius-pill); font-size: 0.9rem; font-weight: 700; box-shadow: var(--shadow-pressed); }
    </style>
</head>
<body>

<header>
    <h1 id="header-title">é£Ÿè­œç®¡å®¶</h1>
</header>

<div class="container">
    <div id="view-list" class="view active">
        <div class="category-scroll" id="category-filter-list">
            <div class="cat-chip active ripple-btn" onclick="app.filterCategory('all', this)">å…¨éƒ¨</div>
        </div>
        <div id="search-container" style="position:relative; margin-bottom: 24px;">
            <input type="text" id="search-input" placeholder="æœå°‹æ‚¨çš„é£Ÿè­œ..." oninput="app.handleSearch()">
        </div>
        
        <div class="entry-block" style="margin-bottom: 24px; padding: 16px; display: flex; align-items: center; justify-content: center; gap: 10px; cursor: pointer;" onclick="document.getElementById('scan-file-input').click()">
            <span style="font-size: 1.5rem;">ğŸ“·</span>
            <span style="color: var(--text-secondary); font-weight: 700;">æ™ºæ…§åŒ¯å…¥ï¼šåœ–ç‰‡ / Word</span>
            <input type="file" id="scan-file-input" accept=".jpg,.jpeg,.png,.docx" style="display: none;" onchange="app.handleFileScan(this)">
        </div>

        <div id="recipe-list-container"></div>
        <button class="fab ripple-btn" onclick="app.navTo('edit')" aria-label="æ–°å¢é£Ÿè­œ">ï¼‹</button>
    </div>

    <div id="view-detail" class="view">
        <div class="detail-header">
            <img id="detail-image" class="detail-img" src="" alt="Recipe Image">
        </div>
        <div class="detail-info">
            <h2 id="detail-title" style="margin-top:0; border:none; text-align:center; font-size: 1.8rem; margin-bottom: 8px;">é£Ÿè­œåç¨±</h2>
            <div id="detail-category-badge" style="text-align: center; margin-bottom: 16px; color: var(--accent-pink); font-weight: 700;">åˆ†é¡åç¨±</div>
            <div style="display:flex; justify-content:center; gap: 10px; margin-bottom: 24px;">
                <span class="badge">åŸºæº–: <span id="detail-base-servings"></span> äººä»½</span>
            </div>
            <div style="display:flex; justify-content:center; gap:16px;">
                <button class="btn btn-sm btn-outline ripple-btn" onclick="app.editCurrentRecipe()">ç·¨è¼¯</button>
                <button class="btn btn-sm btn-danger ripple-btn" onclick="app.deleteCurrentRecipe()">åˆªé™¤</button>
            </div>
        </div>

        <div class="calc-box">
            <label for="target-servings" style="text-align: center;">ä»½é‡æ›ç®— (ç›®æ¨™äººæ•¸)</label>
            <div style="display:flex; gap:16px; align-items:center; justify-content: center;">
                <input type="number" id="target-servings" value="1" min="1" onchange="app.renderDetailCalculation()" style="margin-bottom:0; text-align:center; font-size: 1.4rem; width: 120px;">
            </div>
             <button class="btn btn-primary btn-block ripple-btn" onclick="app.renderDetailCalculation()" style="margin-top: 20px;">é‡æ–°è¨ˆç®—æˆæœ¬</button>
            <div style="margin-top:28px; display:flex; justify-content:space-between; align-items: center; border-top: 2px solid rgba(212, 138, 150, 0.15); padding-top: 20px;">
                <span style="font-weight: 700; color: var(--text-secondary);">é ä¼°ç¸½æˆæœ¬</span>
                <span class="price" id="detail-total-cost" style="font-size: 1.8rem;">0.00</span>
            </div>
        </div>

        <h3 style="text-align: center; margin-top: 36px; margin-bottom: 24px;">é£Ÿææ˜ç´°</h3>
        <div class="table-container">
            <table id="detail-table">
                <thead>
                    <tr><th>å“é …</th><th>æ•¸é‡</th><th>å–®ä½</th><th class="text-right">æˆæœ¬</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <h3 style="text-align: center; margin-top: 36px; margin-bottom: 24px;">è£½ä½œæ­¥é©Ÿ</h3>
        <div id="detail-steps-container"></div>

        <button class="btn btn-outline btn-block ripple-btn" onclick="app.navTo('list')" style="margin: 0 20px;">è¿”å›åˆ—è¡¨</button>
    </div>

    <div id="view-edit" class="view">
        <h2 id="edit-view-title">æ–°å¢é£Ÿè­œ</h2>
        <label>é£Ÿè­œåç¨±</label>
        <input type="text" id="edit-name" placeholder="ä¾‹å¦‚ï¼šè‰è“é®®å¥¶æ²¹è›‹ç³•">
        <label>åˆ†é¡</label>
        <select id="edit-category"><option value="default">æœªåˆ†é¡</option></select>
        <label>åŸºæº–ä»½æ•¸ (äºº)</label>
        <input type="number" id="edit-base-servings" value="4" min="1">
        <label>å°é¢åœ–ç‰‡ (é¸å¡«)</label>
        <div style="position:relative; overflow:hidden; margin-bottom: 28px;">
            <button class="btn btn-outline btn-block" style="pointer-events: none; color: var(--text-secondary);">é¸æ“‡åœ–ç‰‡...</button>
            <input type="file" id="edit-image-input" accept="image/*" onchange="app.handleImageUpload(this)" style="position:absolute; top:0; left:0; opacity:0; height:100%; width:100%; cursor:pointer;">
        </div>
        <div id="edit-image-preview-container" class="hidden" style="margin-bottom:28px; text-align:center;">
            <img id="edit-image-preview" src="" style="max-height: 200px; border-radius: var(--radius-xl); box-shadow: var(--shadow-flat); border: 4px solid var(--bg-morandi);">
            <br>
            <button class="btn btn-sm btn-danger ripple-btn" onclick="app.clearImage()" style="margin-top:20px;">ç§»é™¤åœ–ç‰‡</button>
        </div>
        
        <div style="display:flex; justify-content: space-between; align-items: center; margin-top: 36px; margin-bottom: 24px;">
            <h3 style="margin:0;">æ‰€éœ€é£Ÿæ</h3>
            <button class="btn btn-sm btn-outline ripple-btn" onclick="app.addIngredientRow()" style="color: var(--accent-pink);">ï¼‹ åŠ å…¥</button>
        </div>
        <div id="edit-ingredients-list"></div>

        <div style="display:flex; justify-content: space-between; align-items: center; margin-top: 40px; margin-bottom: 24px;">
            <h3 style="margin:0;">æ­¥é©ŸæŒ‡å¼•</h3>
            <button class="btn btn-sm btn-outline ripple-btn" onclick="app.addStepRow()" style="color: var(--accent-pink);">ï¼‹ åŠ å…¥æ­¥é©Ÿ</button>
        </div>
        <div id="edit-steps-list"></div>

        <div style="display:flex; gap:20px; margin-top: 48px;">
            <button class="btn btn-outline ripple-btn" style="flex:1" onclick="app.navTo('list')">å–æ¶ˆ</button>
            <button class="btn btn-primary ripple-btn" style="flex:1" onclick="app.saveRecipe()">å„²å­˜</button>
        </div>
    </div>

    <div id="view-settings" class="view">
        <div class="settings-section-title">å–®ä½ç®¡ç†</div>
        <div style="display:flex; gap:16px; margin-bottom:28px; align-items: flex-end;">
            <div style="flex:1"><label>æ–°å–®ä½åç¨±</label><input type="text" id="setting-unit-name" placeholder="ä¾‹å¦‚ï¼šç›’" style="margin-bottom:0;"></div>
            <button class="btn btn-primary ripple-btn" onclick="app.addUnit()" style="height: 58px;">æ–°å¢</button>
        </div>
        <div id="settings-unit-list" style="margin-bottom: 40px;"></div>

        <div class="settings-section-title">é£Ÿæå¸‚åƒ¹åº«</div>
        <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 10px;">é»æ“Šä¸‹æ–¹åˆ—è¡¨é …ç›®å¯é€²è¡Œç·¨è¼¯</p>
        <div id="ingredient-form-card" style="background: var(--bg-morandi); padding: 28px; box-shadow: var(--shadow-pressed); border-radius: var(--radius-xl); margin-bottom:36px;">
            <label>é£Ÿæåç¨±</label>
            <input type="text" id="setting-ing-name" placeholder="ä¾‹å¦‚ï¼šæœ‰æ©Ÿè‰è“">
            <div style="display:flex; gap:16px; margin-bottom: 10px;">
                <div style="flex:1"><label>å–®åƒ¹</label><input type="number" id="setting-ing-price" placeholder="0.00" step="0.01"></div>
                <div style="flex:1"><label>è¨ˆåƒ¹å–®ä½</label><select id="setting-ing-unit" style="margin-bottom:20px;"></select></div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button id="btn-cancel-ing-edit" class="btn btn-outline ripple-btn hidden" style="flex:1;" onclick="app.cancelEditIngredient()">å–æ¶ˆ</button>
                <button id="btn-save-ing" class="btn btn-primary ripple-btn" style="flex:1;" onclick="app.saveIngredient()">æ–°å¢é£Ÿæ</button>
            </div>
        </div>
        <div id="settings-ing-list"></div>

        <div style="margin-top: 60px;">
            <div class="settings-section-title" style="border-color: var(--text-secondary); color: var(--text-secondary);">é€²éšç®¡ç†</div>
            <div class="entry-block">
                <button class="btn btn-outline btn-block ripple-btn" onclick="app.navTo('categories')">ğŸ“ é£Ÿè­œåˆ†é¡ç®¡ç†</button>
                <button class="btn btn-outline btn-block ripple-btn" onclick="app.navTo('io')" style="margin-bottom: 0;">ğŸ’¾ è³‡æ–™å‚™ä»½èˆ‡é‚„åŸ</button>
            </div>
        </div>
    </div>

    <div id="view-categories" class="view">
        <h2>åˆ†é¡ç®¡ç†</h2>
        <div style="display:flex; gap:16px; margin-bottom:28px; align-items: flex-end;">
            <div style="flex:1"><label>æ–°åˆ†é¡åç¨±</label><input type="text" id="cat-manage-name" placeholder="ä¾‹å¦‚ï¼šç”œé»ã€ä¸»é¤" style="margin-bottom:0;"></div>
            <button class="btn btn-primary ripple-btn" onclick="app.addCategory()" style="height: 58px;">æ–°å¢</button>
        </div>
        <div id="category-manage-list"></div>
        <button class="btn btn-outline btn-block ripple-btn" onclick="app.navTo('settings')" style="margin-top: 40px;">è¿”å›è¨­å®š</button>
    </div>

    <div id="view-io" class="view">
        <h2>å‚™ä»½èˆ‡é‚„åŸ</h2>
        <p style="font-size: 0.95rem; color: var(--text-secondary); margin-bottom: 28px; background: var(--bg-morandi); box-shadow: var(--shadow-pressed); padding: 16px; border-radius: var(--radius-xl);">
            æ‚¨çš„è³‡æ–™å„²å­˜åœ¨æ­¤ç€è¦½å™¨ä¸­ã€‚è¤‡è£½ä¸‹æ–¹çš„ä»£ç¢¼ä»¥è½‰ç§»è³‡æ–™åˆ°å…¶ä»–è£ç½®ã€‚
        </p>
        <label>è³‡æ–™ä»£ç¢¼ (JSON)</label>
        <textarea id="io-textarea" rows="10" style="font-family: monospace; font-size: 0.9rem;"></textarea>
        <div style="display:flex; gap:16px; margin-bottom:24px; margin-top: 28px;">
            <button class="btn btn-outline ripple-btn" style="flex:1" onclick="app.exportData()">é¡¯ç¤ºè³‡æ–™ (åŒ¯å‡º)</button>
            <button class="btn btn-danger ripple-btn" style="flex:1" onclick="app.importData()">åŸ·è¡Œé‚„åŸ</button>
        </div>
        <button class="btn btn-outline btn-block ripple-btn" onclick="app.navTo('settings')">è¿”å›è¨­å®š</button>
    </div>
</div>

<nav>
    <button onclick="app.navTo('list')" id="nav-list" class="active ripple-btn">
        <svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>é£Ÿè­œ
    </button>
    <button onclick="app.navTo('settings')" id="nav-settings" class="ripple-btn">
        <svg viewBox="0 0 24 24"><path d="M17.21 9l-4.38-6.56a1 1 0 0 0-1.66 0L6.79 9H2v13a1 1 0 0 0 1 1h18a1 1 0 0 0 1-1V9h-4.79zM12 4.22L15.19 9H8.81L12 4.22zM20 21H4V11h16v10z"/></svg>é£Ÿæè¨­å®š
    </button>
</nav>

<div id="modal-scan" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3>æ™ºæ…§åŒ¯å…¥é è¦½</h3>
            <p style="font-size: 0.85rem; color: var(--text-secondary); margin:0;">ç³»çµ±å·²ç›¡åŠ›è§£æï¼Œè«‹æ‚¨æ ¸å°ä¸¦ä¿®æ­£ã€‚</p>
        </div>
        <div class="modal-body">
            <div class="scan-preview-split">
                <div>
                    <label>è¾¨è­˜å‡ºçš„åŸå§‹å…§å®¹</label>
                    <div id="scan-raw-text" class="raw-text-box"></div>
                </div>
                <div>
                    <label>é£Ÿè­œåç¨±</label>
                    <input type="text" id="scan-name" placeholder="åç¨±">
                    
                    <label>é è¨­ä»½æ•¸</label>
                    <input type="number" id="scan-servings" value="1">

                    <label>åµæ¸¬åˆ°çš„é£Ÿæ (æ–‡å­—)</label>
                    <textarea id="scan-ingredients-text" style="height: 100px;" placeholder="æ¯ä¸€è¡Œå¯«ä¸€å€‹é£Ÿæï¼Œä¾‹å¦‚ï¼š&#10;ç ‚ç³– 100g&#10;ç‰›å¥¶ 200ml"></textarea>

                    <label>åµæ¸¬åˆ°çš„æ­¥é©Ÿ (æ–‡å­—)</label>
                    <textarea id="scan-steps-text" style="height: 120px;" placeholder="æ¯ä¸€è¡Œå¯«ä¸€å€‹æ­¥é©Ÿ"></textarea>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline ripple-btn" onclick="app.closeScanModal()" style="flex:1">å–æ¶ˆ</button>
            <button class="btn btn-primary ripple-btn" onclick="app.confirmScanImport()" style="flex:1">ç¢ºèªåŠ å…¥ç³»çµ±</button>
        </div>
    </div>
</div>

<div id="loading-overlay" class="loading-overlay hidden">
    <div class="spinner"></div>
    <div id="loading-text">æ­£åœ¨æ·±å…¥åˆ†æé£Ÿè­œå…§å®¹...</div>
</div>

<div id="toast">è¨Šæ¯æç¤º</div>

<script>
const CONSTANTS = {
    STORE_KEY: 'recipe_app_v6_steps',
    IMG_PLACEHOLDER: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2QzYzZiYyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iI2QzYzZiYyIvPjwvc3ZnPg=='
};

const defaultState = {
    units: [{ id: 'u1', name: 'g' }, { id: 'u2', name: 'ml' }, { id: 'u3', name: 'å€‹' }, { id: 'u4', name: 'å°æ–¤' }],
    categories: [{ id: 'c1', name: 'ä¸»é¤' }, { id: 'c2', name: 'ç”œé»' }],
    ingredients: [], recipes: [] 
};

let appState = JSON.parse(JSON.stringify(defaultState));
let editingRecipeId = null, currentDetailRecipeId = null, editingIngredientId = null, currentCategoryFilter = 'all';

const uuid = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
const getEl = (id) => document.getElementById(id);

// --- Storage & Helpers ---
const storage = {
    save: () => { try { localStorage.setItem(CONSTANTS.STORE_KEY, JSON.stringify(appState)); } catch(e){ toast('å„²å­˜å¤±æ•—'); } },
    load: () => {
        const data = localStorage.getItem(CONSTANTS.STORE_KEY);
        if(data) {
            try { appState = { ...defaultState, ...JSON.parse(data) }; } 
            catch(e) { appState = JSON.parse(JSON.stringify(defaultState)); }
        }
    }
};

const toast = (msg) => {
    const el = getEl('toast'); el.textContent = msg; el.className = 'show';
    setTimeout(() => { el.className = ''; }, 3000);
};

const showLoading = (msg) => { getEl('loading-text').textContent = msg; getEl('loading-overlay').classList.remove('hidden'); };
const hideLoading = () => { getEl('loading-overlay').classList.add('hidden'); };

function createRipple(event) {
    const button = event.currentTarget;
    const circle = document.createElement("span");
    const d = Math.max(button.clientWidth, button.clientHeight);
    const r = button.getBoundingClientRect();
    circle.style.width = circle.style.height = `${d}px`;
    circle.style.left = `${event.clientX - r.left - d/2}px`;
    circle.style.top = `${event.clientY - r.top - d/2}px`;
    circle.classList.add("ripple");
    const old = button.getElementsByClassName("ripple")[0];
    if(old) old.remove();
    button.appendChild(circle);
}

function attachRippleEffect() {
    document.querySelectorAll('.ripple-btn, .card, nav button').forEach(btn => {
        btn.removeEventListener('click', createRipple);
        btn.addEventListener('click', createRipple);
    });
}

const resizeImage = (file) => {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const cvs = document.createElement('canvas');
                let w = img.width, h = img.height;
                if(w>500) { h=Math.round(h*500/w); w=500; }
                cvs.width=w; cvs.height=h;
                cvs.getContext('2d').drawImage(img,0,0,w,h);
                resolve(cvs.toDataURL('image/jpeg', 0.7));
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    });
};

// --- SCANNING LOGIC ---
const app = {
    init: () => { storage.load(); app.navTo('list'); },
    
    // 1. Handle File Upload
    handleFileScan: async (input) => {
        const file = input.files[0];
        if(!file) return;
        
        showLoading('è®€å–æª”æ¡ˆä¸­...');
        
        try {
            let text = "";
            
            if (file.type.includes('image')) {
                showLoading('AI å½±åƒè¾¨è­˜ä¸­ (é€™å¯èƒ½éœ€è¦å¹¾ç§’)...');
                const result = await Tesseract.recognize(file, 'chi_tra+eng');
                text = result.data.text;
            } else if (file.name.endsWith('.docx')) {
                showLoading('è§£æ Word æ–‡ä»¶...');
                const arrayBuffer = await file.arrayBuffer();
                const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
                text = result.value;
            } else {
                alert('ç›®å‰åƒ…æ”¯æ´åœ–ç‰‡èˆ‡ Word æª”');
                hideLoading();
                return;
            }
            
            app.processScannedText(text);
        } catch (e) {
            console.error(e);
            alert('è§£æå¤±æ•—ï¼š' + e.message);
        } finally {
            hideLoading();
            input.value = ''; // Reset input
        }
    },

    // 2. Parse Text Heuristics (Enhanced)
    processScannedText: (text) => {
        const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l);
        
        let name = lines[0] || "æœªå‘½åé£Ÿè­œ";
        const ingredientLines = [];
        const stepLines = [];

        // Logic: Ingredients usually have numbers and are short. Steps are longer and follow ingredients.
        let mode = 'ingredients'; // start guessing as ingredients
        
        for (let i = 1; i < lines.length; i++) {
            const line = lines[i];
            const hasUnit = appState.units.some(u => line.includes(u.name));
            const hasNumber = /\d/.test(line);
            
            // Heuristic switch
            if (mode === 'ingredients') {
                if (line.length > 20 && !hasUnit && !hasNumber) {
                    mode = 'steps'; // Switch to steps if line is long and no numbers
                    stepLines.push(line);
                } else {
                    ingredientLines.push(line);
                }
            } else {
                stepLines.push(line);
            }
        }
        
        getEl('scan-raw-text').textContent = text;
        getEl('scan-name').value = name;
        getEl('scan-ingredients-text').value = ingredientLines.join('\n');
        getEl('scan-steps-text').value = stepLines.join('\n');
        
        getEl('modal-scan').classList.add('active');
    },

    closeScanModal: () => { getEl('modal-scan').classList.remove('active'); },

    // 3. Import from Scan (Updated for Steps)
    confirmScanImport: () => {
        const name = getEl('scan-name').value;
        const rawIng = getEl('scan-ingredients-text').value;
        const rawSteps = getEl('scan-steps-text').value;
        const baseServings = parseFloat(getEl('scan-servings').value) || 1;
        
        // Parse Ingredients
        const lines = rawIng.split('\n');
        const parsedIngredients = [];
        
        lines.forEach(line => {
            const match = line.match(/(\d+(\.\d+)?)/); 
            let amount = 0;
            let ingName = line;
            let unitId = appState.units[0].id; 
            
            if (match) {
                amount = parseFloat(match[0]);
                ingName = line.replace(match[0], '').trim(); 
                const foundUnit = appState.units.find(u => line.includes(u.name));
                if (foundUnit) {
                    unitId = foundUnit.id;
                    ingName = ingName.replace(foundUnit.name, '').trim(); 
                }
            }
            let ingId = null;
            const existingIng = appState.ingredients.find(i => i.name === ingName);
            if (existingIng) { ingId = existingIng.id; } 
            else { ingId = uuid(); appState.ingredients.push({ id: ingId, name: ingName || "æœªå‘½åé£Ÿæ", price: 0, unitId: unitId }); }
            if (ingName) parsedIngredients.push({ ingredientId: ingId, amount: amount });
        });

        // Parse Steps (Simple split)
        const parsedSteps = rawSteps.split('\n').map(s => s.trim()).filter(s => s);

        const newRecipe = {
            id: uuid(),
            name: name,
            baseServings: baseServings,
            categoryId: 'default',
            image: null,
            ingredients: parsedIngredients,
            steps: parsedSteps // New Field
        };

        appState.recipes.push(newRecipe);
        storage.save();
        app.closeScanModal();
        toast('åŒ¯å…¥æˆåŠŸï¼');
        editingRecipeId = newRecipe.id;
        app.navTo('edit');
    },

    // --- Original Navigation & Logic ---
    navTo: (viewName) => {
        document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('nav button').forEach(el => el.classList.remove('active'));
        const target = getEl(`view-${viewName}`);
        if(target) target.classList.add('active');
        if (viewName === 'list' || viewName === 'detail') getEl('nav-list').classList.add('active');
        if (['settings', 'categories', 'io'].includes(viewName)) getEl('nav-settings').classList.add('active');
        
        if (viewName === 'list') app.renderRecipeList();
        if (viewName === 'settings') app.renderSettings();
        if (viewName === 'categories') app.renderCategories();
        if (viewName === 'edit' && editingRecipeId === null) app.initEditForm(); 
        setTimeout(attachRippleEffect, 100);
        window.scrollTo(0,0);
    },

    renderCategories: () => {
        const list = getEl('category-manage-list'); list.innerHTML = '';
        appState.categories.forEach(c => {
            const div = document.createElement('div'); div.className = 'settings-item';
            div.innerHTML = `<span style="font-weight:700; color:var(--accent-pink);">${c.name}</span><button class="btn btn-sm btn-danger ripple-btn" onclick="app.deleteCategory('${c.id}')">åˆªé™¤</button>`;
            list.appendChild(div);
        });
        attachRippleEffect();
    },
    addCategory: () => {
        const name = getEl('cat-manage-name').value.trim(); if (!name) return;
        appState.categories.push({ id: uuid(), name }); getEl('cat-manage-name').value = ''; storage.save(); app.renderCategories();
    },
    deleteCategory: (id) => {
        if (appState.recipes.some(r => r.categoryId === id)) { alert('ç„¡æ³•åˆªé™¤ï¼šæœ‰é£Ÿè­œæ­£åœ¨ä½¿ç”¨æ­¤åˆ†é¡ã€‚'); return; }
        if (confirm('ç¢ºå®šåˆªé™¤æ­¤åˆ†é¡ï¼Ÿ')) { appState.categories = appState.categories.filter(c => c.id !== id); storage.save(); app.renderCategories(); }
    },
    filterCategory: (catId, btn) => {
        currentCategoryFilter = catId;
        document.querySelectorAll('.cat-chip').forEach(el => el.classList.remove('active'));
        btn.classList.add('active'); app.renderRecipeList(getEl('search-input').value);
    },
    handleSearch: () => { app.renderRecipeList(getEl('search-input').value); },
    renderRecipeList: (keyword = '') => {
        const catList = getEl('category-filter-list');
        let html = `<div class="cat-chip ${currentCategoryFilter === 'all' ? 'active' : ''} ripple-btn" onclick="app.filterCategory('all', this)">å…¨éƒ¨</div>`;
        html += `<div class="cat-chip ${currentCategoryFilter === 'uncategorized' ? 'active' : ''} ripple-btn" onclick="app.filterCategory('uncategorized', this)">æœªåˆ†é¡</div>`;
        appState.categories.forEach(c => { html += `<div class="cat-chip ${currentCategoryFilter === c.id ? 'active' : ''} ripple-btn" onclick="app.filterCategory('${c.id}', this)">${c.name}</div>`; });
        catList.innerHTML = html;

        const list = getEl('recipe-list-container'); list.innerHTML = '';
        let filtered = appState.recipes.filter(r => r.name.toLowerCase().includes(keyword.toLowerCase()));
        if (currentCategoryFilter !== 'all') {
            if (currentCategoryFilter === 'uncategorized') filtered = filtered.filter(r => !r.categoryId || r.categoryId === 'default');
            else filtered = filtered.filter(r => r.categoryId === currentCategoryFilter);
        }
        if (filtered.length === 0) { list.innerHTML = `<div class="empty-state">${keyword ? 'æ‰¾ä¸åˆ°ç¬¦åˆçš„é£Ÿè­œã€‚' : 'å°šç„¡æ­¤åˆ†é¡é£Ÿè­œã€‚'}</div>`; return; }

        filtered.forEach(r => {
            const div = document.createElement('div'); div.className = 'card'; 
            div.onclick = (e) => { createRipple(e); setTimeout(() => app.openDetail(r.id), 200); };
            const cat = appState.categories.find(c => c.id === r.categoryId);
            const catName = cat ? cat.name : '';
            div.innerHTML = `<img src="${r.image || CONSTANTS.IMG_PLACEHOLDER}" class="card-img" loading="lazy"><div class="card-content"><div class="card-title">${r.name}</div><div class="card-subtitle">${catName ? `<span style="color:var(--accent-pink); margin-right:5px;">[${catName}]</span>` : ''} ${r.baseServings}äºº â€¢ ${r.ingredients.length}é£Ÿæ</div></div><div style="color:var(--accent-pink); font-size:1.5rem; font-weight:800;">â€º</div>`;
            list.appendChild(div);
        });
        attachRippleEffect();
    },
    
    // --- Detail View Logic (Updated for Steps) ---
    openDetail: (id) => {
        currentDetailRecipeId = id; const r = appState.recipes.find(x => x.id === id); if (!r) return;
        getEl('detail-title').textContent = r.name;
        const cat = appState.categories.find(c => c.id === r.categoryId);
        getEl('detail-category-badge').textContent = cat ? cat.name : '';
        getEl('detail-category-badge').style.display = cat ? 'block' : 'none';
        getEl('detail-base-servings').textContent = r.baseServings;
        getEl('detail-image').src = r.image || CONSTANTS.IMG_PLACEHOLDER;
        getEl('target-servings').value = r.baseServings; 
        
        // Render Steps
        const stepsContainer = getEl('detail-steps-container');
        stepsContainer.innerHTML = '';
        if (r.steps && r.steps.length > 0) {
            r.steps.forEach((step, index) => {
                const div = document.createElement('div');
                div.className = 'step-item';
                div.innerHTML = `<div class="step-number">${index + 1}</div><div class="step-text">${step}</div>`;
                stepsContainer.appendChild(div);
            });
        } else {
            stepsContainer.innerHTML = '<div class="empty-state" style="padding: 20px;">å°šç„¡æ­¥é©ŸæŒ‡å¼•</div>';
        }

        app.renderDetailCalculation(); app.navTo('detail');
    },
    renderDetailCalculation: () => {
        const r = appState.recipes.find(x => x.id === currentDetailRecipeId); if (!r) return;
        const target = parseFloat(getEl('target-servings').value) || 0; const ratio = target / r.baseServings;
        const tbody = getEl('detail-table').querySelector('tbody'); tbody.innerHTML = ''; let totalCost = 0;
        r.ingredients.forEach(ri => {
            const ingDef = appState.ingredients.find(i => i.id === ri.ingredientId); if (!ingDef) return; 
            const unitDef = appState.units.find(u => u.id === ingDef.unitId);
            const amount = ri.amount * ratio; const cost = amount * ingDef.price; totalCost += cost;
            const tr = document.createElement('tr');
            tr.innerHTML = `<td style="font-weight:700; color:var(--text-primary);">${ingDef.name}</td><td>${Number.isInteger(amount) ? amount : amount.toFixed(1)}</td><td style="color:var(--text-secondary);">${unitDef ? unitDef.name : '?'}</td><td class="text-right price">${cost.toFixed(2)}</td>`;
            tbody.appendChild(tr);
        });
        getEl('detail-total-cost').textContent = totalCost.toFixed(2);
    },
    deleteCurrentRecipe: () => { if(confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹é£Ÿè­œå—ï¼Ÿ')) { appState.recipes = appState.recipes.filter(r => r.id !== currentDetailRecipeId); storage.save(); toast('åˆªé™¤æˆåŠŸ'); app.navTo('list'); } },
    
    // --- Edit Recipe Logic (Updated for Steps) ---
    editCurrentRecipe: () => { editingRecipeId = currentDetailRecipeId; app.initEditForm(); app.navTo('edit'); },
    initEditForm: () => {
        const title = getEl('edit-view-title'); const list = getEl('edit-ingredients-list'); const stepsList = getEl('edit-steps-list'); const catSelect = getEl('edit-category');
        catSelect.innerHTML = '<option value="default">æœªåˆ†é¡</option>'; appState.categories.forEach(c => { catSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`; });
        list.innerHTML = ''; stepsList.innerHTML = '';
        
        if (editingRecipeId) {
            const r = appState.recipes.find(x => x.id === editingRecipeId); title.textContent = "ç·¨è¼¯é£Ÿè­œ";
            getEl('edit-name').value = r.name; getEl('edit-base-servings').value = r.baseServings; catSelect.value = r.categoryId || 'default';
            if (r.image) { getEl('edit-image-preview').src = r.image; getEl('edit-image-preview-container').classList.remove('hidden'); } else { app.clearImage(); }
            r.ingredients.forEach(item => { app.addIngredientRow(item.ingredientId, item.amount); });
            // Load Steps
            if(r.steps) r.steps.forEach(step => app.addStepRow(step));
            else app.addStepRow();
        } else { 
            title.textContent = "æ–°å¢é£Ÿè­œ"; getEl('edit-name').value = ''; getEl('edit-base-servings').value = 4; catSelect.value = 'default'; 
            app.clearImage(); app.addIngredientRow(); app.addStepRow();
        }
    },
    addIngredientRow: (selectedId = '', amount = '') => {
        const container = getEl('edit-ingredients-list'); const div = document.createElement('div'); div.className = 'ingredient-row';
        let options = '<option value="" disabled selected>é¸æ“‡é£Ÿæ</option>';
        appState.ingredients.forEach(ing => { const unit = appState.units.find(u => u.id === ing.unitId); const selected = ing.id === selectedId ? 'selected' : ''; options += `<option value="${ing.id}" ${selected}>${ing.name} (${unit ? unit.name : ''})</option>`; });
        div.innerHTML = `<select class="ing-select" style="margin-bottom:0;">${options}</select><input type="number" class="ing-amount" placeholder="æ•¸é‡" value="${amount}" step="any" style="margin-bottom:0;"><button class="btn btn-danger ripple-btn" onclick="this.parentElement.remove()">Ã—</button>`;
        container.appendChild(div); attachRippleEffect();
    },
    // New: Add Step Row
    addStepRow: (text = '') => {
        const container = getEl('edit-steps-list');
        const div = document.createElement('div'); div.className = 'step-row';
        div.innerHTML = `
            <textarea class="step-input" placeholder="è¼¸å…¥æ­¥é©Ÿèªªæ˜..." style="flex:1;" rows="2">${text}</textarea>
            <button class="btn btn-danger ripple-btn" onclick="this.parentElement.remove()">Ã—</button>
        `;
        container.appendChild(div); attachRippleEffect();
    },

    handleImageUpload: async (input) => { if (input.files && input.files[0]) { try { const base64 = await resizeImage(input.files[0]); getEl('edit-image-preview').src = base64; getEl('edit-image-preview-container').classList.remove('hidden'); } catch (e) { alert('åœ–ç‰‡è™•ç†å¤±æ•—'); } } },
    clearImage: () => { getEl('edit-image-input').value = ''; getEl('edit-image-preview').src = ''; getEl('edit-image-preview-container').classList.add('hidden'); },
    
    saveRecipe: () => {
        const name = getEl('edit-name').value.trim(); const baseServings = parseFloat(getEl('edit-base-servings').value); const categoryId = getEl('edit-category').value;
        if (!name || !baseServings) { alert('è«‹å¡«å¯«é£Ÿè­œåç¨±èˆ‡åŸºæº–ä»½æ•¸'); return; }
        
        // Save Ingredients
        const rows = document.querySelectorAll('.ingredient-row'); const ingredients = [];
        for (let row of rows) { const id = row.querySelector('.ing-select').value; const amount = parseFloat(row.querySelector('.ing-amount').value); if (id && amount) ingredients.push({ ingredientId: id, amount: amount }); }
        
        // Save Steps
        const stepRows = document.querySelectorAll('.step-input'); const steps = [];
        for (let input of stepRows) { if(input.value.trim()) steps.push(input.value.trim()); }

        const imgData = getEl('edit-image-preview').getAttribute('src'); const finalImg = (imgData && imgData.startsWith('data:')) ? imgData : null;
        const newRecipe = { id: editingRecipeId || uuid(), name, baseServings, categoryId, image: finalImg, ingredients, steps };
        
        if (editingRecipeId) { const idx = appState.recipes.findIndex(r => r.id === editingRecipeId); appState.recipes[idx] = newRecipe; } else { appState.recipes.push(newRecipe); }
        storage.save(); toast('é£Ÿè­œå·²å„²å­˜'); editingRecipeId = null; app.navTo('list');
    },
    
    // --- Settings & Ingredients ---
    renderSettings: () => {
        const unitSelect = getEl('setting-ing-unit'); unitSelect.innerHTML = ''; appState.units.forEach(u => { unitSelect.innerHTML += `<option value="${u.id}">${u.name}</option>`; });
        const unitList = getEl('settings-unit-list'); unitList.innerHTML = ''; appState.units.forEach(u => { const div = document.createElement('div'); div.className = 'settings-item'; div.innerHTML = `<span style="font-weight:700; color:var(--accent-pink);">${u.name}</span> <button class="btn btn-sm btn-danger ripple-btn" onclick="app.deleteUnit('${u.id}')">åˆªé™¤</button>`; unitList.appendChild(div); });
        const ingList = getEl('settings-ing-list'); ingList.innerHTML = ''; appState.ingredients.forEach(i => {
            const u = appState.units.find(unit => unit.id === i.unitId); const div = document.createElement('div'); div.className = 'settings-item editable'; 
            div.onclick = (e) => { if(e.target.tagName !== 'BUTTON') app.selectIngredientForEdit(i.id); };
            div.innerHTML = `<div style="flex:1"><strong style="font-size:1.1rem;">${i.name}</strong><br><small style="color:var(--text-secondary);">$${i.price} / ${u ? u.name : '?'}</small></div><button class="btn btn-sm btn-danger ripple-btn" onclick="app.deleteIngredient('${i.id}')">åˆªé™¤</button>`;
            ingList.appendChild(div);
        });
        attachRippleEffect();
    },
    selectIngredientForEdit: (id) => {
        const ing = appState.ingredients.find(i => i.id === id); if (!ing) return;
        editingIngredientId = id; getEl('setting-ing-name').value = ing.name; getEl('setting-ing-price').value = ing.price; getEl('setting-ing-unit').value = ing.unitId;
        getEl('btn-save-ing').textContent = 'æ›´æ–°é£Ÿæ'; getEl('btn-save-ing').classList.remove('btn-primary'); getEl('btn-save-ing').classList.add('btn-edit-mode');
        getEl('btn-cancel-ing-edit').classList.remove('hidden'); getEl('ingredient-form-card').classList.add('editing-mode-box'); getEl('ingredient-form-card').scrollIntoView({ behavior: 'smooth', block: 'center' });
    },
    cancelEditIngredient: () => {
        editingIngredientId = null; getEl('setting-ing-name').value = ''; getEl('setting-ing-price').value = '';
        getEl('btn-save-ing').textContent = 'æ–°å¢é£Ÿæ'; getEl('btn-save-ing').classList.add('btn-primary'); getEl('btn-save-ing').classList.remove('btn-edit-mode');
        getEl('btn-cancel-ing-edit').classList.add('hidden'); getEl('ingredient-form-card').classList.remove('editing-mode-box');
    },
    saveIngredient: () => {
        const name = getEl('setting-ing-name').value.trim(); const price = parseFloat(getEl('setting-ing-price').value); const unitId = getEl('setting-ing-unit').value;
        if (!name || isNaN(price) || !unitId) { alert('è«‹å®Œæ•´å¡«å¯«è³‡è¨Šã€‚'); return; }
        if (editingIngredientId) { const idx = appState.ingredients.findIndex(i => i.id === editingIngredientId); if (idx !== -1) { appState.ingredients[idx] = { id: editingIngredientId, name, price, unitId }; toast('é£Ÿæå·²æ›´æ–°'); } }
        else { appState.ingredients.push({ id: uuid(), name, price, unitId }); toast('å¸‚åƒ¹è¡¨å·²æ›´æ–°'); }
        storage.save(); app.cancelEditIngredient(); app.renderSettings();
    },
    addIngredient: () => app.saveIngredient(),
    addUnit: () => { const name = getEl('setting-unit-name').value.trim(); if (!name) return; appState.units.push({ id: uuid(), name }); getEl('setting-unit-name').value = ''; storage.save(); app.renderSettings(); },
    deleteUnit: (id) => { if (appState.ingredients.some(i => i.unitId === id)) { alert('ç„¡æ³•åˆªé™¤ï¼šæœ‰é£Ÿææ­£åœ¨ä½¿ç”¨æ­¤å–®ä½ã€‚'); return; } if (confirm('ç¢ºå®šåˆªé™¤æ­¤å–®ä½ï¼Ÿ')) { appState.units = appState.units.filter(u => u.id !== id); storage.save(); app.renderSettings(); } },
    deleteIngredient: (id) => { if (editingIngredientId === id) app.cancelEditIngredient(); let usedIn = []; appState.recipes.forEach(r => { if (r.ingredients.some(ri => ri.ingredientId === id)) usedIn.push(r.name); }); if (usedIn.length > 0) { alert(`ç„¡æ³•åˆªé™¤ï¼šä»¥ä¸‹é£Ÿè­œæ­£åœ¨ä½¿ç”¨æ­¤é£Ÿæ\n${usedIn.join(', ')}`); return; } if (confirm('ç¢ºå®šåˆªé™¤æ­¤é£Ÿæï¼Ÿ')) { appState.ingredients = appState.ingredients.filter(i => i.id !== id); storage.save(); app.renderSettings(); } },
    exportData: () => { getEl('io-textarea').value = JSON.stringify(appState, null, 2); },
    importData: () => { try { const data = JSON.parse(getEl('io-textarea').value); if (!data.units || !data.recipes) throw new Error(); if (confirm('ç¢ºå®šé‚„åŸï¼Ÿ')) { appState = data; storage.save(); toast('é‚„åŸæˆåŠŸ'); app.navTo('list'); } } catch (e) { alert('æ ¼å¼éŒ¯èª¤'); } }
};

document.addEventListener('DOMContentLoaded', () => { app.init(); attachRippleEffect(); });
</script>
</body>
</html>
