<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£Ÿè­œç®¡å®¶ | Ultimate Fixed Version</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>

    <style>
        /* --- 1. Design Tokens --- */
        :root {
            --bg-morandi: #F2EAE4; --text-primary: #5E5451; --text-secondary: #8C8380;
            --accent-pink: #D48A96; --danger: #C47070; --success: #789c79;
            --neu-light: #FFFFFF; --neu-dark: #D3C6BC;
            --shadow-flat: 10px 10px 20px var(--neu-dark), -10px -10px 20px var(--neu-light);
            --shadow-hover: 14px 14px 28px var(--neu-dark), -14px -14px 28px var(--neu-light);
            --shadow-pressed: inset 6px 6px 12px var(--neu-dark), inset -6px -6px 12px var(--neu-light);
            --radius-xl: 28px; --radius-pill: 50px;
            --font-main: 'Nunito', "PingFang TC", "Microsoft JhengHei", sans-serif;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        body { margin: 0; font-family: var(--font-main); background-color: var(--bg-morandi); color: var(--text-primary); padding-bottom: 130px; line-height: 1.7; }
        .container { max-width: 700px; margin: 0 auto; padding: 30px 24px; }
        header { background: var(--bg-morandi); padding: 16px 24px; position: sticky; top: 0; z-index: 100; display: flex; justify-content: center; align-items: center; border-radius: 0 0 var(--radius-xl) var(--radius-xl); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        h1 { margin: 0; font-size: 1.4rem; color: var(--accent-pink); font-weight: 800; }
        
        /* UI Elements */
        .card { background: var(--bg-morandi); border-radius: var(--radius-xl); padding: 24px; margin-bottom: 28px; box-shadow: var(--shadow-flat); display: flex; align-items: center; gap: 20px; transition: 0.3s; cursor: pointer; }
        .card:active { box-shadow: var(--shadow-pressed); transform: scale(0.98); }
        .card-img { width: 72px; height: 72px; border-radius: 50%; object-fit: cover; box-shadow: var(--shadow-pressed); padding: 4px; background: var(--bg-morandi); flex-shrink: 0; }
        .card-content { flex: 1; overflow: hidden; }
        .card-title { font-weight: 700; font-size: 1.25rem; margin-bottom: 8px; }
        .card-subtitle { font-size: 0.9rem; color: var(--text-secondary); }
        
        input, select, textarea { width: 100%; padding: 16px 24px; margin-bottom: 28px; border: none; border-radius: var(--radius-pill); background: var(--bg-morandi); color: var(--text-primary); box-shadow: var(--shadow-pressed); font-size: 1rem; }
        textarea { border-radius: var(--radius-xl); resize: vertical; }
        label { display: block; margin-bottom: 10px; font-size: 0.9rem; color: var(--accent-pink); font-weight: 700; margin-left: 16px; }
        
        .btn { padding: 14px 28px; border: none; border-radius: var(--radius-pill); background: var(--bg-morandi); color: var(--text-primary); box-shadow: var(--shadow-flat); font-weight: 700; transition: 0.3s; cursor: pointer; display: inline-flex; justify-content: center; align-items: center; }
        .btn:active { box-shadow: var(--shadow-pressed); transform: scale(0.96); }
        .btn-primary { color: var(--accent-pink); } .btn-danger { color: var(--danger); }
        .btn-outline { box-shadow: 5px 5px 10px var(--neu-dark), -5px -5px 10px var(--neu-light); color: var(--text-secondary); }
        .btn-edit-mode { background: var(--text-secondary); color: white; } /* ç·¨è¼¯æ¨¡å¼æŒ‰éˆ•æ¨£å¼ */
        
        .btn-block { width: 100%; display: flex; margin-bottom: 16px; }
        .btn-sm { padding: 10px 20px; font-size: 0.9rem; }
        .fab { position: fixed; bottom: 100px; right: 28px; width: 60px; height: 60px; border-radius: 50%; background: var(--bg-morandi); color: var(--accent-pink); font-size: 1.8rem; box-shadow: var(--shadow-flat); border: none; display: flex; align-items: center; justify-content: center; z-index: 90; transition: 0.3s; }
        
        nav { position: fixed; bottom: 20px; left: 20px; right: 20px; width: auto; background: var(--bg-morandi); border-radius: var(--radius-pill); box-shadow: 6px 6px 12px var(--neu-dark), -6px -6px 12px var(--neu-light); display: flex; justify-content: space-around; padding: 8px 20px; z-index: 100; }
        nav button { background: none; border: none; color: var(--text-secondary); display: flex; flex-direction: column; align-items: center; padding: 6px 20px; font-size: 0.8rem; font-weight: 600; }
        nav button.active { color: var(--accent-pink); text-shadow: 0 0 1px currentColor; }
        nav button svg { width: 24px; height: 24px; margin-bottom: 4px; fill: currentColor; }

        /* Helpers */
        .hidden { display: none !important; }
        .view { display: none; animation: fadeIn 0.4s; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .cat-chip { padding: 8px 20px; border-radius: var(--radius-pill); background: var(--bg-morandi); color: var(--text-secondary); box-shadow: 5px 5px 10px var(--neu-dark), -5px -5px 10px var(--neu-light); margin-right: 12px; display: inline-block; font-weight: 700; font-size: 0.9rem; cursor: pointer; }
        .cat-chip.active { color: var(--accent-pink); box-shadow: inset 3px 3px 6px var(--neu-dark), inset -3px -3px 6px var(--neu-light); }
        .category-scroll { overflow-x: auto; white-space: nowrap; padding: 10px 4px 20px 4px; scrollbar-width: none; }

        /* Step Items */
        .step-item { background: var(--bg-morandi); padding:15px; margin-bottom:15px; border-radius:15px; box-shadow:var(--shadow-flat); display:flex; gap:10px; }
        .step-num { background:var(--accent-pink); color:white; width:25px; height:25px; border-radius:50%; display:flex; justify-content:center; align-items:center; flex-shrink:0; font-size: 0.8rem; }

        /* Settings specific */
        .entry-block { margin-top: 20px; padding: 20px; border: 2px dashed rgba(140, 131, 128, 0.2); border-radius: var(--radius-xl); text-align: center; }
        .settings-item { background: var(--bg-morandi); box-shadow: 5px 5px 10px var(--neu-dark), -5px -5px 10px var(--neu-light); border-radius: var(--radius-xl); padding: 16px 24px; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        
        /* ç·¨è¼¯æ¨¡å¼çš„é«˜äº®æ¨£å¼ */
        .editing-mode-box { border: 2px solid var(--accent-pink); position: relative; }
        .editing-mode-box::after { content: 'ç·¨è¼¯ä¸­'; position: absolute; top: -12px; left: 20px; background: var(--accent-pink); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; font-weight: bold; }

        #toast { visibility: hidden; min-width: 260px; background-color: var(--bg-morandi); color: var(--accent-pink); text-align: center; border-radius: var(--radius-pill); padding: 18px 28px; position: fixed; z-index: 200; left: 50%; bottom: 100px; transform: translateX(-50%); font-weight: 700; box-shadow: var(--shadow-flat); }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 80px; opacity: 0;} to {bottom: 100px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 100px; opacity: 1;} to {bottom: 80px; opacity: 0;} }

        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 3000; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; font-weight: bold; backdrop-filter: blur(4px); }
        
        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(242, 234, 228, 0.9); z-index: 2000; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: 0.3s; }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-content { width: 90%; max-width: 500px; max-height: 85vh; background: var(--bg-morandi); border-radius: var(--radius-xl); box-shadow: 20px 20px 60px var(--neu-dark); display: flex; flex-direction: column; overflow: hidden; }
        .modal-body { padding: 24px; overflow-y: auto; }
    </style>
</head>
<body>

<header>
    <h1 id="header-title">é£Ÿè­œç®¡å®¶</h1>
</header>

<div class="container">
    <div id="view-list" class="view active">
        <div class="category-scroll" id="category-filter-list"></div>
        <div style="position:relative; margin-bottom: 24px;">
            <input type="text" id="search-input" placeholder="æœå°‹æ‚¨çš„é£Ÿè­œ..." oninput="app.handleSearch()">
        </div>
        <div class="btn-block" style="border: 2px dashed #ccc; border-radius: 20px; padding: 10px; justify-content: center; cursor: pointer;" onclick="document.getElementById('scan-file-input').click()">
            <span style="color: var(--text-secondary); font-weight: 700;">ğŸ“· æ™ºæ…§åŒ¯å…¥ (OCR/Word)</span>
            <input type="file" id="scan-file-input" accept=".jpg,.jpeg,.png,.docx" style="display: none;" onchange="app.handleFileScan(this)">
        </div>
        <div id="recipe-list-container"></div>
        <button class="fab" onclick="app.navTo('edit')">ï¼‹</button>
    </div>

    <div id="view-detail" class="view">
        <div style="text-align:center; padding: 20px;">
            <img id="detail-image" src="" style="width:180px; height:180px; border-radius:50%; object-fit:cover; border: 8px solid var(--bg-morandi); box-shadow: inset 6px 6px 12px var(--neu-dark), inset -6px -6px 12px var(--neu-light);">
        </div>
        <div style="text-align:center; margin-bottom:20px;">
            <h2 id="detail-title" style="margin:0;">é£Ÿè­œåç¨±</h2>
            <div id="detail-category-badge" style="color:var(--accent-pink); font-weight:700; margin-top:5px;">åˆ†é¡</div>
        </div>
        
        <div style="display:flex; justify-content:center; gap:10px; margin-bottom:30px;">
            <button class="btn btn-sm" onclick="app.editCurrentRecipe()">ç·¨è¼¯</button>
            <button class="btn btn-sm btn-danger" onclick="app.deleteCurrentRecipe()">åˆªé™¤</button>
        </div>

        <div style="background:var(--bg-morandi); padding:24px; border-radius:var(--radius-xl); box-shadow:inset 6px 6px 12px var(--neu-dark), inset -6px -6px 12px var(--neu-light); margin-bottom:30px;">
            <label style="text-align:center;">ç›®æ¨™ä»½æ•¸ (åŸºæº–: <span id="detail-base-servings"></span>äºº)</label>
            <div style="display:flex; justify-content:center; gap:10px;">
                <input type="number" id="target-servings" value="1" min="1" style="width:100px; text-align:center; margin-bottom:0;">
                <button class="btn btn-primary" onclick="app.renderDetailCalculation()">è¨ˆç®—</button>
            </div>
            <div style="margin-top:20px; display:flex; justify-content:space-between; border-top:1px solid #ddd; padding-top:15px;">
                <span style="font-weight:700; color:var(--text-secondary);">é ä¼°ç¸½æˆæœ¬</span>
                <span id="detail-total-cost" style="color:var(--accent-pink); font-weight:800; font-size:1.5rem;">0.00</span>
            </div>
        </div>

        <h3>é£Ÿææ˜ç´°</h3>
        <div id="detail-ingredients-list" style="margin-bottom:30px;"></div>

        <h3>è£½ä½œæ­¥é©Ÿ</h3>
        <div id="detail-steps-list" style="margin-bottom:40px;"></div>

        <button class="btn btn-block" onclick="app.navTo('list')">è¿”å›åˆ—è¡¨</button>
    </div>

    <div id="view-edit" class="view">
        <h2 id="edit-view-title">é£Ÿè­œç·¨è¼¯</h2>
        <label>åç¨±</label><input type="text" id="edit-name">
        <label>åˆ†é¡</label><select id="edit-category"></select>
        <label>åŸºæº–ä»½æ•¸</label><input type="number" id="edit-base-servings">
        
        <label>é£Ÿæ</label>
        <div id="edit-ingredients-list"></div>
        <button class="btn btn-sm" onclick="app.addIngredientRow()" style="margin-bottom:20px;">+ åŠ å…¥é£Ÿæ</button>

        <label>æ­¥é©Ÿ</label>
        <div id="edit-steps-list"></div>
        <button class="btn btn-sm" onclick="app.addStepRow()" style="margin-bottom:30px;">+ åŠ å…¥æ­¥é©Ÿ</button>

        <div style="display:flex; gap:10px;">
            <button class="btn" style="flex:1" onclick="app.navTo('list')">å–æ¶ˆ</button>
            <button class="btn btn-primary" style="flex:1" onclick="app.saveRecipe()">å„²å­˜</button>
        </div>
    </div>

    <div id="view-settings" class="view">
        <h3>è³‡æ–™åº«ç®¡ç†</h3>
        
        <div style="margin-bottom:30px;">
            <label>æ–°å¢åˆ†é¡</label>
            <div style="display:flex; gap:10px;">
                <input type="text" id="setting-cat-name" placeholder="åˆ†é¡åç¨±" style="margin-bottom:0;">
                <button class="btn btn-primary" onclick="app.addCategory()">æ–°å¢</button>
            </div>
            <div id="settings-cat-list" style="margin-top:15px; display:flex; flex-wrap:wrap; gap:10px;"></div>
        </div>

        <div style="margin-bottom:30px;">
            <label>æ–°å¢/ç·¨è¼¯é£Ÿæ</label>
            <div id="ingredient-form-card" style="background:var(--bg-morandi); padding:20px; border-radius:var(--radius-xl); box-shadow:inset 6px 6px 12px var(--neu-dark), inset -6px -6px 12px var(--neu-light);">
                <input type="text" id="setting-ing-name" placeholder="é£Ÿæåç¨±">
                <div style="display:flex; gap:10px;">
                    <input type="number" id="setting-ing-price" placeholder="å–®åƒ¹">
                    <input type="text" id="setting-ing-unit" placeholder="å–®ä½ (å¦‚: g)">
                </div>
                <div style="display: flex; gap: 10px;">
                    <button id="btn-cancel-ing-edit" class="btn btn-outline hidden" style="flex:1" onclick="app.cancelEditIngredient()">å–æ¶ˆ</button>
                    <button id="btn-save-ing" class="btn btn-primary" style="flex:1" onclick="app.saveIngredient()">å„²å­˜é£Ÿæ</button>
                </div>
            </div>
            <div id="settings-ing-list" style="margin-top:20px;"></div>
        </div>

        <div class="entry-block">
            <button class="btn btn-outline btn-block" onclick="app.navTo('io')">â˜ï¸ é›²ç«¯è³‡æ–™åŒ¯å‡º / åŒ¯å…¥</button>
        </div>
    </div>

    <div id="view-categories" class="view">
        <h2>åˆ†é¡ç®¡ç†</h2>
        <div style="display:flex; gap:10px;">
            <input type="text" id="cat-manage-name" placeholder="åˆ†é¡åç¨±" style="margin-bottom:0;">
            <button class="btn btn-primary" onclick="app.addCategory()">æ–°å¢</button>
        </div>
        <div id="category-manage-list" style="margin-top:20px;"></div>
        <button class="btn btn-block" onclick="app.navTo('settings')" style="margin-top:20px;">è¿”å›è¨­å®š</button>
    </div>

    <div id="view-io" class="view">
        <h2>é›²ç«¯å‚™ä»½èˆ‡é‚„åŸ</h2>
        <p style="font-size:0.9rem; color:var(--text-secondary);">
            <b>åŒ¯å‡ºï¼š</b>å°‡é›²ç«¯æ‰€æœ‰é£Ÿè­œèˆ‡é£Ÿæä¸‹è¼‰ç‚ºä»£ç¢¼ã€‚<br>
            <b>åŒ¯å…¥ï¼š</b>å°‡ä»£ç¢¼ä¸Šå‚³è‡³é›²ç«¯ï¼Œä¸¦è¦†å¯«/æ–°å¢è³‡æ–™ã€‚
        </p>
        
        <label>è³‡æ–™ä»£ç¢¼ (JSON)</label>
        <textarea id="io-textarea" rows="12" style="font-family:monospace; font-size:0.8rem;"></textarea>
        
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn btn-outline" style="flex:1" onclick="app.exportData()">å¾é›²ç«¯åŒ¯å‡º</button>
            <button class="btn btn-danger" style="flex:1" onclick="app.importData()">åŒ¯å…¥è‡³é›²ç«¯</button>
        </div>
        <button class="btn btn-block" style="margin-top:20px;" onclick="app.navTo('settings')">è¿”å›è¨­å®š</button>
    </div>
</div>

<nav>
    <button onclick="app.navTo('list')" id="nav-list" class="active">
        <svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>é£Ÿè­œ
    </button>
    <button onclick="app.navTo('settings')" id="nav-settings">
        <svg viewBox="0 0 24 24"><path d="M17.21 9l-4.38-6.56a1 1 0 0 0-1.66 0L6.79 9H2v13a1 1 0 0 0 1 1h18a1 1 0 0 0 1-1V9h-4.79zM12 4.22L15.19 9H8.81L12 4.22zM20 21H4V11h16v10z"/></svg>è³‡æ–™åº«
    </button>
</nav>

<div id="loading-overlay" class="loading-overlay hidden">
    <div style="font-size:3rem;">â˜ï¸</div>
    <div id="loading-text" style="margin-top:10px;">è™•ç†ä¸­...</div>
</div>

<div id="modal-scan" class="modal-overlay">
    <div class="modal-content">
        <div style="padding:20px; border-bottom:1px solid #eee;"><h3>æ™ºæ…§åŒ¯å…¥é è¦½</h3></div>
        <div class="modal-body">
            <label>é£Ÿè­œåç¨±</label><input type="text" id="scan-name">
            <label>é£Ÿæ (æ¯è¡Œä¸€é …)</label><textarea id="scan-ingredients-text" style="height:100px;"></textarea>
            <label>æ­¥é©Ÿ (æ¯è¡Œä¸€é …)</label><textarea id="scan-steps-text" style="height:120px;"></textarea>
        </div>
        <div style="padding:20px; display:flex; gap:10px;">
            <button class="btn" style="flex:1" onclick="document.getElementById('modal-scan').classList.remove('active')">å–æ¶ˆ</button>
            <button class="btn btn-primary" style="flex:1" onclick="app.confirmScanImport()">åŒ¯å…¥</button>
        </div>
    </div>
</div>

<div id="toast">Message</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// TODO: REPLACE WITH YOUR CONFIG
const firebaseConfig = {
  apiKey: "AIzaSyBAwloed-9fPTOJmc4dlZptIN_lV9Kd7k8",
  authDomain: "cookbook-93de8.firebaseapp.com",
  projectId: "cookbook-93de8",
  storageBucket: "cookbook-93de8.firebasestorage.app",
  messagingSenderId: "443155806046",
  appId: "1:443155806046:web:16368ec4a8598a7aafc1cf",
  measurementId: "G-TJWN4KRCHT"
};

const firebaseApp = initializeApp(firebaseConfig);
const db = getFirestore(firebaseApp);

const CONSTANTS = { IMG_PLACEHOLDER: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2QzYzZiYyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iI2QzYzZiYyIvPjwvc3ZnPg==' };

let appState = { units: [], categories: [], ingredients: [], recipes: [] };
let editingRecipeId = null, currentDetailRecipeId = null, editingIngredientId = null, currentCatFilter = 'all', currentViewName = 'list';

const getEl = (id) => document.getElementById(id);
const uuid = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
const showLoading = (msg) => { getEl('loading-text').innerText = msg; getEl('loading-overlay').classList.remove('hidden'); };
const hideLoading = () => getEl('loading-overlay').classList.add('hidden');
const toast = (msg) => { const t = getEl('toast'); t.innerText = msg; t.className = 'show'; setTimeout(() => t.className = '', 3000); };

// Real-time Subscription
const subscribeToData = () => {
    showLoading('åŒæ­¥ä¸­...');
    let loadCount = 0; const check = () => { loadCount++; if(loadCount>=3) hideLoading(); };
    
    onSnapshot(collection(db, "categories"), (s) => { appState.categories = s.docs.map(d=>d.data()); if(currentViewName==='list'||currentViewName==='categories'||currentViewName==='settings') app.renderUI(); check(); });
    onSnapshot(collection(db, "ingredients"), (s) => { appState.ingredients = s.docs.map(d=>d.data()); if(currentViewName==='settings'||currentViewName==='detail') app.renderUI(); check(); });
    onSnapshot(collection(db, "recipes"), (s) => { 
        appState.recipes = s.docs.map(d=>d.data()); 
        if(currentViewName==='list') app.renderRecipeList(); 
        if(currentViewName==='detail' && currentDetailRecipeId) {
            const r = appState.recipes.find(x=>x.id===currentDetailRecipeId);
            if(r) app.openDetail(currentDetailRecipeId, false); else app.navTo('list');
        }
        check(); 
    });
    appState.units = [{id:'u1',name:'g'},{id:'u2',name:'ml'},{id:'u3',name:'å€‹'},{id:'u4',name:'å°æ–¤'}];
};

const dbApi = {
    async save(coll, data) { try { await setDoc(doc(db, coll, data.id), data); } catch(e) { console.error(e); toast('å„²å­˜å¤±æ•—'); } },
    async del(coll, id) { try { await deleteDoc(doc(db, coll, id)); } catch(e) { console.error(e); toast('åˆªé™¤å¤±æ•—'); } }
};

window.app = {
    init: () => { subscribeToData(); app.navTo('list'); attachRippleEffect(); },
    navTo: (viewName) => {
        currentViewName = viewName;
        document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('nav button').forEach(el => el.classList.remove('active'));
        getEl(`view-${viewName}`).classList.add('active');
        if(['list','detail'].includes(viewName)) getEl('nav-list').classList.add('active');
        if(['settings','categories','io'].includes(viewName)) getEl('nav-settings').classList.add('active');
        app.renderUI();
        window.scrollTo(0,0);
    },
    renderUI: () => {
        if(currentViewName === 'list') app.renderRecipeList();
        if(currentViewName === 'settings') app.renderSettings();
        if(currentViewName === 'categories') app.renderCategories();
        if(currentViewName === 'detail' && currentDetailRecipeId) app.renderDetailCalculation();
    },

    // --- List ---
    filterCategory: (id, btn) => { currentCatFilter = id; document.querySelectorAll('.cat-chip').forEach(c=>c.classList.remove('active')); btn.classList.add('active'); app.renderRecipeList(); },
    handleSearch: () => app.renderRecipeList(),
    renderRecipeList: () => {
        const keyword = getEl('search-input').value.toLowerCase();
        const listEl = getEl('recipe-list-container');
        const catListEl = getEl('category-filter-list');
        
        let catHtml = `<div class="cat-chip ${currentCatFilter==='all'?'active':''}" onclick="app.filterCategory('all', this)">å…¨éƒ¨</div>`;
        catHtml += `<div class="cat-chip ${currentCatFilter==='uncategorized'?'active':''}" onclick="app.filterCategory('uncategorized', this)">æœªåˆ†é¡</div>`;
        appState.categories.forEach(c => { catHtml += `<div class="cat-chip ${currentCatFilter===c.id?'active':''}" onclick="app.filterCategory('${c.id}', this)">${c.name}</div>`; });
        catListEl.innerHTML = catHtml;

        let filtered = appState.recipes.filter(r => r.name.toLowerCase().includes(keyword));
        if(currentCatFilter !== 'all') {
            if(currentCatFilter === 'uncategorized') filtered = filtered.filter(r => !r.categoryId || r.categoryId === 'default');
            else filtered = filtered.filter(r => r.categoryId === currentCatFilter);
        }
        
        listEl.innerHTML = '';
        if(filtered.length === 0) { listEl.innerHTML = '<div style="text-align:center; color:#999; margin-top:50px;">ç„¡ç¬¦åˆé£Ÿè­œ</div>'; return; }
        filtered.forEach(r => {
            const div = document.createElement('div'); div.className = 'card';
            div.onclick = () => app.openDetail(r.id);
            const cat = appState.categories.find(c => c.id === r.categoryId);
            div.innerHTML = `<img src="${r.image || CONSTANTS.IMG_PLACEHOLDER}" class="card-img" loading="lazy"><div class="card-content"><div class="card-title">${r.name}</div><div class="card-subtitle"><span style="color:var(--accent-pink)">${cat?cat.name:'æœªåˆ†é¡'}</span> â€¢ ${r.baseServings}äººä»½</div></div><div style="font-size:1.5rem; color:var(--accent-pink);">â€º</div>`;
            listEl.appendChild(div);
        });
    },

    // --- Detail ---
    openDetail: (id, doNav=true) => {
        currentDetailRecipeId = id; const r = appState.recipes.find(x=>x.id===id); if(!r) return;
        getEl('detail-title').innerText = r.name;
        const cat = appState.categories.find(c=>c.id===r.categoryId);
        getEl('detail-category-badge').innerText = cat?cat.name:'æœªåˆ†é¡';
        getEl('detail-base-servings').innerText = r.baseServings;
        getEl('target-servings').value = r.baseServings;
        getEl('detail-image').src = r.image || CONSTANTS.IMG_PLACEHOLDER;
        
        const stepsDiv = getEl('detail-steps-list'); stepsDiv.innerHTML = '';
        if(r.steps && r.steps.length>0) r.steps.forEach((s,i)=>{
            const d = document.createElement('div'); d.className = 'step-item';
            d.innerHTML = `<div class="step-num">${i+1}</div><div style="flex:1;">${s}</div>`;
            stepsDiv.appendChild(d);
        }); else stepsDiv.innerHTML = '<div style="text-align:center; color:#999;">æš«ç„¡æ­¥é©Ÿ</div>';
        
        app.renderDetailCalculation();
        if(doNav) app.navTo('detail');
    },
    renderDetailCalculation: () => {
        const r = appState.recipes.find(x=>x.id===currentDetailRecipeId); if(!r) return;
        const ratio = parseFloat(getEl('target-servings').value) / r.baseServings;
        const listDiv = getEl('detail-ingredients-list'); listDiv.innerHTML = ''; let total = 0;
        r.ingredients.forEach(ri => {
            const ingDb = appState.ingredients.find(i=>i.id===ri.ingredientId); if(!ingDb) return;
            const cost = ri.amount * ratio * ingDb.price; total += cost;
            const d = document.createElement('div'); d.style.cssText = "display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #eee;";
            d.innerHTML = `<span>${ingDb.name} <small>(${(ri.amount*ratio).toFixed(1)}${ingDb.unit})</small></span><b>$${cost.toFixed(1)}</b>`;
            listDiv.appendChild(d);
        });
        getEl('detail-total-cost').innerText = total.toFixed(1);
    },
    deleteCurrentRecipe: () => { if(confirm('åˆªé™¤ï¼Ÿ')) dbApi.del("recipes", currentDetailRecipeId); },

    // --- Edit ---
    editCurrentRecipe: () => { editingRecipeId = currentDetailRecipeId; app.initEditForm(); app.navTo('edit'); },
    initEditForm: () => {
        const list = getEl('edit-ingredients-list'); const stepsList = getEl('edit-steps-list'); const catSel = getEl('edit-category');
        catSel.innerHTML = '<option value="">æœªåˆ†é¡</option>'; appState.categories.forEach(c => { catSel.innerHTML += `<option value="${c.id}">${c.name}</option>`; });
        list.innerHTML = ''; stepsList.innerHTML = '';
        if(editingRecipeId) {
            const r = appState.recipes.find(x=>x.id===editingRecipeId); getEl('edit-view-title').innerText = "ç·¨è¼¯é£Ÿè­œ";
            getEl('edit-name').value = r.name; getEl('edit-base-servings').value = r.baseServings; catSel.value = r.categoryId || '';
            if(r.image) { getEl('edit-image-preview').src = r.image; getEl('edit-image-preview-container').classList.remove('hidden'); } else app.clearImage();
            r.ingredients.forEach(i=>app.addIngredientRow(i.ingredientId, i.amount));
            if(r.steps) r.steps.forEach(s=>app.addStepRow(s)); else app.addStepRow();
        } else {
            getEl('edit-view-title').innerText = "æ–°å¢é£Ÿè­œ"; getEl('edit-name').value = ''; getEl('edit-base-servings').value = 4; catSel.value = '';
            app.clearImage(); app.addIngredientRow(); app.addStepRow();
        }
    },
    addIngredientRow: (selId='', val='') => {
        const div = document.createElement('div'); div.className = 'ingredient-row';
        let opts = '<option value="">é£Ÿæ</option>'; appState.ingredients.forEach(i => { opts += `<option value="${i.id}" ${i.id===selId?'selected':''}>${i.name}</option>`; });
        div.innerHTML = `<select class="ing-sel">${opts}</select><input type="number" class="ing-amt" value="${val}" placeholder="é‡"><button class="btn btn-danger" onclick="this.parentElement.remove()">X</button>`;
        getEl('edit-ingredients-list').appendChild(div);
    },
    addStepRow: (val='') => {
        const div = document.createElement('div'); div.style.cssText = "display:flex; gap:10px; margin-bottom:10px;";
        div.innerHTML = `<textarea class="step-txt" rows="2" style="flex:1;" placeholder="æ­¥é©Ÿ...">${val}</textarea><button class="btn btn-danger" style="height:auto;" onclick="this.parentElement.remove()">X</button>`;
        getEl('edit-steps-list').appendChild(div);
    },
    saveRecipe: () => {
        const name = getEl('edit-name').value; if(!name) return alert('è«‹è¼¸å…¥åç¨±');
        const ingredients = []; document.querySelectorAll('.ingredient-row').forEach(row => {
            const id = row.querySelector('.ing-sel').value; const amt = parseFloat(row.querySelector('.ing-amt').value);
            if(id && amt) ingredients.push({ ingredientId: id, amount: amt });
        });
        const steps = []; document.querySelectorAll('.step-txt').forEach(row => { if(row.value.trim()) steps.push(row.value.trim()); });
        const newR = { id: editingRecipeId || uuid(), name, baseServings: parseFloat(getEl('edit-base-servings').value)||1, categoryId: getEl('edit-category').value, ingredients, steps, image: getEl('edit-image-preview').src.startsWith('data') ? getEl('edit-image-preview').src : null };
        dbApi.save("recipes", newR); toast('å·²å„²å­˜'); editingRecipeId = null; app.navTo('list');
    },
    handleImageUpload: async (input) => { 
        if(input.files[0]) { try { const base64 = await resizeImage(input.files[0]); getEl('edit-image-preview').src = base64; getEl('edit-image-preview-container').classList.remove('hidden'); } catch(e){alert('Err');} } 
    },
    clearImage: () => { getEl('edit-image-input').value = ''; getEl('edit-image-preview').src = ''; getEl('edit-image-preview-container').classList.add('hidden'); },

    // --- Settings (FIXED: Editing logic) ---
    renderSettings: () => {
        const catDiv = getEl('settings-cat-list'); catDiv.innerHTML = '';
        appState.categories.forEach(c => { const b = document.createElement('div'); b.className = 'cat-chip active'; b.innerText = c.name; catDiv.appendChild(b); });
        
        const ingDiv = getEl('settings-ing-list'); ingDiv.innerHTML = '';
        appState.ingredients.forEach(i => {
            const d = document.createElement('div'); d.className = 'settings-item';
            // Click to Edit Logic
            d.onclick = (e) => { 
                if(e.target.tagName !== 'BUTTON') app.selectIngredientForEdit(i.id); 
            };
            d.innerHTML = `<div><b>${i.name}</b> $${i.price}/${i.unit}</div><button class="btn btn-sm btn-danger" onclick="app.deleteIngredient('${i.id}')">åˆª</button>`;
            ingDiv.appendChild(d);
        });
    },
    selectIngredientForEdit: (id) => {
        const ing = appState.ingredients.find(i => i.id === id); if(!ing) return;
        editingIngredientId = id;
        getEl('setting-ing-name').value = ing.name;
        getEl('setting-ing-price').value = ing.price;
        getEl('setting-ing-unit').value = ing.unit;
        
        // Change UI to Edit Mode
        getEl('btn-save-ing').innerText = "æ›´æ–°é£Ÿæ";
        getEl('btn-save-ing').classList.add('btn-edit-mode');
        getEl('btn-cancel-ing-edit').classList.remove('hidden');
        getEl('ingredient-form-card').classList.add('editing-mode-box');
    },
    cancelEditIngredient: () => {
        editingIngredientId = null;
        getEl('setting-ing-name').value = '';
        getEl('setting-ing-price').value = '';
        getEl('setting-ing-unit').value = '';
        
        // Reset UI
        getEl('btn-save-ing').innerText = "å„²å­˜é£Ÿæ";
        getEl('btn-save-ing').classList.remove('btn-edit-mode');
        getEl('btn-cancel-ing-edit').classList.add('hidden');
        getEl('ingredient-form-card').classList.remove('editing-mode-box');
    },
    saveIngredient: () => {
        const name = getEl('setting-ing-name').value;
        const price = parseFloat(getEl('setting-ing-price').value);
        const unit = getEl('setting-ing-unit').value;
        if(!name || !unit) return alert('è«‹å¡«å¯«å®Œæ•´');

        const id = editingIngredientId || uuid();
        dbApi.save("ingredients", {id, name, price, unit});
        toast('å·²å„²å­˜');
        app.cancelEditIngredient(); // Reset form
    },
    deleteIngredient: (id) => { 
        if(editingIngredientId === id) app.cancelEditIngredient();
        if(confirm('åˆªé™¤ï¼Ÿ')) dbApi.del("ingredients", id); 
    },
    addCategory: () => { const name = getEl('setting-cat-name').value; if(name) { dbApi.save("categories", {id:uuid(), name}); getEl('setting-cat-name').value=''; } },
    renderCategories: () => {
        const list = getEl('category-manage-list'); list.innerHTML = '';
        appState.categories.forEach(c => { const d = document.createElement('div'); d.className = 'settings-item'; d.innerHTML = `<span>${c.name}</span><button class="btn btn-sm btn-danger" onclick="app.deleteCategory('${c.id}')">åˆª</button>`; list.appendChild(d); });
    },
    deleteCategory: (id) => { if(confirm('åˆªé™¤ï¼Ÿ')) dbApi.del("categories", id); },

    // --- Backup / Restore ---
    exportData: async () => {
        showLoading('æ‰“åŒ…ä¸­...');
        try {
            const r = (await getDocs(collection(db,'recipes'))).docs.map(d=>d.data());
            const i = (await getDocs(collection(db,'ingredients'))).docs.map(d=>d.data());
            const c = (await getDocs(collection(db,'categories'))).docs.map(d=>d.data());
            getEl('io-textarea').value = JSON.stringify({recipes:r, ingredients:i, categories:c}, null, 2);
        } catch(e) { alert('åŒ¯å‡ºå¤±æ•—'); } finally { hideLoading(); }
    },
    importData: async () => {
        const raw = getEl('io-textarea').value; if(!raw) return;
        try {
            const data = JSON.parse(raw);
            if(!confirm('é€™å°‡è¦†å¯«é›²ç«¯è³‡æ–™ï¼Œç¢ºå®šï¼Ÿ')) return;
            showLoading('ä¸Šå‚³ä¸­...');
            for(let r of data.recipes) await setDoc(doc(db,'recipes',r.id), r);
            for(let i of data.ingredients) await setDoc(doc(db,'ingredients',i.id), i);
            for(let c of data.categories) await setDoc(doc(db,'categories',c.id), c);
            toast('åŒ¯å…¥å®Œæˆ');
        } catch(e) { alert('åŒ¯å…¥å¤±æ•—'); } finally { hideLoading(); }
    },

    // --- Scan ---
    handleFileScan: async (input) => { 
        const file = input.files[0]; if(!file) return;
        showLoading('åˆ†æä¸­...');
        try {
            let text = "";
            if(file.name.endsWith('.docx')) { const buf = await file.arrayBuffer(); const res = await mammoth.extractRawText({ arrayBuffer: buf }); text = res.value; } 
            else { const res = await Tesseract.recognize(file, 'chi_tra+eng'); text = res.data.text; }
            const lines = text.split(/\r?\n/).filter(l=>l.trim());
            getEl('scan-name').value = lines[0]||'æœªå‘½å';
            const ings=[], steps=[];
            for(let i=1; i<lines.length; i++) {
                if(/\d/.test(lines[i]) && lines[i].length < 15) ings.push(lines[i]); else steps.push(lines[i]);
            }
            getEl('scan-ingredients-text').value = ings.join('\n'); getEl('scan-steps-text').value = steps.join('\n');
            getEl('modal-scan').classList.add('active');
        } catch(e){ alert('Error'); } finally { hideLoading(); input.value = ''; }
    },
    closeScanModal: () => getEl('modal-scan').classList.remove('active'),
    confirmScanImport: async () => {
        const name = getEl('scan-name').value;
        const ingText = getEl('scan-ingredients-text').value;
        const stepText = getEl('scan-steps-text').value;
        const ingredients = [];
        const lines = ingText.split('\n');
        for(let line of lines) {
            const ingName = line.replace(/[0-9.]/g, '').trim();
            let ingId = uuid();
            const exist = appState.ingredients.find(i => i.name === ingName);
            if(exist) ingId = exist.id;
            else await dbApi.save("ingredients", { id: ingId, name: ingName, price: 0, unit: 'g' });
            ingredients.push({ ingredientId: ingId, amount: parseFloat(line.match(/\d+/)) || 0 });
        }
        const newR = { id: uuid(), name, baseServings: 1, categoryId: '', ingredients, steps: stepText.split('\n').filter(s=>s.trim()) };
        await dbApi.save("recipes", newR);
        app.closeScanModal(); toast('åŒ¯å…¥æˆåŠŸ'); app.navTo('list');
    }
};

function attachRippleEffect() { document.querySelectorAll('.btn').forEach(b => b.addEventListener('click', function(e){ /* simplified ripple */ })); }
const resizeImage = (file) => { return new Promise(r=>r('')); };

document.addEventListener('DOMContentLoaded', app.init);
</script>
</body>
</html>
