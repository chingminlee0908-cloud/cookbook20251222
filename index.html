<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£Ÿè­œç®¡å®¶ | Morandi Neumorphism</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- 1. Design Tokens --- */
        :root {
            --bg-morandi: #F2EAE4;
            --text-primary: #5E5451;
            --text-secondary: #8C8380;
            --accent-pink: #D48A96;
            --danger: #C47070;

            --neu-light: #FFFFFF;
            --neu-dark: #D3C6BC;

            /* é™°å½±è¨­å®šï¼šæ–°å¢ Hover ç‹€æ…‹ */
            --shadow-flat: 10px 10px 20px var(--neu-dark), -10px -10px 20px var(--neu-light);
            --shadow-hover: 14px 14px 28px var(--neu-dark), -14px -14px 28px var(--neu-light); /* æ‡¸æµ®æ™‚é™°å½±æ›´æ“´æ•£ */
            --shadow-pressed: inset 6px 6px 12px var(--neu-dark), inset -6px -6px 12px var(--neu-light);
            --shadow-shallow: 5px 5px 12px var(--neu-dark), -5px -5px 12px var(--neu-light);

            --radius-xl: 28px;
            --radius-pill: 50px;
            --font-main: 'Nunito', "PingFang TC", "Microsoft JhengHei", sans-serif;
        }

        /* --- 2. Global Reset --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        body { 
            margin: 0; 
            font-family: var(--font-main);
            background-color: var(--bg-morandi);
            color: var(--text-primary);
            padding-bottom: 130px; 
            line-height: 1.7;
        }

        h1, h2, h3 { font-weight: 700; color: var(--text-primary); letter-spacing: 0.02em; }
        label, th, .card-subtitle, .badge, nav button { font-weight: 600; letter-spacing: 0.05em; }

        /* --- 3. Layout Components --- */
        .container { max-width: 700px; margin: 0 auto; padding: 30px 24px; }

        header { 
            background: var(--bg-morandi);
            box-shadow: var(--shadow-shallow);
            padding: 16px 24px; 
            position: sticky; top: 0; z-index: 100; 
            display: flex; justify-content: center; align-items: center; 
            border-bottom-left-radius: var(--radius-xl);
            border-bottom-right-radius: var(--radius-xl);
        }
        h1 { margin: 0; font-size: 1.4rem; color: var(--accent-pink); font-weight: 800; }

        h2 { font-size: 1.5rem; margin: 32px 0 24px; position: relative; display: inline-block; }
        h2::after { content: ''; display: block; width: 30px; height: 4px; background: var(--accent-pink); border-radius: var(--radius-pill); margin-top: 6px; opacity: 0.7; }

        /* --- 4. Cards (Hover Effect Added) --- */
        .card { 
            background: var(--bg-morandi);
            border-radius: var(--radius-xl); 
            padding: 24px; 
            margin-bottom: 28px; 
            box-shadow: var(--shadow-flat);
            border: none;
            display: flex; align-items: center; gap: 20px; 
            cursor: pointer; 
            /* å¢åŠ éæ¸¡å‹•ç•«è®“ç‰¹æ•ˆæ›´æ»‘é † */
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative; overflow: hidden; /* For Ripple */
        }

        /* æ‡¸æµ®ç‰¹æ•ˆï¼šè¼•å¾®ä¸Šæµ® + é™°å½±æ“´æ•£ */
        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-hover);
        }

        .card:active {
            box-shadow: var(--shadow-pressed);
            transform: scale(0.98) translateY(0); /* æŒ‰ä¸‹æ™‚å›åˆ°åŸä½ä¸¦ç¸®å° */
        }

        .card-img { 
            width: 72px; height: 72px; border-radius: 50%; object-fit: cover; 
            box-shadow: var(--shadow-pressed); padding: 4px; background: var(--bg-morandi);
        }
        .card-content { flex: 1; overflow: hidden; }
        .card-title { font-weight: 700; font-size: 1.25rem; margin-bottom: 8px; }
        .card-subtitle { font-size: 0.9rem; color: var(--text-secondary); }

        /* --- 5. Inputs & Forms --- */
        input, select, textarea { 
            width: 100%; padding: 16px 24px; margin-bottom: 28px; 
            border: none; border-radius: var(--radius-pill);
            font-family: var(--font-main); font-size: 1rem; 
            background: var(--bg-morandi); color: var(--text-primary);
            box-shadow: var(--shadow-pressed);
            transition: all 0.2s;
        }
        textarea { border-radius: var(--radius-xl); }
        input:focus, select:focus, textarea:focus { color: var(--accent-pink); box-shadow: inset 4px 4px 8px var(--neu-dark), inset -4px -4px 8px var(--neu-light); }
        label { display: block; margin-bottom: 10px; font-size: 0.9rem; color: var(--accent-pink); font-weight: 700; margin-left: 16px; }

        /* --- 6. Buttons (Enhanced Interaction) --- */
        .btn { 
            padding: 14px 28px; border: none; border-radius: var(--radius-pill); 
            cursor: pointer; font-family: var(--font-main); font-size: 1rem; font-weight: 700;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px; 
            background: var(--bg-morandi); color: var(--text-primary);
            box-shadow: var(--shadow-flat);
            
            /* é—œéµï¼šè®“ Hover å¹³æ»‘ */
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative; overflow: hidden; /* For Ripple */
        }

        /* æ‡¸æµ®ç‰¹æ•ˆï¼šè®Šäº®ã€ä¸Šæµ® */
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
            filter: brightness(1.02); /* å¾®å¾®è®Šäº® */
        }

        /* æŒ‰ä¸‹ç‰¹æ•ˆ */
        .btn:active { 
            box-shadow: var(--shadow-pressed); 
            transform: scale(0.96) translateY(0); 
            filter: brightness(0.98);
        }

        .btn-primary { color: var(--accent-pink); font-weight: 800; }
        .btn-danger { color: var(--danger); }
        .btn-outline { box-shadow: var(--shadow-shallow); color: var(--text-secondary); }
        .btn-outline:active { box-shadow: var(--shadow-pressed); }
        .btn-block { width: 100%; display: flex; margin-bottom: 16px; }
        .btn-sm { padding: 10px 20px; font-size: 0.9rem; }

        /* FAB (æµ®å‹•æŒ‰éˆ•) */
        .fab { 
            position: fixed; bottom: 100px; right: 28px; 
            width: 60px; height: 60px; border-radius: 50%; 
            background: var(--bg-morandi); color: var(--accent-pink); 
            display: flex; align-items: center; justify-content: center; 
            font-size: 1.8rem; font-weight: 300; 
            box-shadow: var(--shadow-flat); border: none; 
            cursor: pointer; z-index: 90; 
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            overflow: hidden; /* For Ripple */
        }
        .fab:hover { transform: translateY(-4px) rotate(90deg); box-shadow: var(--shadow-hover); }
        .fab:active { box-shadow: var(--shadow-pressed); transform: scale(0.9) rotate(90deg); }

        /* --- 7. Ripple Effect Styles (æ°´æ³¢ç´‹) --- */
        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.6); /* ç™½è‰²å…‰åœˆ */
            transform: scale(0);
            animation: ripple-animation 0.6s linear;
            pointer-events: none; /* è®“é»æ“Šç©¿é€ */
        }
        
        /* é‡å° Primary æŒ‰éˆ•ï¼Œæ°´æ³¢ç´‹æ”¹ç‚ºç²‰è‰² */
        .btn-primary .ripple, .fab .ripple {
            background: rgba(212, 138, 150, 0.3); 
        }

        @keyframes ripple-animation {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* --- 8. Tables & Detail --- */
        .table-container { 
            background: var(--bg-morandi); border-radius: var(--radius-xl);
            box-shadow: var(--shadow-flat); padding: 12px; margin-bottom: 28px; overflow: hidden;
        }
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th { 
            background: var(--bg-morandi); font-weight: 700; font-size: 0.9rem; 
            color: var(--text-secondary); padding: 18px; text-align: left;
            border-bottom: 2px solid rgba(212, 138, 150, 0.15);
        }
        td { padding: 18px; font-size: 1rem; border-bottom: 1px solid rgba(212, 138, 150, 0.08); }
        tr:last-child td { border-bottom: none; }
        .price { color: var(--accent-pink); font-weight: 800; font-size: 1.1rem; }

        .detail-header { padding: 20px; text-align: center; }
        .detail-img { 
            width: 180px; height: 180px; object-fit: cover; border-radius: 50%;
            border: 8px solid var(--bg-morandi); box-shadow: var(--shadow-pressed);
        }
        .detail-info { 
            padding: 28px; background: var(--bg-morandi); border-radius: var(--radius-xl);
            box-shadow: var(--shadow-flat); margin: 0 20px 24px 20px; text-align: center;
        }
        .calc-box { 
            background: var(--bg-morandi); padding: 28px; border-radius: var(--radius-xl); 
            margin: 24px 20px; box-shadow: var(--shadow-pressed);
        }

        /* --- 9. Navigation --- */
        nav { 
            position: fixed; bottom: 20px; left: 20px; right: 20px; width: auto;
            background: var(--bg-morandi); border-radius: var(--radius-pill);
            box-shadow: 6px 6px 12px var(--neu-dark), -6px -6px 12px var(--neu-light);
            display: flex; justify-content: space-around; padding: 8px 20px; z-index: 100; 
        }
        nav button { 
            background: none; border: none; font-size: 0.8rem; color: var(--text-secondary); 
            display: flex; flex-direction: column; align-items: center; cursor: pointer; 
            transition: all 0.3s; padding: 6px 20px; border-radius: var(--radius-pill);
            position: relative; overflow: hidden; /* For Ripple */
        }
        nav button.active { color: var(--accent-pink); box-shadow: var(--shadow-pressed); }
        nav button:hover { color: var(--accent-pink); }
        nav button svg { width: 20px; height: 20px; margin-bottom: 4px; fill: currentColor; }

        /* --- 10. Utilities --- */
        .empty-state { 
            text-align: center; padding: 60px 20px; color: var(--text-secondary);
            box-shadow: var(--shadow-pressed); border-radius: var(--radius-xl);
        }
        .view { display: none; animation: fadeIn 0.4s ease-out; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .badge { 
            background: var(--bg-morandi); color: var(--accent-pink); 
            padding: 8px 16px; border-radius: var(--radius-pill);
            font-size: 0.9rem; font-weight: 700; box-shadow: var(--shadow-pressed);
        }

        #toast { 
            visibility: hidden; min-width: 260px; background-color: var(--bg-morandi); 
            color: var(--accent-pink); text-align: center; border-radius: var(--radius-pill); 
            padding: 18px 28px; position: fixed; z-index: 200; left: 50%; bottom: 100px; 
            transform: translateX(-50%); font-weight: 700; box-shadow: var(--shadow-flat);
        }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 80px; opacity: 0;} to {bottom: 100px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 100px; opacity: 1;} to {bottom: 80px; opacity: 0;} }
        
        .hidden { display: none !important; }
        .text-right { text-align: right; }
        
        .settings-item {
            background: var(--bg-morandi); box-shadow: var(--shadow-shallow);
            border-radius: var(--radius-xl); padding: 16px 24px; margin-bottom: 16px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .ingredient-row { display: grid; grid-template-columns: 2fr 1fr 44px; gap: 16px; align-items: center; margin-bottom: 16px; }
        .ingredient-row .btn-danger {
            padding: 0; height: 44px; width: 44px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; font-size: 1.4rem; box-shadow: var(--shadow-shallow);
        }
        .ingredient-row .btn-danger:active { box-shadow: var(--shadow-pressed); }

        #search-container input { padding-left: 52px; }
        #search-container::before {
            content: 'ğŸ”'; position: absolute; left: 22px; top: 50%; transform: translateY(-55%);
            color: var(--accent-pink); z-index: 2; font-size: 1.2rem;
        }
        .settings-section-title {
            margin-top: 40px; margin-bottom: 20px; padding-left: 10px;
            border-left: 4px solid var(--accent-pink); font-size: 1.2rem;
        }
    </style>
</head>
<body>

<header>
    <h1 id="header-title">é£Ÿè­œç®¡å®¶</h1>
</header>

<div class="container">

    <div id="view-list" class="view active">
        <div id="search-container" style="position:relative; margin-bottom: 24px;">
            <input type="text" id="search-input" placeholder="æœå°‹æ‚¨çš„é£Ÿè­œ..." oninput="app.handleSearch()">
        </div>
        <div id="recipe-list-container"></div>
        <button class="fab ripple-btn" onclick="app.navTo('edit')" aria-label="æ–°å¢é£Ÿè­œ">ï¼‹</button>
    </div>

    <div id="view-detail" class="view">
        <div class="detail-header">
            <img id="detail-image" class="detail-img" src="" alt="Recipe Image">
        </div>
        <div class="detail-info">
            <h2 id="detail-title" style="margin-top:0; border:none; text-align:center; font-size: 1.8rem; margin-bottom: 16px;">é£Ÿè­œåç¨±</h2>
            <div style="display:flex; justify-content:center; gap: 10px; margin-bottom: 24px;">
                <span class="badge">åŸºæº–: <span id="detail-base-servings"></span> äººä»½</span>
            </div>
            <div style="display:flex; justify-content:center; gap:16px;">
                <button class="btn btn-sm btn-outline ripple-btn" onclick="app.editCurrentRecipe()">ç·¨è¼¯</button>
                <button class="btn btn-sm btn-danger ripple-btn" onclick="app.deleteCurrentRecipe()">åˆªé™¤</button>
            </div>
        </div>

        <div class="calc-box">
            <label for="target-servings" style="text-align: center;">ä»½é‡æ›ç®— (ç›®æ¨™äººæ•¸)</label>
            <div style="display:flex; gap:16px; align-items:center; justify-content: center;">
                <input type="number" id="target-servings" value="1" min="1" onchange="app.renderDetailCalculation()" style="margin-bottom:0; text-align:center; font-size: 1.4rem; width: 120px;">
            </div>
             <button class="btn btn-primary btn-block ripple-btn" onclick="app.renderDetailCalculation()" style="margin-top: 20px;">é‡æ–°è¨ˆç®—æˆæœ¬</button>
            <div style="margin-top:28px; display:flex; justify-content:space-between; align-items: center; border-top: 2px solid rgba(212, 138, 150, 0.15); padding-top: 20px;">
                <span style="font-weight: 700; color: var(--text-secondary);">é ä¼°ç¸½æˆæœ¬</span>
                <span class="price" id="detail-total-cost" style="font-size: 1.8rem;">0.00</span>
            </div>
        </div>

        <h3 style="text-align: center; margin-top: 36px; margin-bottom: 24px;">é£Ÿææ˜ç´°</h3>
        <div class="table-container">
            <table id="detail-table">
                <thead>
                    <tr>
                        <th>å“é …</th>
                        <th>æ•¸é‡</th>
                        <th>å–®ä½</th>
                        <th class="text-right">æˆæœ¬</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <button class="btn btn-outline btn-block ripple-btn" onclick="app.navTo('list')" style="margin: 0 20px;">è¿”å›åˆ—è¡¨</button>
    </div>

    <div id="view-edit" class="view">
        <h2 id="edit-view-title">æ–°å¢é£Ÿè­œ</h2>
        <label>é£Ÿè­œåç¨±</label>
        <input type="text" id="edit-name" placeholder="ä¾‹å¦‚ï¼šè‰è“é®®å¥¶æ²¹è›‹ç³•">
        <label>åŸºæº–ä»½æ•¸ (äºº)</label>
        <input type="number" id="edit-base-servings" value="4" min="1">
        <label>å°é¢åœ–ç‰‡ (é¸å¡«)</label>
        <div style="position:relative; overflow:hidden; margin-bottom: 28px;">
            <button class="btn btn-outline btn-block" style="pointer-events: none; color: var(--text-secondary);">é¸æ“‡åœ–ç‰‡...</button>
            <input type="file" id="edit-image-input" accept="image/*" onchange="app.handleImageUpload(this)" 
                   style="position:absolute; top:0; left:0; opacity:0; height:100%; width:100%; cursor:pointer;">
        </div>
        <div id="edit-image-preview-container" class="hidden" style="margin-bottom:28px; text-align:center;">
            <img id="edit-image-preview" src="" style="max-height: 200px; border-radius: var(--radius-xl); box-shadow: var(--shadow-flat); border: 4px solid var(--bg-morandi);">
            <br>
            <button class="btn btn-sm btn-danger ripple-btn" onclick="app.clearImage()" style="margin-top:20px;">ç§»é™¤åœ–ç‰‡</button>
        </div>
        <div style="display:flex; justify-content: space-between; align-items: center; margin-top: 36px; margin-bottom: 24px;">
            <h3 style="margin:0;">æ‰€éœ€é£Ÿæ</h3>
            <button class="btn btn-sm btn-outline ripple-btn" onclick="app.addIngredientRow()" style="color: var(--accent-pink);">ï¼‹ åŠ å…¥</button>
        </div>
        <div id="edit-ingredients-list"></div>
        <div style="display:flex; gap:20px; margin-top: 48px;">
            <button class="btn btn-outline ripple-btn" style="flex:1" onclick="app.navTo('list')">å–æ¶ˆ</button>
            <button class="btn btn-primary ripple-btn" style="flex:1" onclick="app.saveRecipe()">å„²å­˜</button>
        </div>
    </div>

    <div id="view-settings" class="view">
        <div class="settings-section-title">å–®ä½ç®¡ç†</div>
        <div style="display:flex; gap:16px; margin-bottom:28px; align-items: flex-end;">
            <div style="flex:1">
                <label>æ–°å–®ä½åç¨±</label>
                <input type="text" id="setting-unit-name" placeholder="ä¾‹å¦‚ï¼šç›’ã€ç‰‡" style="margin-bottom:0;">
            </div>
            <button class="btn btn-primary ripple-btn" onclick="app.addUnit()" style="height: 58px;">æ–°å¢</button>
        </div>
        <div id="settings-unit-list" style="margin-bottom: 40px;"></div>

        <div class="settings-section-title">é£Ÿæå¸‚åƒ¹åº«</div>
        <div style="background: var(--bg-morandi); padding: 28px; box-shadow: var(--shadow-pressed); border-radius: var(--radius-xl); margin-bottom:36px;">
            <label>é£Ÿæåç¨±</label>
            <input type="text" id="setting-ing-name" placeholder="ä¾‹å¦‚ï¼šæœ‰æ©Ÿè‰è“">
            <div style="display:flex; gap:16px; margin-bottom: 10px;">
                <div style="flex:1">
                    <label>å–®åƒ¹</label>
                    <input type="number" id="setting-ing-price" placeholder="0.00" step="0.01">
                </div>
                <div style="flex:1">
                    <label>è¨ˆåƒ¹å–®ä½</label>
                    <select id="setting-ing-unit" style="margin-bottom:20px;"></select>
                </div>
            </div>
            <button class="btn btn-primary btn-block ripple-btn" onclick="app.addIngredient()">æ›´æ–°/æ–°å¢é£Ÿæ</button>
        </div>
        <div id="settings-ing-list"></div>

        <div style="margin-top: 60px; padding-top: 20px; border-top: 2px dashed rgba(212,138,150,0.2);">
            <div class="settings-section-title" style="border-color: var(--text-secondary); color: var(--text-secondary);">è³‡æ–™ç®¡ç†</div>
            <button class="btn btn-outline btn-block ripple-btn" onclick="app.navTo('io')">å‰å¾€ å‚™ä»½èˆ‡é‚„åŸ</button>
        </div>
    </div>

    <div id="view-io" class="view">
        <h2>å‚™ä»½èˆ‡é‚„åŸ</h2>
        <p style="font-size: 0.95rem; color: var(--text-secondary); margin-bottom: 28px; background: var(--bg-morandi); box-shadow: var(--shadow-pressed); padding: 16px; border-radius: var(--radius-xl);">
            æ‚¨çš„è³‡æ–™å„²å­˜åœ¨æ­¤ç€è¦½å™¨ä¸­ã€‚è¤‡è£½ä¸‹æ–¹çš„ä»£ç¢¼ä»¥è½‰ç§»è³‡æ–™åˆ°å…¶ä»–è£ç½®ã€‚
        </p>
        <label>è³‡æ–™ä»£ç¢¼ (JSON)</label>
        <textarea id="io-textarea" rows="10" style="font-family: monospace; font-size: 0.9rem;"></textarea>
        <div style="display:flex; gap:16px; margin-bottom:24px; margin-top: 28px;">
            <button class="btn btn-outline ripple-btn" style="flex:1" onclick="app.exportData()">é¡¯ç¤ºè³‡æ–™ (åŒ¯å‡º)</button>
            <button class="btn btn-danger ripple-btn" style="flex:1" onclick="app.importData()">åŸ·è¡Œé‚„åŸ</button>
        </div>
        <button class="btn btn-outline btn-block ripple-btn" onclick="app.navTo('settings')">è¿”å›è¨­å®š</button>
    </div>

</div>

<nav>
    <button onclick="app.navTo('list')" id="nav-list" class="active ripple-btn">
        <svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>
        é£Ÿè­œ
    </button>
    <button onclick="app.navTo('settings')" id="nav-settings" class="ripple-btn">
        <svg viewBox="0 0 24 24"><path d="M17.21 9l-4.38-6.56a1 1 0 0 0-1.66 0L6.79 9H2v13a1 1 0 0 0 1 1h18a1 1 0 0 0 1-1V9h-4.79zM12 4.22L15.19 9H8.81L12 4.22zM20 21H4V11h16v10z"/></svg>
        é£Ÿæè¨­å®š
    </button>
</nav>

<div id="toast">è¨Šæ¯æç¤º</div>

<script>
// --- Constants & State ---
const CONSTANTS = {
    STORE_KEY: 'recipe_app_v3_morandi',
    IMG_PLACEHOLDER: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2QzYzZiYyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iI2QzYzZiYyIvPjwvc3ZnPg=='
};

const defaultState = {
    units: [{ id: 'u1', name: 'g' }, { id: 'u2', name: 'ml' }, { id: 'u3', name: 'å€‹' }, { id: 'u4', name: 'å°æ–¤' }],
    ingredients: [], 
    recipes: [] 
};

let appState = JSON.parse(JSON.stringify(defaultState));
let editingRecipeId = null;
let currentDetailRecipeId = null;

const uuid = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
const getEl = (id) => document.getElementById(id);

// --- Storage & Helpers ---
const storage = {
    save: () => {
        try { localStorage.setItem(CONSTANTS.STORE_KEY, JSON.stringify(appState)); } 
        catch (e) { toast('å„²å­˜å¤±æ•—ï¼åœ–ç‰‡å¯èƒ½éå¤§ã€‚'); }
    },
    load: () => {
        const data = localStorage.getItem(CONSTANTS.STORE_KEY);
        if (data) {
            try {
                const parsed = JSON.parse(data);
                appState = { ...defaultState, ...parsed }; 
                if(!appState.units) appState.units = defaultState.units;
                if(!appState.ingredients) appState.ingredients = [];
                if(!appState.recipes) appState.recipes = [];
            } catch (e) { appState = JSON.parse(JSON.stringify(defaultState)); }
        }
    },
    clear: () => localStorage.removeItem(CONSTANTS.STORE_KEY)
};

const toast = (msg) => {
    const el = getEl('toast');
    el.textContent = msg;
    el.className = 'show';
    setTimeout(() => { el.className = el.className.replace('show', ''); }, 3000);
};

const resizeImage = (file, maxWidth = 500) => {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (event) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width, height = img.height;
                if (width > maxWidth) { height = Math.round((height * maxWidth) / width); width = maxWidth; }
                canvas.width = width; canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                resolve(canvas.toDataURL('image/jpeg', 0.7)); 
            };
            img.src = event.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
};

// --- Ripple Effect Logic ---
function createRipple(event) {
    const button = event.currentTarget;
    const circle = document.createElement("span");
    const diameter = Math.max(button.clientWidth, button.clientHeight);
    const radius = diameter / 2;

    // å¦‚æœæ˜¯æ»‘é¼ é»æ“Šï¼Œè¨ˆç®—ç›¸å°æ–¼æŒ‰éˆ•çš„ä½ç½®ï¼›å¦‚æœæ˜¯ç¨‹å¼è§¸ç™¼(å¦‚éµç›¤)ï¼Œå‰‡ç½®ä¸­
    const rect = button.getBoundingClientRect();
    const x = event.clientX ? (event.clientX - rect.left) : radius;
    const y = event.clientY ? (event.clientY - rect.top) : radius;

    circle.style.width = circle.style.height = `${diameter}px`;
    circle.style.left = `${x - radius}px`;
    circle.style.top = `${y - radius}px`;
    circle.classList.add("ripple");

    const ripple = button.getElementsByClassName("ripple")[0];
    if (ripple) {
        ripple.remove();
    }

    button.appendChild(circle);
}

// Attach listeners to buttons (delegation or direct)
function attachRippleEffect() {
    const buttons = document.querySelectorAll('.ripple-btn, .card, nav button');
    buttons.forEach(btn => {
        // Prevent multiple listeners
        btn.removeEventListener('click', createRipple);
        btn.addEventListener('click', createRipple);
    });
}

// --- App Controller ---
const app = {
    init: () => {
        storage.load();
        app.navTo('list');
    },

    navTo: (viewName) => {
        document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('nav button').forEach(el => el.classList.remove('active'));
        
        const target = getEl(`view-${viewName}`);
        if(target) target.classList.add('active');

        if (viewName === 'list' || viewName === 'detail') getEl('nav-list').classList.add('active');
        if (viewName === 'settings' || viewName === 'io') getEl('nav-settings').classList.add('active');
        
        if (viewName === 'list') app.renderRecipeList();
        if (viewName === 'settings') app.renderSettings();
        if (viewName === 'edit' && editingRecipeId === null) app.initEditForm(); 
        
        // Re-attach ripple effects to new elements
        setTimeout(attachRippleEffect, 100);
        window.scrollTo(0,0);
    },

    handleSearch: () => { app.renderRecipeList(getEl('search-input').value); },

    renderRecipeList: (keyword = '') => {
        const list = getEl('recipe-list-container');
        list.innerHTML = '';
        const filtered = appState.recipes.filter(r => r.name.toLowerCase().includes(keyword.toLowerCase()));
        
        if (filtered.length === 0) {
            list.innerHTML = `<div class="empty-state">${keyword ? 'æ‰¾ä¸åˆ°ç¬¦åˆçš„é£Ÿè­œã€‚' : 'å°šç„¡é£Ÿè­œï¼Œè«‹é»æ“Š ï¼‹ æ–°å¢ã€‚'}</div>`;
            return;
        }

        filtered.forEach(r => {
            const div = document.createElement('div');
            div.className = 'card'; // Card also has ripple
            div.onclick = (e) => { createRipple(e); setTimeout(() => app.openDetail(r.id), 200); };
            div.innerHTML = `
                <img src="${r.image || CONSTANTS.IMG_PLACEHOLDER}" class="card-img" loading="lazy">
                <div class="card-content">
                    <div class="card-title">${r.name}</div>
                    <div class="card-subtitle">ä»½é‡: ${r.baseServings} äºº â€¢ é£Ÿæ: ${r.ingredients.length} é …</div>
                </div>
                <div style="color:var(--accent-pink); font-size:1.5rem; font-weight:800;">â€º</div>
            `;
            list.appendChild(div);
        });
    },

    openDetail: (id) => {
        currentDetailRecipeId = id;
        const r = appState.recipes.find(x => x.id === id);
        if (!r) return;
        getEl('detail-title').textContent = r.name;
        getEl('detail-base-servings').textContent = r.baseServings;
        getEl('detail-image').src = r.image || CONSTANTS.IMG_PLACEHOLDER;
        getEl('target-servings').value = r.baseServings; 
        app.renderDetailCalculation();
        app.navTo('detail');
    },

    renderDetailCalculation: () => {
        const r = appState.recipes.find(x => x.id === currentDetailRecipeId);
        if (!r) return;
        const target = parseFloat(getEl('target-servings').value) || 0;
        const ratio = target / r.baseServings;
        const tbody = getEl('detail-table').querySelector('tbody');
        tbody.innerHTML = '';
        let totalCost = 0;

        r.ingredients.forEach(ri => {
            const ingDef = appState.ingredients.find(i => i.id === ri.ingredientId);
            if (!ingDef) return; 
            const unitDef = appState.units.find(u => u.id === ingDef.unitId);
            const unitName = unitDef ? unitDef.name : '?';
            const amount = ri.amount * ratio;
            const cost = amount * ingDef.price;
            totalCost += cost;

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="font-weight:700; color:var(--text-primary);">${ingDef.name}</td>
                <td>${Number.isInteger(amount) ? amount : amount.toFixed(1)}</td>
                <td style="color:var(--text-secondary);">${unitName}</td>
                <td class="text-right price">${cost.toFixed(2)}</td>
            `;
            tbody.appendChild(tr);
        });
        getEl('detail-total-cost').textContent = totalCost.toFixed(2);
    },

    deleteCurrentRecipe: () => {
        if(confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹é£Ÿè­œå—ï¼Ÿ')) {
            appState.recipes = appState.recipes.filter(r => r.id !== currentDetailRecipeId);
            storage.save();
            toast('åˆªé™¤æˆåŠŸ');
            app.navTo('list');
        }
    },

    editCurrentRecipe: () => {
        editingRecipeId = currentDetailRecipeId;
        app.initEditForm();
        app.navTo('edit');
    },

    initEditForm: () => {
        const title = getEl('edit-view-title');
        const list = getEl('edit-ingredients-list');
        list.innerHTML = '';
        if (editingRecipeId) {
            const r = appState.recipes.find(x => x.id === editingRecipeId);
            title.textContent = "ç·¨è¼¯é£Ÿè­œ";
            getEl('edit-name').value = r.name;
            getEl('edit-base-servings').value = r.baseServings;
            if (r.image) {
                getEl('edit-image-preview').src = r.image;
                getEl('edit-image-preview-container').classList.remove('hidden');
            } else { app.clearImage(); }
            r.ingredients.forEach(item => { app.addIngredientRow(item.ingredientId, item.amount); });
        } else {
            title.textContent = "æ–°å¢é£Ÿè­œ";
            getEl('edit-name').value = '';
            getEl('edit-base-servings').value = 4;
            app.clearImage();
            app.addIngredientRow(); 
        }
    },

    addIngredientRow: (selectedId = '', amount = '') => {
        const container = getEl('edit-ingredients-list');
        const div = document.createElement('div');
        div.className = 'ingredient-row';
        let options = '<option value="" disabled selected>é¸æ“‡é£Ÿæ</option>';
        appState.ingredients.forEach(ing => {
            const unit = appState.units.find(u => u.id === ing.unitId);
            const unitName = unit ? unit.name : '';
            const selected = ing.id === selectedId ? 'selected' : '';
            options += `<option value="${ing.id}" ${selected}>${ing.name} (${unitName})</option>`;
        });
        div.innerHTML = `
            <select class="ing-select" style="margin-bottom:0;">${options}</select>
            <input type="number" class="ing-amount" placeholder="æ•¸é‡" value="${amount}" step="any" style="margin-bottom:0;">
            <button class="btn btn-danger ripple-btn" onclick="this.parentElement.remove()">Ã—</button>
        `;
        container.appendChild(div);
        attachRippleEffect(); // re-attach for new button
    },

    handleImageUpload: async (input) => {
        if (input.files && input.files[0]) {
            try {
                const base64 = await resizeImage(input.files[0]);
                getEl('edit-image-preview').src = base64;
                getEl('edit-image-preview-container').classList.remove('hidden');
            } catch (e) { alert('åœ–ç‰‡è™•ç†å¤±æ•—'); }
        }
    },

    clearImage: () => {
        getEl('edit-image-input').value = '';
        getEl('edit-image-preview').src = '';
        getEl('edit-image-preview-container').classList.add('hidden');
    },

    saveRecipe: () => {
        const name = getEl('edit-name').value.trim();
        const baseServings = parseFloat(getEl('edit-base-servings').value);
        if (!name || !baseServings) { alert('è«‹å¡«å¯«é£Ÿè­œåç¨±èˆ‡åŸºæº–ä»½æ•¸'); return; }
        const rows = document.querySelectorAll('.ingredient-row');
        const ingredients = [];
        for (let row of rows) {
            const id = row.querySelector('.ing-select').value;
            const amount = parseFloat(row.querySelector('.ing-amount').value);
            if (id && amount) { ingredients.push({ ingredientId: id, amount: amount }); }
        }
        const imgData = getEl('edit-image-preview').getAttribute('src');
        const finalImg = (imgData && imgData.startsWith('data:')) ? imgData : null;
        const newRecipe = { id: editingRecipeId || uuid(), name, baseServings, image: finalImg, ingredients };
        if (editingRecipeId) {
            const idx = appState.recipes.findIndex(r => r.id === editingRecipeId);
            appState.recipes[idx] = newRecipe;
        } else { appState.recipes.push(newRecipe); }
        storage.save();
        toast('é£Ÿè­œå·²å„²å­˜');
        editingRecipeId = null; 
        app.navTo('list');
    },

    renderSettings: () => {
        const unitSelect = getEl('setting-ing-unit');
        unitSelect.innerHTML = '';
        appState.units.forEach(u => { unitSelect.innerHTML += `<option value="${u.id}">${u.name}</option>`; });
        
        const unitList = getEl('settings-unit-list');
        unitList.innerHTML = '';
        appState.units.forEach(u => {
            const div = document.createElement('div');
            div.className = 'settings-item';
            div.innerHTML = `<span style="font-weight:700; color:var(--accent-pink);">${u.name}</span> <button class="btn btn-sm btn-danger ripple-btn" onclick="app.deleteUnit('${u.id}')">åˆªé™¤</button>`;
            unitList.appendChild(div);
        });

        const ingList = getEl('settings-ing-list');
        ingList.innerHTML = '';
        appState.ingredients.forEach(i => {
            const u = appState.units.find(unit => unit.id === i.unitId);
            const uName = u ? u.name : '?';
            const div = document.createElement('div');
            div.className = 'settings-item';
            div.innerHTML = `
                <div style="flex:1">
                    <strong style="font-size:1.1rem;">${i.name}</strong><br>
                    <small style="color:var(--text-secondary);">$${i.price} / ${uName}</small>
                </div>
                <button class="btn btn-sm btn-danger ripple-btn" onclick="app.deleteIngredient('${i.id}')">åˆªé™¤</button>
            `;
            ingList.appendChild(div);
        });
        attachRippleEffect();
    },

    addUnit: () => {
        const name = getEl('setting-unit-name').value.trim();
        if (!name) return;
        appState.units.push({ id: uuid(), name });
        getEl('setting-unit-name').value = '';
        storage.save();
        app.renderSettings();
    },

    deleteUnit: (id) => {
        const isUsed = appState.ingredients.some(i => i.unitId === id);
        if (isUsed) { alert('ç„¡æ³•åˆªé™¤ï¼šæœ‰é£Ÿææ­£åœ¨ä½¿ç”¨æ­¤å–®ä½ã€‚'); return; }
        if (confirm('ç¢ºå®šåˆªé™¤æ­¤å–®ä½ï¼Ÿ')) {
            appState.units = appState.units.filter(u => u.id !== id);
            storage.save();
            app.renderSettings();
        }
    },

    addIngredient: () => {
        const name = getEl('setting-ing-name').value.trim();
        const price = parseFloat(getEl('setting-ing-price').value);
        const unitId = getEl('setting-ing-unit').value;
        if (!name || isNaN(price) || !unitId) { alert('è«‹å®Œæ•´å¡«å¯«è³‡è¨Šã€‚'); return; }
        appState.ingredients.push({ id: uuid(), name, price, unitId });
        getEl('setting-ing-name').value = '';
        getEl('setting-ing-price').value = '';
        storage.save();
        app.renderSettings();
        toast('å¸‚åƒ¹è¡¨å·²æ›´æ–°');
    },

    deleteIngredient: (id) => {
        let usedIn = [];
        appState.recipes.forEach(r => { if (r.ingredients.some(ri => ri.ingredientId === id)) usedIn.push(r.name); });
        if (usedIn.length > 0) { alert(`ç„¡æ³•åˆªé™¤ï¼šä»¥ä¸‹é£Ÿè­œæ­£åœ¨ä½¿ç”¨æ­¤é£Ÿæ\n${usedIn.join(', ')}`); return; }
        if (confirm('ç¢ºå®šåˆªé™¤æ­¤é£Ÿæï¼Ÿ')) {
            appState.ingredients = appState.ingredients.filter(i => i.id !== id);
            storage.save();
            app.renderSettings();
        }
    },

    exportData: () => { getEl('io-textarea').value = JSON.stringify(appState, null, 2); },
    
    importData: () => {
        const raw = getEl('io-textarea').value;
        if (!raw) return;
        try {
            const data = JSON.parse(raw);
            if (!data.units || !data.recipes) throw new Error('Invalid Format');
            if (confirm('ç¢ºå®šè¦é‚„åŸå—ï¼Ÿç›®å‰çš„è³‡æ–™å°‡æœƒè¢«è¦†è“‹ä¸”ç„¡æ³•å¾©åŸã€‚')) {
                appState = data;
                storage.save();
                toast('é‚„åŸæˆåŠŸ');
                app.navTo('list');
            }
        } catch (e) { alert('JSON æ ¼å¼éŒ¯èª¤ã€‚'); }
    }
};

document.addEventListener('DOMContentLoaded', () => {
    app.init();
    // Start listening for ripple
    attachRippleEffect();
});
</script>
</body>
</html>
