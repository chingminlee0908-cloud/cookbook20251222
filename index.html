<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£Ÿè­œç®¡å®¶ | Recipe Manager</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=Source+Sans+3:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        /* --- 1. Design Tokens (Serif System) --- */
        :root {
            /* Palette */
            --background: #FAFAF8;      /* æº«æš–è±¡ç‰™ç™½ */
            --card-bg: #FFFFFF;         /* ç´”ç™½å¡ç‰‡ */
            --foreground: #1A1A1A;      /* æ·±é»‘è‰²æ–‡å­— */
            --muted: #6B6B6B;           /* æš–ç°è‰²æ¬¡è¦æ–‡å­— */
            --border: #E8E4DF;          /* é‚Šæ¡†è‰² */
            
            /* Accent */
            --accent: #B8860B;          /* å¾©å¤é‡‘ */
            --accent-light: #F4F1EA;    /* æ¥µæ·¡é‡‘è‰²èƒŒæ™¯ */
            --danger: #A33B3B;          /* å„ªé›…ç´… */

            /* Typography - é‡å°ä¸­æ–‡å„ªåŒ– */
            --font-serif: "Playfair Display", "Songti TC", "Noto Serif TC", "PMingLiU", serif;
            --font-sans: "Source Sans 3", "PingFang TC", "Microsoft JhengHei", sans-serif;
            --font-mono: "IBM Plex Mono", monospace;

            /* Spacing & Effects */
            --shadow-sm: 0 1px 2px rgba(26,26,26,0.04);
            --shadow-md: 0 10px 30px -10px rgba(26,26,26,0.08);
            --radius-md: 6px;
        }

        /* --- 2. Global Reset & Typography --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; 
            font-family: var(--font-sans); 
            background-color: var(--background); 
            color: var(--foreground); 
            padding-bottom: 100px; 
            line-height: 1.7; /* ä¸­æ–‡è¡Œé«˜ç¨å¾®åŠ å¤§ */
            /* æ¨¡æ“¬ç´™å¼µè³ªæ„Ÿ */
            background-image: radial-gradient(#E8E4DF 1px, transparent 1px);
            background-size: 20px 20px;
        }

        h1, h2, h3 {
            font-family: var(--font-serif);
            font-weight: 600;
            color: var(--foreground);
            letter-spacing: 0.02em; /* ä¸­æ–‡æ¨™é¡Œç¨å¾®åŠ å¯¬ */
        }

        /* å°æ¨™é¡Œæ¨£å¼ */
        label, th, .card-subtitle, .badge, nav button {
            font-family: var(--font-mono); 
            letter-spacing: 0.05em;
        }

        /* --- 3. Layout Components --- */
        .container { 
            max-width: 700px; 
            margin: 0 auto; 
            padding: 24px 20px; 
        }

        /* Header */
        header { 
            background: rgba(250, 250, 248, 0.95);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid var(--border);
            padding: 16px 20px; 
            position: sticky; 
            top: 0; 
            z-index: 100; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }

        h1 { 
            margin: 0; 
            font-size: 1.5rem; 
        }

        h2 {
            font-size: 1.75rem; 
            border-bottom: 1px solid var(--border); 
            padding-bottom: 10px;
            margin: 32px 0 20px; 
            position: relative;
        }
        
        /* è£é£¾æ€§çŸ­ç·š */
        h2::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 40px;
            height: 2px;
            background: var(--accent);
        }

        /* --- 4. Cards --- */
        .card { 
            background: var(--card-bg); 
            border: 1px solid var(--border);
            border-top: 3px solid var(--accent); 
            border-radius: var(--radius-md); 
            padding: 20px; 
            margin-bottom: 20px; 
            box-shadow: var(--shadow-sm); 
            display: flex; 
            align-items: center; 
            gap: 16px; 
            cursor: pointer; 
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--accent);
        }

        .card-img { 
            width: 70px; 
            height: 70px; 
            border-radius: 50%; 
            object-fit: cover; 
            border: 1px solid var(--border);
            padding: 3px;
            background: #fff;
        }

        .card-content { flex: 1; overflow: hidden; }
        
        .card-title { 
            font-family: var(--font-serif);
            font-weight: 600; 
            font-size: 1.25rem; 
            margin-bottom: 6px; 
            color: var(--foreground);
        }
        
        .card-subtitle { 
            font-size: 0.85rem; 
            color: var(--muted); 
        }

        /* --- 5. Inputs & Forms --- */
        input, select, textarea { 
            width: 100%; 
            padding: 12px 0; 
            margin-bottom: 20px; 
            border: none;
            border-bottom: 1px solid var(--border);
            border-radius: 0;
            font-family: var(--font-sans);
            font-size: 1rem; 
            background: transparent; 
            transition: border-color 0.2s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-bottom-color: var(--accent);
        }

        label { 
            display: block; 
            margin-bottom: 4px; 
            font-size: 0.85rem; /* ä¸­æ–‡æ¨™ç±¤ç¨å¾®å¤§ä¸€é»æ¯”è¼ƒå¥½è®€ */
            color: var(--accent); 
            font-weight: 500;
        }

        /* --- 6. Buttons --- */
        .btn { 
            padding: 10px 20px; 
            border: 1px solid transparent; 
            border-radius: 2px; 
            cursor: pointer; 
            font-family: var(--font-mono);
            font-size: 0.9rem; 
            font-weight: 500;
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px; 
            transition: all 0.2s;
        }

        .btn-primary { 
            background: var(--foreground); 
            color: white; 
            border: 1px solid var(--foreground);
        }
        .btn-primary:hover { background: var(--accent); border-color: var(--accent); }

        .btn-secondary { 
            background: var(--accent-light); 
            color: var(--accent); 
        }

        .btn-danger { 
            background: transparent; 
            color: var(--danger); 
            border: 1px solid var(--danger);
        }

        .btn-outline { 
            border: 1px solid var(--border); 
            background: transparent; 
            color: var(--foreground); 
        }
        .btn-outline:hover { border-color: var(--accent); color: var(--accent); }

        .btn-block { width: 100%; display: flex; margin-bottom: 12px; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }

        /* FAB */
        .fab { 
            position: fixed; 
            bottom: 90px; 
            right: 24px; 
            width: 56px; 
            height: 56px; 
            border-radius: 50%; 
            background: var(--accent); 
            color: white; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 1.5rem; 
            font-family: var(--font-serif); 
            box-shadow: 0 4px 12px rgba(184, 134, 11, 0.4); 
            border: none; 
            cursor: pointer; 
            z-index: 90; 
            transition: transform 0.2s;
        }
        .fab:active { transform: scale(0.95); }

        /* --- 7. Tables & Detail --- */
        .table-container { 
            background: var(--card-bg); 
            border: 1px solid var(--border); 
            margin-bottom: 24px; 
            border-radius: var(--radius-md);
        }
        
        table { width: 100%; border-collapse: collapse; }
        
        th { 
            background: var(--background); 
            font-weight: 500; 
            font-size: 0.85rem; 
            color: var(--muted);
            border-bottom: 1px solid var(--border);
            padding: 12px 16px;
            text-align: left;
        }
        
        td { 
            padding: 16px; 
            border-bottom: 1px solid #f0f0f0; 
            font-family: var(--font-sans);
            font-size: 0.95rem;
        }

        .price { 
            color: var(--accent); 
            font-family: var(--font-mono); 
            font-weight: 500; 
        }

        .detail-img { 
            width: 100%; 
            height: 240px; 
            object-fit: cover; 
            border-bottom: 1px solid var(--accent); 
        }

        .detail-info { padding: 24px 0; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
        
        .calc-box { 
            background: var(--accent-light); 
            padding: 24px; 
            border-radius: var(--radius-md); 
            margin: 24px 0; 
            border: 1px solid rgba(184, 134, 11, 0.2); 
        }

        /* --- 8. Navigation --- */
        nav { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            width: 100%; 
            background: rgba(255,255,255,0.95); 
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--border); 
            display: flex; 
            justify-content: center; 
            gap: 60px;
            padding: 12px 0; 
            z-index: 100; 
        }

        nav button { 
            background: none; 
            border: none; 
            font-size: 0.8rem; 
            color: var(--muted); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            cursor: pointer; 
            transition: color 0.3s;
        }

        nav button.active { 
            color: var(--accent); 
        }
        
        nav button svg { 
            width: 24px; 
            height: 24px; 
            margin-bottom: 4px; 
            fill: currentColor; 
        }

        /* --- 9. Utilities & Toast --- */
        .empty-state { 
            text-align: center; 
            padding: 60px 20px; 
            color: var(--muted); 
            font-family: var(--font-serif);
            border: 1px dashed var(--border);
            border-radius: var(--radius-md);
        }

        .view { display: none; animation: fadeIn 0.4s ease-out; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .badge { 
            background: var(--foreground); 
            color: white; 
            padding: 4px 8px; 
            border-radius: 2px; 
            font-size: 0.8rem; 
        }

        #toast { 
            visibility: hidden; 
            min-width: 250px; 
            background-color: var(--foreground); 
            color: #fff; 
            text-align: center; 
            border-radius: 2px; 
            padding: 12px 24px; 
            position: fixed; 
            z-index: 200; 
            left: 50%; 
            bottom: 90px; 
            transform: translateX(-50%); 
            font-family: var(--font-sans);
            font-size: 0.9rem; 
            box-shadow: var(--shadow-md);
        }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 70px; opacity: 0;} to {bottom: 90px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 90px; opacity: 1;} to {bottom: 70px; opacity: 0;} }
        
        /* Helpers */
        .hidden { display: none !important; }
        .text-right { text-align: right; }
        
        /* Settings Item */
        .settings-item {
            border-bottom: 1px solid var(--border);
            padding: 16px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .settings-item:last-child { border-bottom: none; }
        .ingredient-row { display: grid; grid-template-columns: 2fr 1fr 30px; gap: 12px; align-items: center; margin-bottom: 12px; }
        
    </style>
</head>
<body>

<header>
    <h1 id="header-title">é£Ÿè­œç®¡å®¶</h1>
    <button class="btn btn-sm btn-outline" id="btn-export-import" style="border-color: var(--border);">å‚™ä»½/é‚„åŸ</button>
</header>

<div class="container">

    <div id="view-list" class="view active">
        <div style="position:relative; margin-bottom: 32px;">
            <input type="text" id="search-input" placeholder="ğŸ” æœå°‹é£Ÿè­œ..." oninput="app.handleSearch()" 
                   style="padding-left: 0; font-size: 1.2rem; border-bottom: 2px solid var(--border);">
        </div>

        <div id="recipe-list-container">
            </div>
        <button class="fab" onclick="app.navTo('edit')" aria-label="æ–°å¢é£Ÿè­œ">+</button>
    </div>

    <div id="view-detail" class="view">
        <div class="detail-header">
            <img id="detail-image" class="detail-img" src="" alt="Recipe Image">
        </div>
        <div class="detail-info">
            <h2 id="detail-title" style="margin-top:0; border:none; text-align:center; font-size: 2rem;">é£Ÿè­œåç¨±</h2>
            <div style="display:flex; justify-content:center; gap: 10px; margin-bottom: 20px;">
                <span class="badge">åŸºæº–: <span id="detail-base-servings"></span> äººä»½</span>
            </div>
            <div style="display:flex; justify-content:center; gap:10px;">
                <button class="btn btn-sm btn-outline" onclick="app.editCurrentRecipe()">ç·¨è¼¯é£Ÿè­œ</button>
                <button class="btn btn-sm btn-danger" onclick="app.deleteCurrentRecipe()" style="border:none;">åˆªé™¤</button>
            </div>
        </div>

        <div class="calc-box">
            <label for="target-servings" style="color:var(--accent-dark);">ä»½é‡æ›ç®— (ç›®æ¨™äººæ•¸)</label>
            <div style="display:flex; gap:10px; align-items:flex-end;">
                <input type="number" id="target-servings" value="1" min="1" onchange="app.renderDetailCalculation()" style="margin-bottom:0; border-bottom-color: var(--accent);">
                <button class="btn btn-primary" onclick="app.renderDetailCalculation()">é‡æ–°è¨ˆç®—</button>
            </div>
            <div style="margin-top:20px; font-weight:bold; display:flex; justify-content:space-between; align-items: flex-end; border-top: 1px solid rgba(184,134,11,0.3); padding-top: 10px;">
                <span style="font-family: var(--font-serif); font-style:italic;">é ä¼°ç¸½æˆæœ¬</span>
                <span class="price" id="detail-total-cost" style="font-size: 1.5rem;">0.00</span>
            </div>
        </div>

        <h3 style="text-align: center; margin-top: 40px;">é£Ÿæèˆ‡æˆæœ¬æ˜ç´°</h3>
        <div class="table-container">
            <table id="detail-table">
                <thead>
                    <tr>
                        <th>å“é …</th>
                        <th>æ•¸é‡</th>
                        <th>å–®ä½</th>
                        <th class="text-right">æˆæœ¬</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
        <button class="btn btn-outline btn-block" onclick="app.navTo('list')">è¿”å›åˆ—è¡¨</button>
    </div>

    <div id="view-edit" class="view">
        <h2 id="edit-view-title">æ–°å¢é£Ÿè­œ</h2>
        
        <label>é£Ÿè­œåç¨±</label>
        <input type="text" id="edit-name" placeholder="ä¾‹å¦‚ï¼šæ³•å¼ç´…é…’ç‡‰ç‰›è‚‰">
        
        <label>åŸºæº–ä»½æ•¸ (äºº)</label>
        <input type="number" id="edit-base-servings" value="4" min="1">
        
        <label>å°é¢åœ–ç‰‡ (é¸å¡«)</label>
        <input type="file" id="edit-image-input" accept="image/*" onchange="app.handleImageUpload(this)" style="border:none;">
        <div id="edit-image-preview-container" class="hidden" style="margin-bottom:20px; text-align:center;">
            <img id="edit-image-preview" src="" style="max-height: 200px; border: 1px solid var(--border); padding: 5px;">
            <br>
            <button class="btn btn-sm btn-danger" onclick="app.clearImage()" style="margin-top:10px;">ç§»é™¤åœ–ç‰‡</button>
        </div>

        <div style="display:flex; justify-content: space-between; align-items: center; margin-top: 30px; margin-bottom: 10px; border-bottom: 1px solid var(--border); padding-bottom: 5px;">
            <label style="margin:0;">æ‰€éœ€é£Ÿæ</label>
            <button class="btn btn-sm btn-outline" onclick="app.addIngredientRow()">+ åŠ å…¥é£Ÿæ</button>
        </div>
        
        <div id="edit-ingredients-list">
            </div>

        <div style="display:flex; gap:10px; margin-top: 40px;">
            <button class="btn btn-outline" style="flex:1" onclick="app.navTo('list')">å–æ¶ˆ</button>
            <button class="btn btn-primary" style="flex:1" onclick="app.saveRecipe()">å„²å­˜é£Ÿè­œ</button>
        </div>
    </div>

    <div id="view-settings" class="view">
        <h2>å–®ä½è¨­å®š</h2>
        <div style="display:flex; gap:5px; margin-bottom:20px; align-items: flex-end;">
            <div style="flex:1">
                <label>æ–°å–®ä½åç¨±</label>
                <input type="text" id="setting-unit-name" placeholder="ä¾‹å¦‚ï¼šç®±ã€æŠŠ" style="margin-bottom:0;">
            </div>
            <button class="btn btn-primary" onclick="app.addUnit()">æ–°å¢</button>
        </div>
        <div id="settings-unit-list" style="margin-bottom: 40px;"></div>

        <h2>é£Ÿæå¸‚åƒ¹ç®¡ç†</h2>
        <div style="background: var(--card-bg); padding: 20px; border:1px solid var(--accent); border-radius: var(--radius-md); margin-bottom:30px;">
            <label>é£Ÿæåç¨±</label>
            <input type="text" id="setting-ing-name" placeholder="ä¾‹å¦‚ï¼šæ¾éœ²æ²¹">
            <div style="display:flex; gap:10px; margin-bottom: 10px;">
                <div style="flex:1">
                    <label>å–®åƒ¹</label>
                    <input type="number" id="setting-ing-price" placeholder="0.00" step="0.01">
                </div>
                <div style="flex:1">
                    <label>è¨ˆåƒ¹å–®ä½</label>
                    <select id="setting-ing-unit" style="margin-bottom:20px;"></select>
                </div>
            </div>
            <button class="btn btn-primary btn-block" onclick="app.addIngredient()">æ›´æ–°/æ–°å¢é£Ÿæ</button>
        </div>
        
        <div id="settings-ing-list"></div>
    </div>

    <div id="view-io" class="view">
        <h2>å‚™ä»½èˆ‡é‚„åŸ</h2>
        <p style="font-size: 0.9rem; color: var(--muted); font-family: var(--font-serif);">
            æ‚¨çš„é£Ÿè­œè³‡æ–™å„²å­˜åœ¨æ­¤ç€è¦½å™¨ä¸­ã€‚è‹¥è¦æ›´æ›è£ç½®ï¼Œè«‹è¤‡è£½ä¸‹æ–¹çš„ JSON ä»£ç¢¼é€²è¡Œè½‰ç§»ã€‚
        </p>
        
        <label>è³‡æ–™ä»£ç¢¼ (JSON)</label>
        <textarea id="io-textarea" rows="10" style="font-family: var(--font-mono); font-size: 0.8rem; background: #fff; padding: 10px; border: 1px solid var(--border);"></textarea>
        
        <div style="display:flex; gap:10px; margin-bottom:20px; margin-top: 10px;">
            <button class="btn btn-secondary" style="flex:1" onclick="app.exportData()">é¡¯ç¤ºè³‡æ–™ (åŒ¯å‡º)</button>
            <button class="btn btn-danger" style="flex:1" onclick="app.importData()">åŸ·è¡Œé‚„åŸ</button>
        </div>
        <button class="btn btn-outline btn-block" onclick="app.navTo('list')">è¿”å›</button>
    </div>

</div>

<nav>
    <button onclick="app.navTo('list')" id="nav-list" class="active">
        <svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>
        é£Ÿè­œåˆ—è¡¨
    </button>
    <button onclick="app.navTo('settings')" id="nav-settings">
        <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.57 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
        åå¥½è¨­å®š
    </button>
</nav>

<div id="toast">è¨Šæ¯æç¤º</div>

<script>
/**
 * Application Logic
 */

const CONSTANTS = {
    STORE_KEY: 'recipe_app_v1',
    IMG_PLACEHOLDER: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2YwZjBmMCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iI2YwZjBmMCIvPjwvc3ZnPg=='
};

// --- State Management ---
const defaultState = {
    units: [
        { id: 'u1', name: 'g' },
        { id: 'u2', name: 'ml' },
        { id: 'u3', name: 'å€‹' },
        { id: 'u4', name: 'å°æ–¤' }
    ],
    ingredients: [], 
    recipes: [] 
};

let appState = JSON.parse(JSON.stringify(defaultState));
let editingRecipeId = null;
let currentDetailRecipeId = null;

// --- Helper Functions ---
const uuid = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
const getEl = (id) => document.getElementById(id);

const storage = {
    save: () => {
        try {
            localStorage.setItem(CONSTANTS.STORE_KEY, JSON.stringify(appState));
        } catch (e) {
            toast('å„²å­˜å¤±æ•—ï¼åœ–ç‰‡å¯èƒ½éå¤§ã€‚');
        }
    },
    load: () => {
        const data = localStorage.getItem(CONSTANTS.STORE_KEY);
        if (data) {
            try {
                const parsed = JSON.parse(data);
                appState = { ...defaultState, ...parsed }; 
                if(!appState.units) appState.units = defaultState.units;
                if(!appState.ingredients) appState.ingredients = [];
                if(!appState.recipes) appState.recipes = [];
            } catch (e) {
                console.error("Data Parse Error", e);
                appState = JSON.parse(JSON.stringify(defaultState));
            }
        }
    },
    clear: () => localStorage.removeItem(CONSTANTS.STORE_KEY)
};

const toast = (msg) => {
    const el = getEl('toast');
    el.textContent = msg;
    el.className = 'show';
    setTimeout(() => { el.className = el.className.replace('show', ''); }, 3000);
};

// --- Image Handling ---
const resizeImage = (file, maxWidth = 500) => {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (event) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                
                if (width > maxWidth) {
                    height = Math.round((height * maxWidth) / width);
                    width = maxWidth;
                }
                
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                resolve(canvas.toDataURL('image/jpeg', 0.7)); 
            };
            img.src = event.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
};

// --- App Controller ---
const app = {
    init: () => {
        storage.load();
        app.navTo('list');
        
        getEl('btn-export-import').addEventListener('click', () => {
            app.navTo('io');
            getEl('io-textarea').value = '';
        });
    },

    navTo: (viewName) => {
        document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('nav button').forEach(el => el.classList.remove('active'));
        
        const target = getEl(`view-${viewName}`);
        if(target) target.classList.add('active');

        if (viewName === 'list' || viewName === 'detail') getEl('nav-list').classList.add('active');
        if (viewName === 'settings') getEl('nav-settings').classList.add('active');
        
        if (viewName === 'list') app.renderRecipeList();
        if (viewName === 'settings') app.renderSettings();
        if (viewName === 'edit' && editingRecipeId === null) app.initEditForm(); 
        
        window.scrollTo(0,0);
    },

    // --- Search & List ---
    handleSearch: () => {
        app.renderRecipeList(getEl('search-input').value);
    },

    renderRecipeList: (keyword = '') => {
        const list = getEl('recipe-list-container');
        list.innerHTML = '';
        
        const filtered = appState.recipes.filter(r => r.name.toLowerCase().includes(keyword.toLowerCase()));
        
        if (filtered.length === 0) {
            list.innerHTML = `<div class="empty-state">${keyword ? 'æ‰¾ä¸åˆ°ç¬¦åˆçš„é£Ÿè­œã€‚' : 'å°šç„¡é£Ÿè­œï¼Œè«‹é»æ“Š + æ–°å¢ã€‚'}</div>`;
            return;
        }

        filtered.forEach(r => {
            const div = document.createElement('div');
            div.className = 'card';
            div.onclick = () => app.openDetail(r.id);
            div.innerHTML = `
                <img src="${r.image || CONSTANTS.IMG_PLACEHOLDER}" class="card-img" loading="lazy">
                <div class="card-content">
                    <div class="card-title">${r.name}</div>
                    <div class="card-subtitle">ä»½é‡: ${r.baseServings} äºº â€¢ é£Ÿæ: ${r.ingredients.length} é …</div>
                </div>
                <div style="color:var(--accent); font-size:1.2rem;">â€º</div>
            `;
            list.appendChild(div);
        });
    },

    // --- Detail View ---
    openDetail: (id) => {
        currentDetailRecipeId = id;
        const r = appState.recipes.find(x => x.id === id);
        if (!r) return;

        getEl('detail-title').textContent = r.name;
        getEl('detail-base-servings').textContent = r.baseServings;
        getEl('detail-image').src = r.image || CONSTANTS.IMG_PLACEHOLDER;
        getEl('target-servings').value = r.baseServings; 

        app.renderDetailCalculation();
        app.navTo('detail');
    },

    renderDetailCalculation: () => {
        const r = appState.recipes.find(x => x.id === currentDetailRecipeId);
        if (!r) return;

        const target = parseFloat(getEl('target-servings').value) || 0;
        const ratio = target / r.baseServings;
        
        const tbody = getEl('detail-table').querySelector('tbody');
        tbody.innerHTML = '';
        
        let totalCost = 0;

        r.ingredients.forEach(ri => {
            const ingDef = appState.ingredients.find(i => i.id === ri.ingredientId);
            if (!ingDef) return; 
            
            const unitDef = appState.units.find(u => u.id === ingDef.unitId);
            const unitName = unitDef ? unitDef.name : '?';
            
            const amount = ri.amount * ratio;
            const cost = amount * ingDef.price;
            totalCost += cost;

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="font-weight:600;">${ingDef.name}</td>
                <td>${Number.isInteger(amount) ? amount : amount.toFixed(1)}</td>
                <td style="color:#888;">${unitName}</td>
                <td class="text-right price">${cost.toFixed(2)}</td>
            `;
            tbody.appendChild(tr);
        });

        getEl('detail-total-cost').textContent = totalCost.toFixed(2);
    },

    deleteCurrentRecipe: () => {
        if(confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹é£Ÿè­œå—ï¼Ÿ')) {
            appState.recipes = appState.recipes.filter(r => r.id !== currentDetailRecipeId);
            storage.save();
            toast('åˆªé™¤æˆåŠŸ');
            app.navTo('list');
        }
    },

    // --- Edit / Create ---
    editCurrentRecipe: () => {
        editingRecipeId = currentDetailRecipeId;
        app.initEditForm();
        app.navTo('edit');
    },

    initEditForm: () => {
        const title = getEl('edit-view-title');
        const list = getEl('edit-ingredients-list');
        list.innerHTML = '';

        if (editingRecipeId) {
            // Edit Mode
            const r = appState.recipes.find(x => x.id === editingRecipeId);
            title.textContent = "ç·¨è¼¯é£Ÿè­œ";
            getEl('edit-name').value = r.name;
            getEl('edit-base-servings').value = r.baseServings;
            
            if (r.image) {
                getEl('edit-image-preview').src = r.image;
                getEl('edit-image-preview-container').classList.remove('hidden');
            } else {
                app.clearImage();
            }

            r.ingredients.forEach(item => {
                app.addIngredientRow(item.ingredientId, item.amount);
            });
        } else {
            // Create Mode
            title.textContent = "æ–°å¢é£Ÿè­œ";
            getEl('edit-name').value = '';
            getEl('edit-base-servings').value = 4;
            app.clearImage();
            app.addIngredientRow(); 
        }
    },

    addIngredientRow: (selectedId = '', amount = '') => {
        const container = getEl('edit-ingredients-list');
        const div = document.createElement('div');
        div.className = 'ingredient-row';
        
        let options = '<option value="" disabled selected>é¸æ“‡é£Ÿæ</option>';
        appState.ingredients.forEach(ing => {
            const unit = appState.units.find(u => u.id === ing.unitId);
            const unitName = unit ? unit.name : '';
            const selected = ing.id === selectedId ? 'selected' : '';
            options += `<option value="${ing.id}" ${selected}>${ing.name} (${unitName})</option>`;
        });

        div.innerHTML = `
            <select class="ing-select">${options}</select>
            <input type="number" class="ing-amount" placeholder="æ•¸é‡" value="${amount}" step="any">
            <button class="btn btn-sm btn-danger" style="border:none; color:#999;" onclick="this.parentElement.remove()">Ã—</button>
        `;
        container.appendChild(div);
    },

    handleImageUpload: async (input) => {
        if (input.files && input.files[0]) {
            try {
                const base64 = await resizeImage(input.files[0]);
                getEl('edit-image-preview').src = base64;
                getEl('edit-image-preview-container').classList.remove('hidden');
            } catch (e) {
                alert('åœ–ç‰‡è™•ç†å¤±æ•—');
            }
        }
    },

    clearImage: () => {
        getEl('edit-image-input').value = '';
        getEl('edit-image-preview').src = '';
        getEl('edit-image-preview-container').classList.add('hidden');
    },

    saveRecipe: () => {
        const name = getEl('edit-name').value.trim();
        const baseServings = parseFloat(getEl('edit-base-servings').value);
        if (!name || !baseServings) { alert('è«‹å¡«å¯«é£Ÿè­œåç¨±èˆ‡åŸºæº–ä»½æ•¸'); return; }

        const rows = document.querySelectorAll('.ingredient-row');
        const ingredients = [];
        
        for (let row of rows) {
            const id = row.querySelector('.ing-select').value;
            const amount = parseFloat(row.querySelector('.ing-amount').value);
            if (id && amount) {
                ingredients.push({ ingredientId: id, amount: amount });
            }
        }

        const imgData = getEl('edit-image-preview').getAttribute('src');
        const finalImg = (imgData && imgData.startsWith('data:')) ? imgData : null;

        const newRecipe = {
            id: editingRecipeId || uuid(),
            name,
            baseServings,
            image: finalImg,
            ingredients
        };

        if (editingRecipeId) {
            const idx = appState.recipes.findIndex(r => r.id === editingRecipeId);
            appState.recipes[idx] = newRecipe;
        } else {
            appState.recipes.push(newRecipe);
        }

        storage.save();
        toast('é£Ÿè­œå·²å„²å­˜');
        editingRecipeId = null; 
        app.navTo('list');
    },

    // --- Settings (Units & Ingredients) ---
    renderSettings: () => {
        const unitSelect = getEl('setting-ing-unit');
        unitSelect.innerHTML = '';
        appState.units.forEach(u => {
            unitSelect.innerHTML += `<option value="${u.id}">${u.name}</option>`;
        });

        const unitList = getEl('settings-unit-list');
        unitList.innerHTML = '';
        appState.units.forEach(u => {
            const div = document.createElement('div');
            div.className = 'settings-item';
            div.innerHTML = `<span>${u.name}</span> <button class="btn btn-sm btn-danger" onclick="app.deleteUnit('${u.id}')" style="border:none;">åˆªé™¤</button>`;
            unitList.appendChild(div);
        });

        const ingList = getEl('settings-ing-list');
        ingList.innerHTML = '';
        appState.ingredients.forEach(i => {
            const u = appState.units.find(unit => unit.id === i.unitId);
            const uName = u ? u.name : '?';
            const div = document.createElement('div');
            div.className = 'settings-item';
            div.innerHTML = `
                <div style="flex:1">
                    <strong style="font-family:var(--font-serif); font-size:1.1rem;">${i.name}</strong><br>
                    <small style="color:var(--muted); font-family:var(--font-mono);">$${i.price} / ${uName}</small>
                </div>
                <button class="btn btn-sm btn-danger" onclick="app.deleteIngredient('${i.id}')" style="border:none;">åˆªé™¤</button>
            `;
            ingList.appendChild(div);
        });
    },

    addUnit: () => {
        const name = getEl('setting-unit-name').value.trim();
        if (!name) return;
        appState.units.push({ id: uuid(), name });
        getEl('setting-unit-name').value = '';
        storage.save();
        app.renderSettings();
    },

    deleteUnit: (id) => {
        const isUsed = appState.ingredients.some(i => i.unitId === id);
        if (isUsed) { alert('ç„¡æ³•åˆªé™¤ï¼šæœ‰é£Ÿææ­£åœ¨ä½¿ç”¨æ­¤å–®ä½ã€‚'); return; }
        
        if (confirm('ç¢ºå®šåˆªé™¤æ­¤å–®ä½ï¼Ÿ')) {
            appState.units = appState.units.filter(u => u.id !== id);
            storage.save();
            app.renderSettings();
        }
    },

    addIngredient: () => {
        const name = getEl('setting-ing-name').value.trim();
        const price = parseFloat(getEl('setting-ing-price').value);
        const unitId = getEl('setting-ing-unit').value;

        if (!name || isNaN(price) || !unitId) { alert('è«‹å®Œæ•´å¡«å¯«è³‡è¨Šã€‚'); return; }

        appState.ingredients.push({ id: uuid(), name, price, unitId });
        
        getEl('setting-ing-name').value = '';
        getEl('setting-ing-price').value = '';
        storage.save();
        app.renderSettings();
        toast('å¸‚åƒ¹è¡¨å·²æ›´æ–°');
    },

    deleteIngredient: (id) => {
        let usedIn = [];
        appState.recipes.forEach(r => {
            if (r.ingredients.some(ri => ri.ingredientId === id)) usedIn.push(r.name);
        });

        if (usedIn.length > 0) {
            alert(`ç„¡æ³•åˆªé™¤ï¼šä»¥ä¸‹é£Ÿè­œæ­£åœ¨ä½¿ç”¨æ­¤é£Ÿæ\n${usedIn.join(', ')}`);
            return;
        }

        if (confirm('ç¢ºå®šåˆªé™¤æ­¤é£Ÿæï¼Ÿ')) {
            appState.ingredients = appState.ingredients.filter(i => i.id !== id);
            storage.save();
            app.renderSettings();
        }
    },

    // --- Import / Export ---
    exportData: () => {
        const json = JSON.stringify(appState, null, 2);
        getEl('io-textarea').value = json;
    },
    
    importData: () => {
        const raw = getEl('io-textarea').value;
        if (!raw) return;
        try {
            const data = JSON.parse(raw);
            if (!data.units || !data.recipes) throw new Error('Invalid Format');
            if (confirm('ç¢ºå®šè¦é‚„åŸå—ï¼Ÿç›®å‰çš„è³‡æ–™å°‡æœƒè¢«è¦†è“‹ä¸”ç„¡æ³•å¾©åŸã€‚')) {
                appState = data;
                storage.save();
                toast('é‚„åŸæˆåŠŸ');
                app.navTo('list');
            }
        } catch (e) {
            alert('JSON æ ¼å¼éŒ¯èª¤ã€‚');
        }
    }
};

// Start
document.addEventListener('DOMContentLoaded', app.init);

</script>
</body>
</html>
