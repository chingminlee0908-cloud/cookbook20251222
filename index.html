<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£Ÿè­œç®¡å®¶ | Final Fix</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>

    <style>
        /* --- Design Tokens --- */
        :root {
            --bg-morandi: #F2EAE4; --text-primary: #5E5451; --text-secondary: #8C8380;
            --accent-pink: #D48A96; --danger: #C47070; --success: #789c79;
            --neu-light: #FFFFFF; --neu-dark: #D3C6BC;
            --shadow-flat: 10px 10px 20px var(--neu-dark), -10px -10px 20px var(--neu-light);
            --shadow-pressed: inset 6px 6px 12px var(--neu-dark), inset -6px -6px 12px var(--neu-light);
            --radius-xl: 28px; --radius-pill: 50px;
            --font-main: 'Nunito', "PingFang TC", "Microsoft JhengHei", sans-serif;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        body { margin: 0; font-family: var(--font-main); background-color: var(--bg-morandi); color: var(--text-primary); padding-bottom: 130px; line-height: 1.7; }
        .container { max-width: 700px; margin: 0 auto; padding: 30px 24px; }
        
        /* UI Components */
        .card { background: var(--bg-morandi); border-radius: var(--radius-xl); padding: 24px; margin-bottom: 20px; box-shadow: var(--shadow-flat); display: flex; align-items: center; gap: 20px; transition: 0.3s; cursor: pointer; }
        .card:active { box-shadow: var(--shadow-pressed); transform: scale(0.98); }
        .card-img { width: 72px; height: 72px; border-radius: 50%; object-fit: cover; box-shadow: var(--shadow-pressed); padding: 4px; background: var(--bg-morandi); flex-shrink: 0; }
        .card-content { flex: 1; overflow: hidden; }
        .card-title { font-weight: 700; font-size: 1.25rem; margin-bottom: 5px; }
        
        input, select, textarea { width: 100%; padding: 14px 20px; margin-bottom: 20px; border: none; border-radius: var(--radius-pill); background: var(--bg-morandi); color: var(--text-primary); box-shadow: var(--shadow-pressed); font-size: 1rem; }
        textarea { border-radius: 20px; resize: vertical; }
        label { display: block; margin-bottom: 8px; font-size: 0.9rem; color: var(--accent-pink); font-weight: 700; margin-left: 12px; }
        
        .btn { padding: 12px 24px; border: none; border-radius: var(--radius-pill); background: var(--bg-morandi); color: var(--text-primary); box-shadow: var(--shadow-flat); font-weight: 700; transition: 0.2s; cursor: pointer; display: inline-flex; justify-content: center; align-items: center; }
        .btn:active { box-shadow: var(--shadow-pressed); transform: scale(0.96); }
        .btn-primary { color: var(--accent-pink); } 
        .btn-danger { color: var(--danger); }
        .btn-outline { box-shadow: 5px 5px 10px var(--neu-dark), -5px -5px 10px var(--neu-light); color: var(--text-secondary); }
        .btn-edit-mode { background: var(--text-secondary); color: white; box-shadow: inset 2px 2px 5px rgba(0,0,0,0.2); }
        
        .cat-chip { padding: 8px 20px; border-radius: var(--radius-pill); background: var(--bg-morandi); color: var(--text-secondary); box-shadow: 5px 5px 10px var(--neu-dark), -5px -5px 10px var(--neu-light); margin-right: 12px; display: inline-block; font-weight: 700; cursor: pointer; }
        .cat-chip.active { color: var(--accent-pink); box-shadow: var(--shadow-pressed); }
        
        /* Edit Mode Highlight Box */
        .editing-mode-box { border: 2px solid var(--accent-pink); position: relative; animation: pulseBorder 2s infinite; }
        .editing-mode-box::after { content: 'ç·¨è¼¯ä¸­'; position: absolute; top: -12px; left: 20px; background: var(--accent-pink); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; font-weight: bold; }
        @keyframes pulseBorder { 0% { border-color: var(--accent-pink); } 50% { border-color: rgba(212, 138, 150, 0.4); } 100% { border-color: var(--accent-pink); } }

        /* Step & Ingredient Rows */
        .ingredient-row, .step-row { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; }
        .ingredient-row select { width: 50%; margin-bottom: 0; }
        .ingredient-row input { width: 30%; margin-bottom: 0; }
        .step-row textarea { flex: 1; margin-bottom: 0; }
        .row-del-btn { width: 40px; height: 40px; border-radius: 50%; color: var(--danger); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; margin-bottom: 0; padding: 0; flex-shrink: 0; }

        /* Settings Item */
        .settings-item { background: var(--bg-morandi); box-shadow: 5px 5px 10px var(--neu-dark), -5px -5px 10px var(--neu-light); border-radius: 15px; padding: 15px 20px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .settings-item:active { box-shadow: var(--shadow-pressed); }

        /* Layout */
        .hidden { display: none !important; }
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        nav { position: fixed; bottom: 20px; left: 20px; right: 20px; background: var(--bg-morandi); border-radius: var(--radius-pill); box-shadow: 6px 6px 12px var(--neu-dark), -6px -6px 12px var(--neu-light); display: flex; justify-content: space-around; padding: 10px; z-index: 100; }
        nav button { background: none; border: none; color: var(--text-secondary); display: flex; flex-direction: column; align-items: center; font-size: 0.8rem; font-weight: 600; padding: 5px 15px; border-radius: 20px; transition: 0.2s; }
        nav button.active { color: var(--accent-pink); box-shadow: var(--shadow-pressed); }
        nav button svg { width: 24px; height: 24px; margin-bottom: 2px; fill: currentColor; }

        #toast { visibility: hidden; min-width: 200px; background-color: var(--text-primary); color: #fff; text-align: center; border-radius: 50px; padding: 12px 24px; position: fixed; z-index: 200; left: 50%; bottom: 100px; transform: translateX(-50%); }
        #toast.show { visibility: visible; animation: fadein 0.3s, fadeout 0.3s 2.5s; }
        @keyframes fadein { from {bottom: 80px; opacity: 0;} to {bottom: 100px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 100px; opacity: 1;} to {bottom: 80px; opacity: 0;} }
        
        /* Modal & Overlay */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 150; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal { background: var(--bg-morandi); width: 90%; max-width: 500px; max-height: 80vh; border-radius: 20px; overflow-y: auto; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<div class="container">
    <div id="view-list" class="view active">
        <h1 style="text-align: center; margin-bottom: 20px; color: var(--accent-pink);">é£Ÿè­œç®¡å®¶</h1>
        
        <div style="overflow-x: auto; white-space: nowrap; padding-bottom: 10px; margin-bottom: 10px;" id="cat-filters">
            </div>

        <div style="position: relative; margin-bottom: 20px;">
            <input type="text" id="search-input" placeholder="ğŸ” æœå°‹é£Ÿè­œ..." oninput="app.handleSearch()">
        </div>

        <div style="text-align: center; margin-bottom: 20px; border: 2px dashed #ccc; border-radius: 15px; padding: 15px; cursor: pointer;" onclick="document.getElementById('scan-input').click()">
            ğŸ“· <b>æ™ºæ…§åŒ¯å…¥ (åœ–ç‰‡/Word)</b>
            <input type="file" id="scan-input" accept="image/*,.docx" class="hidden" onchange="app.handleScan(this)">
        </div>

        <div id="recipe-list"></div>
        
        <button class="fab" style="position: fixed; bottom: 100px; right: 20px; width: 60px; height: 60px; border-radius: 50%; border: none; background: var(--accent-pink); color: white; font-size: 2rem; box-shadow: 5px 5px 15px rgba(0,0,0,0.2);" onclick="app.navTo('edit')">+</button>
    </div>

    <div id="view-detail" class="view">
        <div style="text-align: center;">
            <img id="detail-img" src="" style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 5px solid var(--bg-morandi); box-shadow: var(--shadow-pressed);">
            <h2 id="detail-title" style="margin: 10px 0 5px;">Title</h2>
            <div id="detail-cat" style="color: var(--accent-pink); font-weight: bold;">Category</div>
        </div>

        <div style="display: flex; gap: 10px; justify-content: center; margin: 20px 0;">
            <button class="btn" onclick="app.editRecipe()">ç·¨è¼¯</button>
            <button class="btn btn-danger" onclick="app.deleteRecipe()">åˆªé™¤</button>
        </div>

        <div style="background: var(--bg-morandi); padding: 20px; border-radius: 20px; box-shadow: var(--shadow-pressed); margin-bottom: 20px;">
            <label style="text-align: center;">ç›®æ¨™ä»½æ•¸ (åŸºæº–: <span id="detail-base"></span>äºº)</label>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <input type="number" id="calc-target" value="1" min="1" style="width: 80px; margin: 0; text-align: center;">
                <button class="btn btn-primary" onclick="app.calcCost()">è¨ˆç®—</button>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 15px; border-top: 1px solid #ccc; padding-top: 10px;">
                <span>é ä¼°æˆæœ¬</span>
                <span id="calc-total" style="font-size: 1.5rem; color: var(--accent-pink); font-weight: bold;">$0</span>
            </div>
        </div>

        <h3>é£Ÿææ˜ç´°</h3>
        <div id="detail-ings"></div>

        <h3 style="margin-top: 20px;">è£½ä½œæ­¥é©Ÿ</h3>
        <div id="detail-steps"></div>

        <button class="btn btn-outline" style="width: 100%; margin-top: 30px;" onclick="app.navTo('list')">è¿”å›åˆ—è¡¨</button>
    </div>

    <div id="view-edit" class="view">
        <h2 id="edit-title">æ–°å¢/ç·¨è¼¯é£Ÿè­œ</h2>
        <label>é£Ÿè­œåç¨±</label><input type="text" id="edit-name">
        <label>åˆ†é¡</label><select id="edit-cat"></select>
        <label>åŸºæº–ä»½æ•¸</label><input type="number" id="edit-servings">
        
        <label>å°é¢åœ–ç‰‡</label>
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:20px;">
            <button class="btn" onclick="document.getElementById('edit-file').click()">é¸æ“‡åœ–ç‰‡</button>
            <input type="file" id="edit-file" class="hidden" accept="image/*" onchange="app.handleImg(this)">
            <img id="edit-preview" src="" style="width: 50px; height: 50px; border-radius: 10px; object-fit: cover; display: none;">
            <button id="edit-clear-img" class="btn btn-danger hidden" onclick="app.clearImg()">X</button>
        </div>

        <label>é£Ÿææ¸…å–®</label>
        <div id="edit-ing-list"></div>
        <button class="btn btn-sm" onclick="app.addIngRow()">+ åŠ å…¥é£Ÿæ</button>

        <label style="margin-top: 20px;">è£½ä½œæ­¥é©Ÿ</label>
        <div id="edit-step-list"></div>
        <button class="btn btn-sm" onclick="app.addStepRow()">+ åŠ å…¥æ­¥é©Ÿ</button>

        <div style="display: flex; gap: 10px; margin-top: 30px;">
            <button class="btn btn-outline" style="flex: 1;" onclick="app.navTo('list')">å–æ¶ˆ</button>
            <button class="btn btn-primary" style="flex: 1;" onclick="app.saveRecipe()">å„²å­˜</button>
        </div>
    </div>

    <div id="view-settings" class="view">
        
        <div id="cat-form-box" style="padding: 20px; border-radius: 20px; background: var(--bg-morandi); box-shadow: var(--shadow-pressed); margin-bottom: 20px;">
            <h3 style="margin-top: 0;">åˆ†é¡ç®¡ç†</h3>
            <p style="font-size: 0.8rem; color: #888;">é»æ“Šä¸‹æ–¹åˆ—è¡¨é …ç›®å¯ä¿®æ”¹</p>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="set-cat-name" placeholder="åˆ†é¡åç¨±" style="margin: 0;">
                <button id="btn-cat-save" class="btn btn-primary" onclick="app.saveCategory()">æ–°å¢</button>
                <button id="btn-cat-cancel" class="btn btn-outline hidden" onclick="app.cancelCatEdit()">å–æ¶ˆ</button>
            </div>
        </div>
        <div id="set-cat-list" style="margin-bottom: 40px;"></div>

        <div id="ing-form-box" style="padding: 20px; border-radius: 20px; background: var(--bg-morandi); box-shadow: var(--shadow-pressed); margin-bottom: 20px;">
            <h3 style="margin-top: 0;">é£Ÿæå¸‚åƒ¹åº«</h3>
            <p style="font-size: 0.8rem; color: #888;">é»æ“Šä¸‹æ–¹åˆ—è¡¨é …ç›®å¯ä¿®æ”¹</p>
            <input type="text" id="set-ing-name" placeholder="é£Ÿæåç¨±">
            <div style="display: flex; gap: 10px;">
                <input type="number" id="set-ing-price" placeholder="å–®åƒ¹">
                <input type="text" id="set-ing-unit" placeholder="å–®ä½">
            </div>
            <div style="display: flex; gap: 10px;">
                <button id="btn-ing-save" class="btn btn-primary" style="flex: 1;" onclick="app.saveIngredient()">æ–°å¢é£Ÿæ</button>
                <button id="btn-ing-cancel" class="btn btn-outline hidden" style="flex: 1;" onclick="app.cancelIngEdit()">å–æ¶ˆ</button>
            </div>
        </div>
        <div id="set-ing-list"></div>

        <div style="margin-top: 50px; padding-top: 20px; border-top: 2px dashed #ccc;">
            <h3>è³‡æ–™å‚™ä»½èˆ‡é‚„åŸ</h3>
            <button class="btn btn-outline" style="width: 100%;" onclick="app.navTo('io')">é€²å…¥å‚™ä»½é‚„åŸé é¢</button>
        </div>
    </div>

    <div id="view-io" class="view">
        <h2>å‚™ä»½èˆ‡é‚„åŸ</h2>
        <textarea id="io-text" rows="10" placeholder="JSON Data..." style="font-family: monospace;"></textarea>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-outline" style="flex: 1;" onclick="app.exportJson()">åŒ¯å‡º (ä¸‹è¼‰)</button>
            <button class="btn btn-danger" style="flex: 1;" onclick="app.importJson()">åŒ¯å…¥ (ä¸Šå‚³)</button>
        </div>
        <button class="btn" style="width: 100%; margin-top: 20px;" onclick="app.navTo('settings')">è¿”å›</button>
    </div>
</div>

<nav>
    <button id="nav-list" onclick="app.navTo('list')"><svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>é£Ÿè­œ</button>
    <button id="nav-settings" onclick="app.navTo('settings')"><svg viewBox="0 0 24 24"><path d="M17 9l-4-6-4 6H2v13h20V9z"/></svg>è³‡æ–™åº«</button>
</nav>

<div id="loading" class="overlay hidden"><div style="color: white; font-size: 1.5rem; font-weight: bold;">Loading...</div></div>
<div id="toast">Msg</div>

<div id="scan-modal" class="overlay hidden">
    <div class="modal">
        <h3>æ™ºæ…§åŒ¯å…¥ç¢ºèª</h3>
        <label>åç¨±</label><input type="text" id="scan-res-name">
        <label>é£Ÿæ (åŸå§‹æ–‡å­—)</label><textarea id="scan-res-ings" rows="5"></textarea>
        <label>æ­¥é©Ÿ (åŸå§‹æ–‡å­—)</label><textarea id="scan-res-steps" rows="5"></textarea>
        <div style="display: flex; gap: 10px;">
            <button class="btn" onclick="document.getElementById('scan-modal').classList.add('hidden')" style="flex:1;">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="app.applyScan()" style="flex:1;">åŒ¯å…¥</button>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// --- REPLACE THIS WITH YOUR CONFIG ---
const firebaseConfig = {
  apiKey: "AIzaSyBAwloed-9fPTOJmc4dlZptIN_lV9Kd7k8",
  authDomain: "cookbook-93de8.firebaseapp.com",
  projectId: "cookbook-93de8",
  storageBucket: "cookbook-93de8.firebasestorage.app",
  messagingSenderId: "443155806046",
  appId: "1:443155806046:web:16368ec4a8598a7aafc1cf",
  measurementId: "G-TJWN4KRCHT"
};

const appInstance = initializeApp(firebaseConfig);
const db = getFirestore(appInstance);

// --- GLOBAL VARIABLES ---
let state = { categories: [], ingredients: [], recipes: [] };
let editRecipeId = null;
let editIngId = null; // For Ingredient Edit
let editCatId = null; // For Category Edit (New)
let currentDetailId = null;
let currentFilter = 'all';

// --- DOM HELPERS ---
const get = (id) => document.getElementById(id);
const show = (id) => get(id).classList.remove('hidden');
const hide = (id) => get(id).classList.add('hidden');
const toast = (msg) => { const t=get('toast'); t.innerText=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2000); };
const uuid = () => Date.now().toString(36) + Math.random().toString(36).substr(2);

// --- DB API ---
const api = {
    save: async (coll, data) => { try { await setDoc(doc(db, coll, data.id), data); } catch(e){ alert('Save Error'); console.error(e); } },
    del: async (coll, id) => { try { await deleteDoc(doc(db, coll, id)); } catch(e){ alert('Delete Error'); } }
};

// --- APP LOGIC ---
window.app = {
    init: () => {
        show('loading');
        // Listeners
        onSnapshot(collection(db, 'categories'), s => { state.categories = s.docs.map(d=>d.data()); app.render(); });
        onSnapshot(collection(db, 'ingredients'), s => { state.ingredients = s.docs.map(d=>d.data()); app.render(); });
        onSnapshot(collection(db, 'recipes'), s => { 
            state.recipes = s.docs.map(d=>d.data()); 
            app.render(); 
            hide('loading');
        });
    },

    navTo: (view) => {
        document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
        get('view-'+view).classList.add('active');
        
        // Nav Active State
        get('nav-list').classList.toggle('active', view === 'list' || view === 'detail');
        get('nav-settings').classList.toggle('active', ['settings', 'io', 'categories'].includes(view));

        // State Cleanup when leaving pages
        if (view === 'settings') { app.cancelIngEdit(); app.cancelCatEdit(); }
        if (view === 'edit' && editRecipeId === null) app.resetEditForm(); // New Recipe
        
        window.scrollTo(0,0);
        app.render();
    },

    render: () => {
        // Decide what to render based on visible view (Primitive Router)
        if(get('view-list').classList.contains('active')) app.renderList();
        if(get('view-detail').classList.contains('active') && currentDetailId) app.renderDetail();
        if(get('view-settings').classList.contains('active')) app.renderSettings();
    },

    // --- LIST & FILTER ---
    handleSearch: () => app.renderList(),
    setFilter: (id) => { currentFilter = id; app.renderList(); },
    renderList: () => {
        const keyword = get('search-input').value.toLowerCase();
        const box = get('recipe-list-container'); // Note: ID in HTML was 'recipe-list' in previous html block, fixed below
        
        // Chips
        const chips = get('cat-filters');
        let html = `<span class="cat-chip ${currentFilter==='all'?'active':''}" onclick="app.setFilter('all')">å…¨éƒ¨</span>`;
        html += `<span class="cat-chip ${currentFilter==='none'?'active':''}" onclick="app.setFilter('none')">æœªåˆ†é¡</span>`;
        state.categories.forEach(c => {
            html += `<span class="cat-chip ${currentFilter===c.id?'active':''}" onclick="app.setFilter('${c.id}')">${c.name}</span>`;
        });
        chips.innerHTML = html;

        // Recipes
        const list = get('recipe-list');
        list.innerHTML = '';
        
        let filtered = state.recipes.filter(r => r.name.toLowerCase().includes(keyword));
        if (currentFilter !== 'all') {
            if (currentFilter === 'none') filtered = filtered.filter(r => !r.categoryId);
            else filtered = filtered.filter(r => r.categoryId === currentFilter);
        }

        filtered.forEach(r => {
            const catName = state.categories.find(c => c.id === r.categoryId)?.name || '';
            const div = document.createElement('div'); div.className = 'card';
            div.onclick = () => { currentDetailId = r.id; app.navTo('detail'); };
            div.innerHTML = `
                <img src="${r.image || ''}" class="card-img" onerror="this.style.opacity=0">
                <div class="card-content">
                    <div class="card-title">${r.name}</div>
                    <div class="card-subtitle" style="color:var(--accent-pink)">${catName}</div>
                </div>
                <div style="font-size:1.5rem; color:var(--text-secondary)">â€º</div>
            `;
            list.appendChild(div);
        });
    },

    // --- DETAIL ---
    renderDetail: () => {
        const r = state.recipes.find(x => x.id === currentDetailId);
        if (!r) return app.navTo('list'); // deleted?

        get('detail-title').innerText = r.name;
        get('detail-base').innerText = r.baseServings;
        get('calc-target').value = r.baseServings;
        
        const cat = state.categories.find(c => c.id === r.categoryId);
        get('detail-cat').innerText = cat ? cat.name : 'æœªåˆ†é¡';
        
        const img = get('detail-img');
        if(r.image) { img.src = r.image; img.style.display = 'inline-block'; } 
        else { img.style.display = 'none'; }

        // Steps
        const sDiv = get('detail-steps'); sDiv.innerHTML = '';
        if(r.steps) r.steps.forEach((s,i) => {
            sDiv.innerHTML += `<div class="step-item"><div class="step-num">${i+1}</div><div style="flex:1">${s}</div></div>`;
        });

        app.calcCost(); // Render ingredients
    },
    calcCost: () => {
        const r = state.recipes.find(x => x.id === currentDetailId);
        if(!r) return;
        const target = parseFloat(get('calc-target').value) || 0;
        const ratio = target / (r.baseServings || 1);
        
        let total = 0;
        const div = get('detail-ings'); div.innerHTML = '';
        
        r.ingredients.forEach(ri => {
            const dbIng = state.ingredients.find(i => i.id === ri.ingredientId);
            if (!dbIng) return; // Deleted ingredient?
            
            const cost = dbIng.price * ri.amount * ratio;
            total += cost;
            
            div.innerHTML += `
                <div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding:10px 0;">
                    <span>${dbIng.name} <small style="color:#888">(${(ri.amount*ratio).toFixed(1)} ${dbIng.unit})</small></span>
                    <b>$${cost.toFixed(1)}</b>
                </div>
            `;
        });
        get('calc-total').innerText = '$' + total.toFixed(1);
    },
    deleteRecipe: () => { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { api.del('recipes', currentDetailId); app.navTo('list'); } },
    editRecipe: () => { editRecipeId = currentDetailId; app.navTo('edit'); app.fillEditForm(); },

    // --- EDIT RECIPE ---
    resetEditForm: () => {
        get('edit-title').innerText = 'æ–°å¢é£Ÿè­œ';
        get('edit-name').value = '';
        get('edit-servings').value = 4;
        get('edit-preview').src = ''; hide('edit-preview'); hide('edit-clear-img');
        get('edit-ing-list').innerHTML = '';
        get('edit-step-list').innerHTML = '';
        
        // Cat Select
        const sel = get('edit-cat'); sel.innerHTML = '<option value="">æœªåˆ†é¡</option>';
        state.categories.forEach(c => { sel.innerHTML += `<option value="${c.id}">${c.name}</option>`; });
        
        // Add 1 empty row
        app.addIngRow(); app.addStepRow();
    },
    fillEditForm: () => {
        app.resetEditForm();
        const r = state.recipes.find(x => x.id === editRecipeId);
        if(!r) return;
        
        get('edit-title').innerText = 'ç·¨è¼¯é£Ÿè­œ';
        get('edit-name').value = r.name;
        get('edit-cat').value = r.categoryId || '';
        get('edit-servings').value = r.baseServings;
        if(r.image) { get('edit-preview').src = r.image; show('edit-preview'); show('edit-clear-img'); }
        
        // Clear default empty rows
        get('edit-ing-list').innerHTML = '';
        get('edit-step-list').innerHTML = '';

        if(r.ingredients) r.ingredients.forEach(i => app.addIngRow(i.ingredientId, i.amount));
        if(r.steps) r.steps.forEach(s => app.addStepRow(s));
    },
    addIngRow: (ingId='', amt='') => {
        const div = document.createElement('div'); div.className = 'ingredient-row';
        let opts = '<option value="">è«‹é¸æ“‡é£Ÿæ</option>';
        state.ingredients.forEach(i => opts += `<option value="${i.id}" ${i.id===ingId?'selected':''}>${i.name}</option>`);
        div.innerHTML = `
            <select class="row-ing">${opts}</select>
            <input type="number" class="row-amt" value="${amt}" placeholder="æ•¸é‡">
            <button class="btn row-del-btn" onclick="this.parentElement.remove()">Ã—</button>
        `;
        get('edit-ing-list').appendChild(div);
    },
    addStepRow: (txt='') => {
        const div = document.createElement('div'); div.className = 'step-row';
        div.innerHTML = `
            <textarea class="row-step" rows="2" placeholder="æ­¥é©Ÿèªªæ˜...">${txt}</textarea>
            <button class="btn row-del-btn" onclick="this.parentElement.remove()">Ã—</button>
        `;
        get('edit-step-list').appendChild(div);
    },
    handleImg: (input) => {
        if(input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => { get('edit-preview').src = e.target.result; show('edit-preview'); show('edit-clear-img'); };
            reader.readAsDataURL(input.files[0]);
        }
    },
    clearImg: () => { get('edit-file').value=''; hide('edit-preview'); hide('edit-clear-img'); get('edit-preview').src=''; },
    saveRecipe: () => {
        const name = get('edit-name').value;
        if(!name) return alert('åç¨±å¿…å¡«');
        
        // Gather Ingredients
        const ings = [];
        document.querySelectorAll('.ingredient-row').forEach(row => {
            const iId = row.querySelector('.row-ing').value;
            const amt = parseFloat(row.querySelector('.row-amt').value);
            if(iId && amt) ings.push({ ingredientId: iId, amount: amt });
        });

        // Gather Steps
        const steps = [];
        document.querySelectorAll('.row-step').forEach(row => {
            if(row.value.trim()) steps.push(row.value.trim());
        });

        const data = {
            id: editRecipeId || uuid(),
            name: name,
            categoryId: get('edit-cat').value,
            baseServings: parseFloat(get('edit-servings').value) || 1,
            image: get('edit-preview').src.startsWith('data') ? get('edit-preview').src : null,
            ingredients: ings,
            steps: steps
        };

        api.save('recipes', data);
        toast('å„²å­˜æˆåŠŸ');
        editRecipeId = null;
        app.navTo('list');
    },

    // --- SETTINGS: INGREDIENTS (Fixed Edit Mode) ---
    renderSettings: () => {
        // 1. Categories List
        const cList = get('set-cat-list'); cList.innerHTML = '';
        state.categories.forEach(c => {
            const d = document.createElement('div'); d.className = 'settings-item';
            d.innerHTML = `<b>${c.name}</b><button class="btn btn-sm btn-danger" style="margin:0">X</button>`;
            // Click Text -> Edit
            d.querySelector('b').onclick = () => app.editCategory(c.id);
            // Click Btn -> Delete
            d.querySelector('button').onclick = (e) => { e.stopPropagation(); app.delCat(c.id); };
            cList.appendChild(d);
        });

        // 2. Ingredients List
        const iList = get('set-ing-list'); iList.innerHTML = '';
        state.ingredients.forEach(i => {
            const d = document.createElement('div'); d.className = 'settings-item';
            d.innerHTML = `
                <div>${i.name} <span style="color:#888">$${i.price}/${i.unit}</span></div>
                <button class="btn btn-sm btn-danger" style="margin:0">X</button>
            `;
            // Click Text -> Edit
            d.querySelector('div').onclick = () => app.editIngredient(i.id);
            d.querySelector('button').onclick = (e) => { e.stopPropagation(); app.delIng(i.id); };
            iList.appendChild(d);
        });
    },
    
    // Ingredient Edit Logic
    editIngredient: (id) => {
        const i = state.ingredients.find(x => x.id === id); if(!i) return;
        editIngId = id;
        get('set-ing-name').value = i.name;
        get('set-ing-price').value = i.price;
        get('set-ing-unit').value = i.unit;
        
        get('btn-ing-save').innerText = 'æ›´æ–°';
        get('btn-ing-save').classList.add('btn-edit-mode');
        show('btn-ing-cancel');
        get('ing-form-box').classList.add('editing-mode-box');
    },
    cancelIngEdit: () => {
        editIngId = null;
        get('set-ing-name').value = '';
        get('set-ing-price').value = '';
        get('set-ing-unit').value = '';
        get('btn-ing-save').innerText = 'æ–°å¢é£Ÿæ';
        get('btn-ing-save').classList.remove('btn-edit-mode');
        hide('btn-ing-cancel');
        get('ing-form-box').classList.remove('editing-mode-box');
    },
    saveIngredient: () => {
        const name = get('set-ing-name').value;
        const price = parseFloat(get('set-ing-price').value);
        const unit = get('set-ing-unit').value;
        if(!name || !unit) return toast('è«‹å¡«å¯«å®Œæ•´');
        
        api.save('ingredients', { id: editIngId || uuid(), name, price, unit });
        app.cancelIngEdit();
        toast('å·²å„²å­˜');
    },
    delIng: (id) => {
        if (editIngId === id) app.cancelIngEdit(); // Exit edit mode if deleting target
        if(confirm('åˆªé™¤?')) api.del('ingredients', id);
    },

    // --- SETTINGS: CATEGORIES (Fixed Edit Mode) ---
    editCategory: (id) => {
        const c = state.categories.find(x => x.id === id); if(!c) return;
        editCatId = id;
        get('set-cat-name').value = c.name;
        
        get('btn-cat-save').innerText = 'æ›´æ–°';
        get('btn-cat-save').classList.add('btn-edit-mode');
        show('btn-cat-cancel');
        get('cat-form-box').classList.add('editing-mode-box');
    },
    cancelCatEdit: () => {
        editCatId = null;
        get('set-cat-name').value = '';
        get('btn-cat-save').innerText = 'æ–°å¢';
        get('btn-cat-save').classList.remove('btn-edit-mode');
        hide('btn-cat-cancel');
        get('cat-form-box').classList.remove('editing-mode-box');
    },
    saveCategory: () => {
        const name = get('set-cat-name').value;
        if(!name) return;
        api.save('categories', { id: editCatId || uuid(), name });
        app.cancelCatEdit();
        toast('åˆ†é¡å·²å„²å­˜');
    },
    delCat: (id) => {
        if(state.recipes.some(r => r.categoryId === id)) return alert('æœ‰é£Ÿè­œä½¿ç”¨æ­¤åˆ†é¡ï¼Œç„¡æ³•åˆªé™¤');
        if(editCatId === id) app.cancelCatEdit();
        if(confirm('åˆªé™¤?')) api.del('categories', id);
    },

    // --- IO (Backup) ---
    exportData: async () => {
        const r = (await getDocs(collection(db,'recipes'))).docs.map(d=>d.data());
        const i = (await getDocs(collection(db,'ingredients'))).docs.map(d=>d.data());
        const c = (await getDocs(collection(db,'categories'))).docs.map(d=>d.data());
        get('io-text').value = JSON.stringify({recipes:r, ingredients:i, categories:c}, null, 2);
    },
    importData: async () => {
        try {
            const data = JSON.parse(get('io-text').value);
            if(!confirm('é€™å°‡è¦†å¯«é›²ç«¯è³‡æ–™ï¼Œç¢ºå®šï¼Ÿ')) return;
            show('loading');
            // Parallel uploads
            const promises = [];
            data.recipes.forEach(x => promises.push(api.save('recipes', x)));
            data.ingredients.forEach(x => promises.push(api.save('ingredients', x)));
            data.categories.forEach(x => promises.push(api.save('categories', x)));
            await Promise.all(promises);
            hide('loading');
            toast('é‚„åŸå®Œæˆ');
        } catch(e) { alert('JSON éŒ¯èª¤'); hide('loading'); }
    },

    // --- SCAN ---
    handleScan: async (input) => {
        if(!input.files[0]) return;
        show('loading');
        try {
            let text = '';
            if(input.files[0].name.endsWith('.docx')) {
                const buf = await input.files[0].arrayBuffer();
                const res = await mammoth.extractRawText({arrayBuffer: buf});
                text = res.value;
            } else {
                const res = await Tesseract.recognize(input.files[0], 'chi_tra+eng');
                text = res.data.text;
            }
            
            const lines = text.split(/\r?\n/).filter(x => x.trim());
            get('scan-res-name').value = lines[0] || 'æœªå‘½å';
            
            const ings = [], steps = [];
            for(let i=1; i<lines.length; i++) {
                // Heuristic: line with numbers is ingredient, long line without numbers is step
                if(/\d/.test(lines[i]) && lines[i].length < 15) ings.push(lines[i]);
                else steps.push(lines[i]);
            }
            
            get('scan-res-ings').value = ings.join('\n');
            get('scan-res-steps').value = steps.join('\n');
            
            hide('loading');
            show('scan-modal');
        } catch(e) { hide('loading'); alert('Scan Fail'); }
        input.value = '';
    },
    applyScan: async () => {
        const name = get('scan-res-name').value;
        const ingRaw = get('scan-res-ings').value.split('\n');
        const stepRaw = get('scan-res-steps').value.split('\n');
        
        // Auto-create ingredients logic
        const finalIngs = [];
        for(let line of ingRaw) {
            const ingName = line.replace(/[0-9.]/g, '').trim();
            const amt = parseFloat(line.match(/(\d+(\.\d+)?)/)?.[0]) || 0;
            if(!ingName) continue;
            
            let ingId = uuid();
            const exist = state.ingredients.find(i => i.name === ingName);
            if(exist) ingId = exist.id;
            else await api.save('ingredients', {id: ingId, name: ingName, price: 0, unit: 'g'});
            
            finalIngs.push({ ingredientId: ingId, amount: amt });
        }

        const newR = {
            id: uuid(), name, baseServings: 1, categoryId: '',
            image: null, ingredients: finalIngs, steps: stepRaw.filter(x=>x.trim())
        };
        
        await api.save('recipes', newR);
        hide('scan-modal');
        toast('å·²åŒ¯å…¥');
        editRecipeId = newR.id;
        app.navTo('edit');
    }
};

document.addEventListener('DOMContentLoaded', app.init);
</script>
</body>
</html>
